# üìã –ó–ê–î–ê–ß–ò: Integration-Attachment-Analyzer-001

**–¶–µ–ª—å:** –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä –≤–ª–æ–∂–µ–Ω–∏–π –≤ –æ—Å–Ω–æ–≤–Ω–æ–π –±–æ—Ç –Ω–µ–π—Ä–æ—Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –≤–ª–æ–∂–µ–Ω–∏–π –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏

**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** Level 3 (–°—Ä–µ–¥–Ω—è—è —Ñ—É–Ω–∫—Ü–∏—è)
**–†–µ–∂–∏–º:** PLAN (–î–µ—Ç–∞–ª—å–Ω–æ–µ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ)

## üéØ –û–±—â–∏–π –ø–ª–∞–Ω –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

### –≠—Ç–∞–ø 1: –ê–Ω–∞–ª–∏–∑ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã –∏ —Ç–æ—á–µ–∫ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
1. ‚úÖ –ò–∑—É—á–∏—Ç—å —Ç–µ–∫—É—â—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É main.py
2. ‚úÖ –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç–æ—á–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤—Ö–æ–¥—è—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
3. ‚úÖ –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ë–î (—Ç–∞–±–ª–∏—Ü–∞ dialogues)
4. ‚úÖ –ü–æ–Ω—è—Ç—å –ª–æ–≥–∏–∫—É –±—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π (60 —Å–µ–∫ —Ç–∞–π–º–µ—Ä)

### –≠—Ç–∞–ø 2: –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
5. ‚úÖ –°–æ–∑–¥–∞—Ç—å –¥–µ—Ç–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
6. ‚úÖ –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞)
7. ‚úÖ –°–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏ callback_handler
8. ‚úÖ –ü—Ä–æ–¥—É–º–∞—Ç—å –ª–æ–≥–∏–∫—É –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ + –∞–Ω–∞–ª–∏–∑ –≤–ª–æ–∂–µ–Ω–∏–π
9. ‚úÖ –ü—Ä–æ—Ä–∞–±–æ—Ç–∞—Ç—å —Å—Ç—Ä–∞—Ç–µ–≥–∏—é –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ –∫–æ–¥–∞ (—Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –ø–æ–¥—Ö–æ–¥—ã)
10. ‚úÖ –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Å—Ç—Ä–∞—Ç–µ–≥–∏—é —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞ Railway

### –≠—Ç–∞–ø 3: –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
11. ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å AttachmentAnalyzer –≤ main.py
12. ‚úÖ –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å callback_handler –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤–ª–æ–∂–µ–Ω–∏–π
13. ‚úÖ –û–±–Ω–æ–≤–∏—Ç—å handle_new_message –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –≤–ª–æ–∂–µ–Ω–∏–π
14. ‚úÖ –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å generate_and_send_response –¥–ª—è –æ–∂–∏–¥–∞–Ω–∏—è –∏ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è –∞–Ω–∞–ª–∏–∑–∞

### –≠—Ç–∞–ø 4: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ—Ç–ª–∞–¥–∫–∞
15. ‚è≥ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ Railway —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –≤–ª–æ–∂–µ–Ω–∏—è–º–∏
16. ‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –ë–î
17. ‚è≥ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –∫–ª–∏–µ–Ω—Ç–∞–º–∏
18. ‚è≥ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

---

## üìù –î–µ—Ç–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

### üîç –ê–ù–ê–õ–ò–ó –¢–ï–ö–£–©–ï–ô –ê–†–•–ò–¢–ï–ö–¢–£–†–´

#### –ö–ª—é—á–µ–≤—ã–µ —Ç–æ—á–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π:
1. **`callback_handler()`** - —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –¥–ª—è –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π VK
   - –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç `attachments` –≤ `actual_message_payload`
   - –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä "[–í–ª–æ–∂–µ–Ω–∏–µ –±–µ–∑ —Ç–µ–∫—Å—Ç–∞]"
   - **–¢–û–ß–ö–ê –ò–ù–¢–ï–ì–†–ê–¶–ò–ò #1:** –ó–¥–µ—Å—å –Ω—É–∂–Ω–æ –ó–ê–ü–£–°–¢–ò–¢–¨ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –≤–ª–æ–∂–µ–Ω–∏–π

2. **`handle_new_message()`** - –±—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏—è –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
   - –î–æ–±–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –≤ `user_buffers`
   - –ó–∞–ø—É—Å–∫–∞–µ—Ç —Ç–∞–π–º–µ—Ä –Ω–∞ 60 —Å–µ–∫—É–Ω–¥
   - **–¢–û–ß–ö–ê –ò–ù–¢–ï–ì–†–ê–¶–ò–ò #2:** –¢–∞–π–º–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –∞–Ω–∞–ª–∏–∑–∞

3. **`generate_and_send_response()`** - —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ –ø–æ—Å–ª–µ —Ç–∞–π–º–µ—Ä–∞
   - –û–±—ä–µ–¥–∏–Ω—è–µ—Ç –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ –±—É—Ñ–µ—Ä–∞
   - –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ –ë–î —á–µ—Ä–µ–∑ `store_dialog_in_db`
   - **–¢–û–ß–ö–ê –ò–ù–¢–ï–ì–†–ê–¶–ò–ò #3:** –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∞–Ω–∞–ª–∏–∑–∞ + –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ

#### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ë–î (—Ç–∞–±–ª–∏—Ü–∞ dialogues):
- `conv_id` - ID –¥–∏–∞–ª–æ–≥–∞
- `role` - "user" –∏–ª–∏ "bot"
- `message` - —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è —Å timestamp (–°–Æ–î–ê –ø–æ–ø–∞–¥–∞–µ—Ç —Ç–µ–∫—Å—Ç+–∞–Ω–∞–ª–∏–∑)
- `client_info` - –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
- `created_at` - –≤—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è

### üèóÔ∏è –ê–†–•–ò–¢–ï–ö–¢–£–†–ù–´–ï –†–ï–®–ï–ù–ò–Ø

#### 1. –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤–ª–æ–∂–µ–Ω–∏–π
```mermaid
graph TD
    A[–í—Ö–æ–¥—è—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ] --> B{–ï—Å—Ç—å –≤–ª–æ–∂–µ–Ω–∏—è?}
    B -->|–ù–µ—Ç| C[–û–±—ã—á–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞, –∫–∞–∫ –±—ã–ª–æ –¥–æ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è]
    B -->|–î–∞| D[–ù–ï–ú–ï–î–õ–ï–ù–ù–û –∑–∞–ø—É—Å—Ç–∏—Ç—å –∞–Ω–∞–ª–∏–∑ –≤–ª–æ–∂–µ–Ω–∏–π –≤ —Ñ–æ–Ω–µ]
    D --> E[–î–æ–±–∞–≤–∏—Ç—å —Ç–µ–∫—Å—Ç –≤ –±—É—Ñ–µ—Ä –ë–ï–ó –æ–∂–∏–¥–∞–Ω–∏—è]
    E --> F[–¢–∞–π–º–µ—Ä 60 —Å–µ–∫ –∏–¥–µ—Ç –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ]
    F --> G[–¢–∞–π–º–µ—Ä –∏—Å—Ç–µ–∫]
    G --> H{–ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω?}
    H -->|–ù–µ—Ç| I[–û–∂–∏–¥–∞—Ç—å –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∞–Ω–∞–ª–∏–∑–∞]
    H -->|–î–∞| J[–û–±—ä–µ–¥–∏–Ω–∏—Ç—å —Ç–µ–∫—Å—Ç + –∞–Ω–∞–ª–∏–∑]
    I --> J
    J --> K[–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î + –æ—Ç–ø—Ä–∞–≤–∫–∞ –±–æ—Ç—É]
```

#### 2. –ú–µ—Å—Ç–æ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ AttachmentAnalyzer
- **–ò–º–ø–æ—Ä—Ç:** –í –Ω–∞—á–∞–ª–µ main.py –ø–æ—Å–ª–µ –¥—Ä—É–≥–∏—Ö –∏–º–ø–æ—Ä—Ç–æ–≤
- **–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è:** –ì–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä –¥–ª—è –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
- **–í—ã–∑–æ–≤:** –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –≤ callback_handler –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ attachments
- **–•—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤:** –ì–ª–æ–±–∞–ª—å–Ω—ã–π —Å–ª–æ–≤–∞—Ä—å `attachment_analysis_results`

#### 3. –ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è –±—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏–∏ (–ò–°–ü–†–ê–í–õ–ï–ù–û)
- **–°—Ç–∞—Ä–∞—è –ª–æ–≥–∏–∫–∞:** –¢–µ–∫—Å—Ç ‚Üí –±—É—Ñ–µ—Ä ‚Üí —Ç–∞–π–º–µ—Ä 60 —Å–µ–∫ ‚Üí –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ ‚Üí –ë–î
- **–ù–æ–≤–∞—è –ª–æ–≥–∏–∫–∞:** 
  1. –¢–µ–∫—Å—Ç ‚Üí –±—É—Ñ–µ—Ä (–Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ)
  2. –ê–Ω–∞–ª–∏–∑ –≤–ª–æ–∂–µ–Ω–∏–π ‚Üí —Ñ–æ–Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞ (–ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ)
  3. –¢–∞–π–º–µ—Ä 60 —Å–µ–∫ ‚Üí –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ
  4. –¢–∞–π–º–µ—Ä –∏—Å—Ç–µ–∫ ‚Üí –æ–∂–∏–¥–∞–Ω–∏–µ –∞–Ω–∞–ª–∏–∑–∞ (–µ—Å–ª–∏ –Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω) ‚Üí –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ ‚Üí –ë–î

### üìã –¢–†–ï–ë–û–í–ê–ù–ò–Ø –ö –†–ï–ê–õ–ò–ó–ê–¶–ò–ò

#### –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è:
1. **–ê–Ω–∞–ª–∏–∑ –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –≤–ª–æ–∂–µ–Ω–∏–π:** —Ñ–æ—Ç–æ, –≤–∏–¥–µ–æ, –≥–æ–ª–æ—Å–æ–≤—ã–µ, —Ä–µ–ø–æ—Å—Ç—ã, –º—É–∑—ã–∫–∞
2. **–û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ —Å —Ç–µ–∫—Å—Ç–æ–º:** –∞–Ω–∞–ª–∏–∑ –¥–æ–ª–∂–µ–Ω –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –∫ —Ç–µ–∫—Å—Ç—É —Å–æ–æ–±—â–µ–Ω–∏—è
3. **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î:** –∏—Ç–æ–≥–æ–≤—ã–π —Ç–µ–∫—Å—Ç+–∞–Ω–∞–ª–∏–∑ –≤ –ø–æ–ª–µ message —Ç–∞–±–ª–∏—Ü—ã dialogues
4. **–ë—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏—è:** –∞–Ω–∞–ª–∏–∑ –¥–æ–ª–∂–µ–Ω —Ä–∞–±–æ—Ç–∞—Ç—å —Å —Å–∏—Å—Ç–µ–º–æ–π –±—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
5. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:** –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –¥—Ä—É–≥–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
6. **–ö–õ–Æ–ß–ï–í–û–ï:** –û–±—ä–µ–¥–∏–Ω–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (—Ç–µ–∫—Å—Ç+–∞–Ω–∞–ª–∏–∑) –ø–æ–¥–∞–µ—Ç—Å—è –±–æ—Ç—É –ö–ê–ö –ò –†–ê–ù–¨–®–ï –∫–∞–∫ "–ø–æ—Å–ª–µ–¥–Ω–∏–π –∑–∞–ø—Ä–æ—Å –∫–ª–∏–µ–Ω—Ç–∞"

#### –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è:
1. **–û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å:** –Ω–µ –ª–æ–º–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –ª–æ–≥–∏–∫—É
2. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫:** graceful degradation –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö —Å –∞–Ω–∞–ª–∏–∑–æ–º
3. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:** –ø–æ–¥—Ä–æ–±–Ω—ã–µ –ª–æ–≥–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞ –∞–Ω–∞–ª–∏–∑–∞
4. **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä—É–µ–º–æ—Å—Ç—å:** –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ—Ç–∫–ª—é—á–∏—Ç—å –∞–Ω–∞–ª–∏–∑ —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
5. **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å:** –∞–Ω–∞–ª–∏–∑ –≤ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –ø–æ—Ç–æ–∫–∞—Ö, –Ω–µ–±–ª–æ–∫–∏—Ä—É—é—â–∏–π
6. **–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∫–æ–¥:** —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –ø–æ–¥—Ö–æ–¥—ã, –∫—Ä–∞—Ç–∫–∏–µ –º–µ—Ç–æ–¥—ã

### üîß –î–ï–¢–ê–õ–¨–ù–´–ô –ü–õ–ê–ù –ú–û–î–ò–§–ò–ö–ê–¶–ò–ô (–ú–ò–ù–ò–ú–ê–õ–¨–ù–´–ô –ö–û–î)

#### 1. –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ (–¥–æ–±–∞–≤–∏—Ç—å)
```python
# –ì–ª–æ–±–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä –≤–ª–æ–∂–µ–Ω–∏–π
attachment_analyzer = None
# –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞ –≤–ª–æ–∂–µ–Ω–∏–π {conv_id: {message_id: analysis_result}}
attachment_analysis_results = {}
# –ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏ –∞–Ω–∞–ª–∏–∑–∞ {conv_id: {message_id: future}}
active_analysis_tasks = {}
```

#### 2. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä–∞ (1 —Å—Ç—Ä–æ–∫–∞)
```python
# –í –Ω–∞—á–∞–ª–µ main.py –ø–æ—Å–ª–µ –∏–º–ø–æ—Ä—Ç–æ–≤
from attachment_analyzer import AttachmentAnalyzer
attachment_analyzer = AttachmentAnalyzer()
```

#### 3. –ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è callback_handler() (5-10 —Å—Ç—Ä–æ–∫)
```python
# –î–û–ë–ê–í–ò–¢–¨ –ø–æ—Å–ª–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è message_text:
attachments = actual_message_payload.get("attachments", [])
message_id = actual_message_payload.get("id")  # –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID —Å–æ–æ–±—â–µ–Ω–∏—è
if attachments and attachment_analyzer:
    start_attachment_analysis_async(attachments, conversation_id_for_handler, message_id)
```

#### 4. –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è start_attachment_analysis_async() (10-15 —Å—Ç—Ä–æ–∫)
```python
def start_attachment_analysis_async(attachments, conv_id, message_id):
    """–ó–∞–ø—É—Å–∫–∞–µ—Ç –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –≤–ª–æ–∂–µ–Ω–∏–π"""
    def analyze():
        try:
            analysis = analyze_attachments_from_vk(attachments)
            attachment_analysis_results.setdefault(conv_id, {})[message_id] = analysis
            logging.info(f"–ê–Ω–∞–ª–∏–∑ –≤–ª–æ–∂–µ–Ω–∏–π –∑–∞–≤–µ—Ä—à–µ–Ω –¥–ª—è conv_id {conv_id}, message_id {message_id}")
        except Exception as e:
            logging.error(f"–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ –≤–ª–æ–∂–µ–Ω–∏–π –¥–ª—è conv_id {conv_id}: {e}")
            attachment_analysis_results.setdefault(conv_id, {})[message_id] = None
    
    # –ó–∞–ø—É—Å–∫ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ
    future = context_executor.submit(analyze)
    active_analysis_tasks.setdefault(conv_id, {})[message_id] = future
```

#### 5. –§—É–Ω–∫—Ü–∏—è analyze_attachments_from_vk() (15-20 —Å—Ç—Ä–æ–∫)
```python
def analyze_attachments_from_vk(attachments):
    """–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –≤–ª–æ–∂–µ–Ω–∏—è –∏–∑ VK –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—Å—Ç–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑"""
    results = []
    for attachment in attachments:
        try:
            # –°–æ–∑–¥–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ –∏ –∞–Ω–∞–ª–∏–∑ —á–µ—Ä–µ–∑ attachment_analyzer
            analysis = process_single_attachment(attachment)
            if analysis:
                results.append(analysis)
        except Exception as e:
            logging.error(f"–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ –≤–ª–æ–∂–µ–Ω–∏—è {attachment}: {e}")
    
    return "\n\n".join(results) if results else None
```

#### 6. –ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è generate_and_send_response() (10-15 —Å—Ç—Ä–æ–∫)
```python
# –î–û–ë–ê–í–ò–¢–¨ –ø–µ—Ä–µ–¥ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ–º —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ –±—É—Ñ–µ—Ä–∞:
# –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∞–Ω–∞–ª–∏–∑–∞ –≤–ª–æ–∂–µ–Ω–∏–π
attachment_analysis = wait_for_attachment_analysis(conv_id_to_respond)

# –ú–û–î–ò–§–ò–¶–ò–†–û–í–ê–¢–¨ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π:
if attachment_analysis:
    combined_user_text = f"{combined_user_text}\n\n[–ê–ù–ê–õ–ò–ó –í–õ–û–ñ–ï–ù–ò–ô]\n{attachment_analysis}"
```

#### 7. –§—É–Ω–∫—Ü–∏—è wait_for_attachment_analysis() (10-15 —Å—Ç—Ä–æ–∫)
```python
def wait_for_attachment_analysis(conv_id, timeout=30):
    """–û–∂–∏–¥–∞–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∞–Ω–∞–ª–∏–∑–∞ –≤–ª–æ–∂–µ–Ω–∏–π —Å —Ç–∞–π–º–∞—É—Ç–æ–º"""
    if conv_id not in active_analysis_tasks:
        return get_completed_analysis(conv_id)
    
    # –û–∂–∏–¥–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞—á
    for message_id, future in active_analysis_tasks[conv_id].items():
        try:
            future.result(timeout=timeout)
        except Exception as e:
            logging.error(f"–¢–∞–π–º–∞—É—Ç –∞–Ω–∞–ª–∏–∑–∞ –≤–ª–æ–∂–µ–Ω–∏–π –¥–ª—è conv_id {conv_id}: {e}")
    
    return get_completed_analysis(conv_id)
```

### ‚ö†Ô∏è –ü–û–¢–ï–ù–¶–ò–ê–õ–¨–ù–´–ï –í–´–ó–û–í–´

#### 1. –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∞–Ω–∞–ª–∏–∑–∞ (–†–ï–®–ï–ù–û)
**–ü—Ä–æ–±–ª–µ–º–∞:** –ê–Ω–∞–ª–∏–∑ –≤–ª–æ–∂–µ–Ω–∏–π –º–æ–∂–µ—Ç –∑–∞–Ω–∏–º–∞—Ç—å 10-30 —Å–µ–∫—É–Ω–¥
**–†–µ—à–µ–Ω–∏–µ:** 
- ‚úÖ –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ —á–µ—Ä–µ–∑ ThreadPoolExecutor
- ‚úÖ –¢–∞–π–º–µ—Ä –±—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ
- ‚úÖ –û–∂–∏–¥–∞–Ω–∏–µ –∞–Ω–∞–ª–∏–∑–∞ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –∏—Å—Ç–µ—á–µ–Ω–∏–∏ —Ç–∞–π–º–µ—Ä–∞

#### 2. –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ (–†–ï–®–ï–ù–û)
**–ü—Ä–æ–±–ª–µ–º–∞:** –ó–∞–¥–µ—Ä–∂–∫–∏ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Å—Ä–∞–∑—É –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç —Ä–∞–∑–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
**–†–µ—à–µ–Ω–∏–µ:**
- ‚úÖ –ö–∞–∂–¥—ã–π –∞–Ω–∞–ª–∏–∑ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ
- ‚úÖ ThreadPoolExecutor —Å max_workers=10 —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
- ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ö—Ä–∞–Ω—è—Ç—Å—è –ø–æ conv_id + message_id

#### 3. –†–∞–∑–º–µ—Ä –∫–æ–¥–∞ (–†–ï–®–ï–ù–û)
**–ü—Ä–æ–±–ª–µ–º–∞:** –†–∞–∑–¥—É–≤–∞–Ω–∏–µ –∫–æ–¥–∞ –±–æ—Ç–∞
**–†–µ—à–µ–Ω–∏–µ:**
- ‚úÖ –í—Å–µ–≥–æ ~60-80 —Å—Ç—Ä–æ–∫ –Ω–æ–≤–æ–≥–æ –∫–æ–¥–∞
- ‚úÖ 7 –∫–æ–º–ø–∞–∫—Ç–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π
- ‚úÖ –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ ThreadPoolExecutor
- ‚úÖ –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ñ—É–Ω–∫—Ü–∏—è—Ö

#### 4. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ Railway (–†–ï–®–ï–ù–û)
**–ü—Ä–æ–±–ª–µ–º–∞:** –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ
**–†–µ—à–µ–Ω–∏–µ:**
- ‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞–ø—Ä—è–º—É—é –Ω–∞ Railway —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –≤–ª–æ–∂–µ–Ω–∏—è–º–∏
- ‚úÖ –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ —Å —Ñ–ª–∞–≥–∞–º–∏ –≤–∫–ª—é—á–µ–Ω–∏—è/–æ—Ç–∫–ª—é—á–µ–Ω–∏—è
- ‚úÖ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ª–æ–≥–æ–≤ Railway –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
- ‚úÖ Rollback –ø–ª–∞–Ω –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö

### üß™ –°–¢–†–ê–¢–ï–ì–ò–Ø –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø –ù–ê RAILWAY

#### 1. –ü–æ—ç—Ç–∞–ø–Ω–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ
- **–≠—Ç–∞–ø 1:** –î–æ–±–∞–≤–∏—Ç—å –∫–æ–¥ —Å —Ñ–ª–∞–≥–æ–º –æ—Ç–∫–ª—é—á–µ–Ω–∏—è (ENABLE_ATTACHMENT_ANALYSIS=false)
- **–≠—Ç–∞–ø 2:** –í–∫–ª—é—á–∏—Ç—å –¥–ª—è —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- **–≠—Ç–∞–ø 3:** –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å —Ä–∞–∑–ª–∏—á–Ω—ã–º–∏ —Ç–∏–ø–∞–º–∏ –≤–ª–æ–∂–µ–Ω–∏–π
- **–≠—Ç–∞–ø 4:** –ü–æ–ª–Ω–æ–µ –≤–∫–ª—é—á–µ–Ω–∏–µ

#### 2. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
- –õ–æ–≥–∏ Railway –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∞–Ω–∞–ª–∏–∑–∞
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ë–î –Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ 