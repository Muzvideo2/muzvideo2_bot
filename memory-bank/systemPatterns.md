# –ö–ª—é—á–µ–≤—ã–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –ø—Ä–æ–µ–∫—Ç–∞ "–ù–µ–π—Ä–æ—Å–æ—Ç—Ä—É–¥–Ω–∏–∫"

–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç –æ–ø–∏—Å—ã–≤–∞–µ—Ç –æ—Å–Ω–æ–≤–Ω—ã–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è –∏ –ø–∞—Ç—Ç–µ—Ä–Ω—ã, –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –≤ –ø—Ä–æ–µ–∫—Ç–µ.

## 1. –ú–æ–Ω–æ–ª–∏—Ç–Ω–æ–µ —è–¥—Ä–æ —Å —Ñ–æ–Ω–æ–≤—ã–º–∏ —Å–µ—Ä–≤–∏—Å–∞–º–∏ (Monolithic Core with Background Services)

–ü—Ä–æ–µ–∫—Ç –ø–æ—Å—Ç—Ä–æ–µ–Ω –≤–æ–∫—Ä—É–≥ —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–≥–æ –º–æ–Ω–æ–ª–∏—Ç–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è `main.py`, –∫–æ—Ç–æ—Ä–æ–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—Å–µ –≤—Ö–æ–¥—è—â–∏–µ –∑–∞–ø—Ä–æ—Å—ã –∏ –æ—Å–Ω–æ–≤–Ω—É—é –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É. –û–¥–Ω–∞–∫–æ –¥–ª—è —Ä–µ—Å—É—Ä—Å–æ–µ–º–∫–∏—Ö –∏ –¥–ª–∏—Ç–µ–ª—å–Ω—ã—Ö –∑–∞–¥–∞—á, —Ç–∞–∫–∏—Ö –∫–∞–∫ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∞–º–º–∞—Ä–∏ –∏ —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π, –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω—ã–µ, –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã (`summary_updater.py`, `reminder_service.py`).

-   **`main.py`**: –í—ã—Å—Ç—É–ø–∞–µ—Ç –≤ —Ä–æ–ª–∏ API-—à–ª—é–∑–∞ (–ø—Ä–∏–Ω–∏–º–∞–µ—Ç –≤–µ–±-—Ö—É–∫–∏ –æ—Ç VK), –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä–∞ (–≤—ã–∑—ã–≤–∞–µ—Ç –¥—Ä—É–≥–∏–µ —Å–µ—Ä–≤–∏—Å—ã) –∏ —è–¥—Ä–∞ –ò–ò-–ª–æ–≥–∏–∫–∏.
-   **–§–æ–Ω–æ–≤—ã–µ —Å–µ—Ä–≤–∏—Å—ã**: –í—ã–∑—ã–≤–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ `subprocess` –∏–ª–∏ —á–µ—Ä–µ–∑ API (`/activate_reminder`). –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫—É –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø–æ—Ç–æ–∫–∞ –∏ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –≤—ã—Å–æ–∫—É—é –æ—Ç–∑—ã–≤—á–∏–≤–æ—Å—Ç—å –±–æ—Ç–∞ –¥–ª—è –∫–æ–Ω–µ—á–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞**:
-   –°–æ—á–µ—Ç–∞–Ω–∏–µ –ø—Ä–æ—Å—Ç–æ—Ç—ã –º–æ–Ω–æ–ª–∏—Ç–∞ –¥–ª—è –æ—Å–Ω–æ–≤–Ω–æ–π –ª–æ–≥–∏–∫–∏.
-   –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å –∏ –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å –∑–∞ —Å—á–µ—Ç –≤—ã–Ω–æ—Å–∞ —Ç—è–∂–µ–ª—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã.

## 2. –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤–Ω—É—Ç—Ä–∏ –º–æ–Ω–æ–ª–∏—Ç–∞ (Asynchronous Processing within the Monolith)

–î–ª—è —Ä–µ—à–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º—ã —Å –¥–ª–∏—Ç–µ–ª—å–Ω–æ–π —Å–±–æ—Ä–∫–æ–π –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –¥–ª—è –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –±—ã–ª –≤–Ω–µ–¥—Ä–µ–Ω –ø–∞—Ç—Ç–µ—Ä–Ω –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º `ThreadPoolExecutor` –Ω–µ–ø–æ—Å—Ä–µ–¥—Å—Ç–≤–µ–Ω–Ω–æ –≤ `main.py`.

-   –ö–æ–≥–¥–∞ –ø—Ä–∏—Ö–æ–¥–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –¥–ª—è –∫–æ—Ç–æ—Ä–æ–≥–æ –Ω—É–∂–Ω–æ —Å–æ–±—Ä–∞—Ç—å –ø–æ–ª–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç, —ç—Ç–∞ –∑–∞–¥–∞—á–∞ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ.
-   –û—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ—Ü–µ—Å—Å –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è –∏ –º–æ–∂–µ—Ç –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å –ø—Ä–∏–Ω–∏–º–∞—Ç—å –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –¥—Ä—É–≥–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞**:
-   –ó–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ–µ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ –ø—Ä–æ–ø—É—Å–∫–Ω–æ–π —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ (—á—Ç–æ –±—ã–ª–æ –¥–æ–∫–∞–∑–∞–Ω–æ —Ç–µ—Å—Ç–∞–º–∏ –≤ `performance_test.py`, –∫–æ—Ç–æ—Ä—ã–π —Å–µ–π—á–∞—Å —É–¥–∞–ª–µ–Ω).
-   –£–ª—É—á—à–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –æ–ø—ã—Ç–∞ (–±–æ—Ç –Ω–µ "–∑–∞–≤–∏—Å–∞–µ—Ç" –Ω–∞–¥–æ–ª–≥–æ).

## 3. –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º —á–µ—Ä–µ–∑ –ø—Ä–æ–º–ø—Ç (Prompt-Driven State Management)

–í–º–µ—Å—Ç–æ —Å–ª–æ–∂–Ω–æ–π –º–∞—à–∏–Ω—ã —Å–æ—Å—Ç–æ—è–Ω–∏–π (State Machine) –∏–ª–∏ —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö, –ø–æ–≤–µ–¥–µ–Ω–∏–µ –ò–ò –≤ –æ—Å–Ω–æ–≤–Ω–æ–º —É–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ –¥–µ—Ç–∞–ª—å–Ω–æ –ø—Ä–æ—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π `prompt.txt`.

-   **`prompt.txt`**: –°–æ–¥–µ—Ä–∂–∏—Ç –Ω–µ —Ç–æ–ª—å–∫–æ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏, –Ω–æ –∏ –ª–∏—á–Ω–æ—Å—Ç—å, –ø—Ä–∞–≤–∏–ª–∞ –ø–æ–≤–µ–¥–µ–Ω–∏—è, —Å—Ü–µ–Ω–∞—Ä–∏–∏ –∏ –¥–∞–∂–µ "–≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –º–æ–Ω–æ–ª–æ–≥" (`<internal_analysis>`), –∫–æ—Ç–æ—Ä—ã–π –ò–ò –¥–æ–ª–∂–µ–Ω –ø—Ä–æ–≤–æ–¥–∏—Ç—å.
-   **`knowledge_base.json`**: –î–æ–ø–æ–ª–Ω—è–µ—Ç –ø—Ä–æ–º–ø—Ç —Å—Ç–∞—Ç–∏—á–µ—Å–∫–æ–π –±–∞–∑–æ–π –∑–Ω–∞–Ω–∏–π.

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞**:
-   **–ì–∏–±–∫–æ—Å—Ç—å**: –ü–æ–≤–µ–¥–µ–Ω–∏–µ –ò–ò –º–æ–∂–Ω–æ –∫–∞—Ä–¥–∏–Ω–∞–ª—å–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å, –ø—Ä–æ—Å—Ç–æ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–≤ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Ñ–∞–π–ª—ã, –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–¥–∞.
-   **–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å**: –í—Å—è –ª–æ–≥–∏–∫–∞ –ø—Ä–∏–Ω—è—Ç–∏—è —Ä–µ—à–µ–Ω–∏–π –ò–ò –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ –∏ –ª–µ–≥–∫–æ —á–∏—Ç–∞–µ–º–∞.

## 4. –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è —Å–±–æ—Ä–∫–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∏–∑ –°–£–ë–î (Dynamic Context Aggregation from RDBMS)

–°–∏—Å—Ç–µ–º–∞ –Ω–µ —Ö—Ä–∞–Ω–∏—Ç –≥–æ—Ç–æ–≤—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç, –∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ —Å–æ–±–∏—Ä–∞–µ—Ç –µ–≥–æ "–Ω–∞ –ª–µ—Ç—É" –∏–∑ —Ä–µ–ª—è—Ü–∏–æ–Ω–Ω–æ–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö PostgreSQL.

-   –ú–æ–¥—É–ª—å —Å–±–æ—Ä–∫–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ (–∏–∑–Ω–∞—á–∞–ª—å–Ω–æ –Ω–∞—Ö–æ–¥–∏–≤—à–∏–π—Å—è –≤ `context_builder.py`, —Ç–µ–ø–µ—Ä—å —è–≤–ª—è–µ—Ç—Å—è —á–∞—Å—Ç—å—é `main.py`) –∏—â–µ—Ç –≤ —Å—Ö–µ–º–µ –ë–î –≤—Å–µ —Ç–∞–±–ª–∏—Ü—ã, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å `conv_id` –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
-   –û–Ω –∏–∑–≤–ª–µ–∫–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ —ç—Ç–∏—Ö —Ç–∞–±–ª–∏—Ü –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –∏—Ö –≤ –µ–¥–∏–Ω—ã–π —Ç–µ–∫—Å—Ç–æ–≤—ã–π –±–ª–æ–∫ –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –≤ –ø—Ä–æ–º–ø—Ç.

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞**:
-   **–†–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å**: –ß—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π —Ç–∏–ø –¥–∞–Ω–Ω—ã—Ö –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç, –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é —Ç–∞–±–ª–∏—Ü—É –≤ –ë–î —Å –∫–æ–ª–æ–Ω–∫–æ–π `conv_id`. –ö–æ–¥ —Å–±–æ—Ä—â–∏–∫–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∏–∑–º–µ–Ω—è—Ç—å –Ω–µ –Ω—É–∂–Ω–æ.
-   **–ê–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å**: –ö–æ–Ω—Ç–µ–∫—Å—Ç –≤—Å–µ–≥–¥–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç —Å–∞–º—ã–µ —Å–≤–µ–∂–∏–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –±–∞–∑—ã.

## 5. –ö–∞—Ä—Ç–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –∏ –ø–æ—Ç–æ–∫–æ–≤ –¥–∞–Ω–Ω—ã—Ö

```mermaid
graph TD
    subgraph "–í–Ω–µ—à–Ω–∏–π –º–∏—Ä"
        direction LR
        User[üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å VK]
        VK_API[üåê VK Callback API]
    end

    subgraph "–Ø–¥—Ä–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (main.py)"
        direction LR
        A[Flask App<br>@/callback]
        B[–û—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä<br>handle_new_message]
        C[–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π<br>–°–±–æ—Ä—â–∏–∫ –ö–æ–Ω—Ç–µ–∫—Å—Ç–∞<br>(ThreadPoolExecutor)]
        D[–õ–æ–≥–∏–∫–∞ –ò–ò<br>generate_response]
        E[API –¥–ª—è —Å–µ—Ä–≤–∏—Å–æ–≤<br>@/activate_reminder]
    end

    subgraph "–ò—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–∞–Ω–Ω—ã—Ö"
        direction TB
        F[–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö<br>(PostgreSQL)]
        G[–ü—Ä–æ–º–ø—Ç<br>(prompt.txt)]
        H[–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π<br>(knowledge_base.json)]
    end

    subgraph "–§–æ–Ω–æ–≤—ã–µ —Å–µ—Ä–≤–∏—Å—ã"
        direction TB
        I[–°–µ—Ä–≤–∏—Å –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π<br>(reminder_service.py)]
        J[–°–µ—Ä–≤–∏—Å –û–±–Ω–æ–≤–ª–µ–Ω–∏—è<br>–°–∞–º–º–∞—Ä–∏<br>(summary_updater.py)]
    end

    %% –°–≤—è–∑–∏
    User -- "–ø–∏—à–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ" --> VK_API
    VK_API -- "POST-–∑–∞–ø—Ä–æ—Å" --> A

    A -- "–Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ" --> B
    B -- "–∑–∞–ø—É—Å–∫–∞–µ—Ç —Å–±–æ—Ä–∫—É" --> C
    B -- "—Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –¥–∏–∞–ª–æ–≥" --> F
    B -- "–≤—ã–∑—ã–≤–∞–µ—Ç –ò–ò" --> D
    B -- "–∑–∞–ø—É—Å–∫–∞–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ" --> J
    B -- "–ø–µ—Ä–µ–¥–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ" --> I

    C -- "—á–∏—Ç–∞–µ—Ç –≤—Å–µ –¥–∞–Ω–Ω—ã–µ" --> F
    C -- "–≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç" --> D

    D -- "—á–∏—Ç–∞–µ—Ç –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏" --> G
    D -- "—á–∏—Ç–∞–µ—Ç —Ñ–∞–∫—Ç—ã" --> H
    D -- "–∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç" --> C
    D -- "–æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –æ—Ç–≤–µ—Ç" --> VK_API

    I -- "—á–∏—Ç–∞–µ—Ç –¥–∏–∞–ª–æ–≥–∏" --> F
    I -- "—Å—Ç–∞–≤–∏—Ç/–ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∑–∞–¥–∞—á–∏" --> F
    I -- "–∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ" --> E
    E -- "–æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ" --> VK_API

    J -- "—á–∏—Ç–∞–µ—Ç –¥–∏–∞–ª–æ–≥" --> F
    J -- "–æ–±–Ω–æ–≤–ª—è–µ—Ç —Å–∞–º–º–∞—Ä–∏/–ø—Ä–æ—Ñ–∏–ª—å" --> F

```
