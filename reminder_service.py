#!/usr/bin/env python
# -*- coding: utf-8 -*-
# =======================================================================================
#               –°–ï–†–í–ò–° –ò–ù–¢–ï–ì–†–ò–†–û–í–ê–ù–ù–´–• –ù–ê–ü–û–ú–ò–ù–ê–ù–ò–ô (REMINDER SERVICE) - v1.0
# =======================================================================================
#
# –ß–¢–û –î–ï–õ–ê–ï–¢ –≠–¢–û–¢ –°–ï–†–í–ò–°:
#
# –≠—Ç–æ—Ç —Å–µ—Ä–≤–∏—Å ‚Äî "—É–º–Ω—ã–π –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫", –∫–æ—Ç–æ—Ä—ã–π –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –¥–∏–∞–ª–æ–≥–∏
# –∏ —Å–æ–∑–¥–∞–µ—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ –±—É–¥—É—â–∏—Ö –∫–æ–Ω—Ç–∞–∫—Ç–∞—Ö —Å –∫–ª–∏–µ–Ω—Ç–∞–º–∏.
#
# –ï–ì–û –ó–ê–î–ê–ß–ò:
#
# 1. –ê–ù–ê–õ–ò–ó –î–ò–ê–õ–û–ì–û–í: –°–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –≤—ã—è–≤–ª–µ–Ω–∏—è
#    –¥–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç–µ–π –æ –±—É–¥—É—â–µ–º –∫–æ–Ω—Ç–∞–∫—Ç–µ.
#
# 2. –°–û–ó–î–ê–ù–ò–ï –ù–ê–ü–û–ú–ò–ù–ê–ù–ò–ô: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –Ω–∞ –æ—Å–Ω–æ–≤–µ
#    –≤—ã—è–≤–ª–µ–Ω–Ω—ã—Ö –¥–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç–µ–π —Å —É—á–µ—Ç–æ–º —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å–∞ –∫–ª–∏–µ–Ω—Ç–∞.
#
# 3. –ê–ö–¢–ò–í–ê–¶–ò–Ø –ù–ê–ü–û–ú–ò–ù–ê–ù–ò–ô: –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –∞–∫—Ç–∏–≤–∞—Ü–∏—è –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π —Å –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–π
#    –ø—Ä–æ–≤–µ—Ä–∫–æ–π –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ —á–µ—Ä–µ–∑ AI-–∞–≥–µ–Ω—Ç–∞ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π.
#
# 4. –£–ü–†–ê–í–õ–ï–ù–ò–ï –ù–ê–ü–û–ú–ò–ù–ê–ù–ò–Ø–ú–ò: –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è,
#    –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏ –æ—Ç–º–µ–Ω—ã –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π.
#
# =======================================================================================

import os
import sys
import json
import logging
import re
import psycopg2
import psycopg2.extras
from datetime import datetime, timedelta, timezone
import threading
from apscheduler.schedulers.background import BackgroundScheduler
import pytz
import requests
from itertools import groupby
from operator import itemgetter

try:
    import vertexai
    from vertexai.generative_models import GenerativeModel
    from google.oauth2 import service_account
    VERTEXAI_AVAILABLE = True
except ImportError:
    VERTEXAI_AVAILABLE = False
    print("–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: Vertex AI SDK –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω.", file=sys.stderr)
    sys.exit(1)

# --- –ù–ê–°–¢–†–û–ô–ö–ò ---
DATABASE_URL = os.environ.get("DATABASE_URL")
PROJECT_ID = os.environ.get("GCP_PROJECT_ID", "zeta-tracer-462306-r7")
LOCATION = os.environ.get("GEMINI_LOCATION", "us-central1")
ADMIN_CONV_ID = 78671089  # ID –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞

MODEL_NAME = "gemini-2.5-flash"
API_TIMEOUT = 45

# –ò–Ω—Ç–µ—Ä–≤–∞–ª –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π (–≤ –º–∏–Ω—É—Ç–∞—Ö)
CHECK_INTERVAL_MINUTES = 5

# –£–≤–µ–ª–∏—á–µ–Ω–Ω—ã–π —Ç–∞–π–º–∞—É—Ç –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π
ACTIVATION_TIMEOUT = 120  # 2 –º–∏–Ω—É—Ç—ã

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
LOG_FILE_NAME = "reminder_service.log"

# –°–ª–æ–≤–∞—Ä—å –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å–∞ –ø–æ –≥–æ—Ä–æ–¥—É
CITY_TIMEZONE_MAP = {
    # –†–æ—Å—Å–∏—è
    '–º–æ—Å–∫–≤–∞': 'Europe/Moscow',
    '—Å–∞–Ω–∫—Ç-–ø–µ—Ç–µ—Ä–±—É—Ä–≥': 'Europe/Moscow', 
    '—Å–ø–±': 'Europe/Moscow',
    '–ø–µ—Ç–µ—Ä–±—É—Ä–≥': 'Europe/Moscow',
    '–µ–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥': 'Asia/Yekaterinburg',
    '–Ω–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫': 'Asia/Novosibirsk',
    '–∫—Ä–∞—Å–Ω–æ—è—Ä—Å–∫': 'Asia/Krasnoyarsk',
    '–∏—Ä–∫—É—Ç—Å–∫': 'Asia/Irkutsk',
    '–≤–ª–∞–¥–∏–≤–æ—Å—Ç–æ–∫': 'Asia/Vladivostok',
    '—Ö–∞–±–∞—Ä–æ–≤—Å–∫': 'Asia/Vladivostok',
    '–æ–º—Å–∫': 'Asia/Omsk',
    '—á–µ–ª—è–±–∏–Ω—Å–∫': 'Asia/Yekaterinburg',
    '–∫–∞–∑–∞–Ω—å': 'Europe/Moscow',
    '–Ω–∏–∂–Ω–∏–π –Ω–æ–≤–≥–æ—Ä–æ–¥': 'Europe/Moscow',
    '—Å–∞–º–∞—Ä–∞': 'Europe/Samara',
    '—É—Ñ–∞': 'Asia/Yekaterinburg',
    '—Ä–æ—Å—Ç–æ–≤-–Ω–∞-–¥–æ–Ω—É': 'Europe/Moscow',
    '–∫—Ä–∞—Å–Ω–æ–¥–∞—Ä': 'Europe/Moscow',
    '–ø–µ—Ä–º—å': 'Asia/Yekaterinburg',
    '–≤–æ—Ä–æ–Ω–µ–∂': 'Europe/Moscow',
    '–≤–æ–ª–≥–æ–≥—Ä–∞–¥': 'Europe/Moscow',
    '—Å–∞—Ä–∞—Ç–æ–≤': 'Europe/Moscow',
    '—Ç—é–º–µ–Ω—å': 'Asia/Yekaterinburg',
    '—Ç–æ–ª—å—è—Ç—Ç–∏': 'Europe/Samara',
    '–±–∞—Ä–Ω–∞—É–ª': 'Asia/Barnaul',
    '—É–ª—å—è–Ω–æ–≤—Å–∫': 'Europe/Samara',
    '–∏–≤–∞–Ω–æ–≤–æ': 'Europe/Moscow',
    '—è—Ä–æ—Å–ª–∞–≤–ª—å': 'Europe/Moscow',
    '–º–∞—Ö–∞—á–∫–∞–ª–∞': 'Europe/Moscow',
    '—Ö–∞–±–∞—Ä–æ–≤—Å–∫': 'Asia/Vladivostok',
    '–æ—Ä–µ–Ω–±—É—Ä–≥': 'Asia/Yekaterinburg',
    '–Ω–æ–≤–æ–∫—É–∑–Ω–µ—Ü–∫': 'Asia/Novokuznetsk',
    '—Ä—è–∑–∞–Ω—å': 'Europe/Moscow',
    '—Ç—É–ª–∞': 'Europe/Moscow',
    '–ª–∏–ø–µ—Ü–∫': 'Europe/Moscow',
    '–∫–∏—Ä–æ–≤': 'Europe/Moscow',
    '—á–µ–±–æ–∫—Å–∞—Ä—ã': 'Europe/Moscow',
    '–∫–∞–ª–∏–Ω–∏–Ω–≥—Ä–∞–¥': 'Europe/Kaliningrad',
    '–±—Ä—è–Ω—Å–∫': 'Europe/Moscow',
    '–º–∞–≥–Ω–∏—Ç–æ–≥–æ—Ä—Å–∫': 'Asia/Yekaterinburg',
    '–∫—É—Ä—Å–∫': 'Europe/Moscow',
    '—Ç–≤–µ—Ä—å': 'Europe/Moscow',
    '–∏–≤–∞–Ω–æ–≤–æ': 'Europe/Moscow',
    '–∞—Ä—Ö–∞–Ω–≥–µ–ª—å—Å–∫': 'Europe/Moscow',
    '—Å–æ—á–∏': 'Europe/Moscow',
    '–±–µ–ª–≥–æ—Ä–æ–¥': 'Europe/Moscow',
    '–∫–∞–ª—É–≥–∞': 'Europe/Moscow',
    '–≤–ª–∞–¥–∏–º–∏—Ä': 'Europe/Moscow',
    '—Å—É—Ä–≥—É—Ç': 'Asia/Yekaterinburg',
    '—Å–º–æ–ª–µ–Ω—Å–∫': 'Europe/Moscow',
    '–∫—É—Ä–≥–∞–Ω': 'Asia/Yekaterinburg',
    '–æ—Ä—ë–ª': 'Europe/Moscow',
    '—á–µ—Ä–µ–ø–æ–≤–µ—Ü': 'Europe/Moscow',
    '–≤–æ–ª–æ–≥–¥–∞': 'Europe/Moscow',
    '–º—É—Ä–º–∞–Ω—Å–∫': 'Europe/Moscow',
    '—Ç–∞–º–±–æ–≤': 'Europe/Moscow',
    '—Å—Ç–µ—Ä–ª–∏—Ç–∞–º–∞–∫': 'Asia/Yekaterinburg',
    '–≥—Ä–æ–∑–Ω—ã–π': 'Europe/Moscow',
    '—è–∫—É—Ç—Å–∫': 'Asia/Yakutsk',
    '–∫–æ—Å—Ç—Ä–æ–º–∞': 'Europe/Moscow',
    '–∫–æ–º—Å–æ–º–æ–ª—å—Å–∫-–Ω–∞-–∞–º—É—Ä–µ': 'Asia/Vladivostok',
    '–ø–µ—Ç—Ä–æ–∑–∞–≤–æ–¥—Å–∫': 'Europe/Moscow',
    '—Ç–∞–≥–∞–Ω—Ä–æ–≥': 'Europe/Moscow',
    '–Ω–∏–∂–Ω–µ–≤–∞—Ä—Ç–æ–≤—Å–∫': 'Asia/Yekaterinburg',
    '–π–æ—à–∫–∞—Ä-–æ–ª–∞': 'Europe/Moscow',
    '–±—Ä–∞—Ç—Å–∫': 'Asia/Irkutsk',
    '–Ω–æ–≤–æ—Ä–æ—Å—Å–∏–π—Å–∫': 'Europe/Moscow',
    '–¥–∑–µ—Ä–∂–∏–Ω—Å–∫': 'Europe/Moscow',
    '—à–∞—Ö—Ç—ã': 'Europe/Moscow',
    '–æ—Ä—Å–∫': 'Asia/Yekaterinburg',
    '–∞–Ω–≥–∞—Ä—Å–∫': 'Asia/Irkutsk',
    '—Å—ã–∫—Ç—ã–≤–∫–∞—Ä': 'Europe/Moscow',
    '–Ω–∏–∂–Ω–µ–∫–∞–º—Å–∫': 'Europe/Moscow',
    '—Å—Ç–∞—Ä—ã–π –æ—Å–∫–æ–ª': 'Europe/Moscow',
    '–º—ã—Ç–∏—â–∏': 'Europe/Moscow',
    '–ø—Ä–æ–∫–æ–ø—å–µ–≤—Å–∫': 'Asia/Novokuznetsk',
    '–±–∞–ª–∞—à–∏—Ö–∞': 'Europe/Moscow',
    '—Ä—ã–±–∏–Ω—Å–∫': 'Europe/Moscow',
    '–±–∏–π—Å–∫': 'Asia/Barnaul',
    '–ø–æ–¥–æ–ª—å—Å–∫': 'Europe/Moscow',
    '–∫–æ—Ä–æ–ª—ë–≤': 'Europe/Moscow',
    '—Å—ã–∑—Ä–∞–Ω—å': 'Europe/Samara',
    '–≤–æ–ª–∂—Å–∫–∏–π': 'Europe/Moscow',
    '–∂–µ–ª–µ–∑–Ω–æ–¥–æ—Ä–æ–∂–Ω—ã–π': 'Europe/Moscow',
    '–∞–±–∞–∫–∞–Ω': 'Asia/Krasnoyarsk',
    '—É—Å—Å—É—Ä–∏–π—Å–∫': 'Asia/Vladivostok',
    '–Ω–æ—Ä–∏–ª—å—Å–∫': 'Asia/Krasnoyarsk',
    '–∫–∞–º–µ–Ω—Å–∫-—É—Ä–∞–ª—å—Å–∫–∏–π': 'Asia/Yekaterinburg',
    '–≤–µ–ª–∏–∫–∏–π –Ω–æ–≤–≥–æ—Ä–æ–¥': 'Europe/Moscow',
    '–ª—é–±–µ—Ä—Ü—ã': 'Europe/Moscow',
    '—é–∂–Ω–æ-—Å–∞—Ö–∞–ª–∏–Ω—Å–∫': 'Asia/Sakhalin',
    
    # –£–∫—Ä–∞–∏–Ω–∞
    '–∫–∏–µ–≤': 'Europe/Kiev',
    '—Ö–∞—Ä—å–∫–æ–≤': 'Europe/Kiev',
    '–æ–¥–µ—Å—Å–∞': 'Europe/Kiev',
    '–¥–Ω–µ–ø—Ä–æ–ø–µ—Ç—Ä–æ–≤—Å–∫': 'Europe/Kiev',
    '–¥–æ–Ω–µ—Ü–∫': 'Europe/Kiev',
    '–∑–∞–ø–æ—Ä–æ–∂—å–µ': 'Europe/Kiev',
    '–ª—å–≤–æ–≤': 'Europe/Kiev',
    
    # –ë–µ–ª–∞—Ä—É—Å—å
    '–º–∏–Ω—Å–∫': 'Europe/Minsk',
    '–≥–æ–º–µ–ª—å': 'Europe/Minsk',
    '–º–æ–≥–∏–ª—ë–≤': 'Europe/Minsk',
    '–≤–∏—Ç–µ–±—Å–∫': 'Europe/Minsk',
    '–≥—Ä–æ–¥–Ω–æ': 'Europe/Minsk',
    '–±—Ä–µ—Å—Ç': 'Europe/Minsk',
    
    # –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω
    '–∞–ª–º–∞—Ç—ã': 'Asia/Almaty',
    '–Ω—É—Ä-—Å—É–ª—Ç–∞–Ω': 'Asia/Almaty',
    '–∞—Å—Ç–∞–Ω–∞': 'Asia/Almaty',
    '—à—ã–º–∫–µ–Ω—Ç': 'Asia/Almaty',
    '–∫–∞—Ä–∞–≥–∞–Ω–¥–∞': 'Asia/Almaty',
    '–∞–∫—Ç–æ–±–µ': 'Asia/Aqtobe',
    '—Ç–∞—Ä–∞–∑': 'Asia/Almaty',
    '–ø–∞–≤–ª–æ–¥–∞—Ä': 'Asia/Almaty',
    '—É—Å—Ç—å-–∫–∞–º–µ–Ω–æ–≥–æ—Ä—Å–∫': 'Asia/Almaty',
    '—Å–µ–º–µ–π': 'Asia/Almaty',
    '–∞—Ç—ã—Ä–∞—É': 'Asia/Aqtau',
    '–∫–æ—Å—Ç–∞–Ω–∞–π': 'Asia/Almaty',
    '–∫—ã–∑—ã–ª–æ—Ä–¥–∞': 'Asia/Qyzylorda',
    '—É—Ä–∞–ª—å—Å–∫': 'Asia/Oral',
    '–ø–µ—Ç—Ä–æ–ø–∞–≤–ª–æ–≤—Å–∫': 'Asia/Almaty',
    '–∞–∫—Ç–∞—É': 'Asia/Aqtau',
    
    # –î—Ä—É–≥–∏–µ —Å—Ç—Ä–∞–Ω—ã (–æ—Å–Ω–æ–≤–Ω—ã–µ –≥–æ—Ä–æ–¥–∞)
    '–ª–æ–Ω–¥–æ–Ω': 'Europe/London',
    '–ø–∞—Ä–∏–∂': 'Europe/Paris',
    '–±–µ—Ä–ª–∏–Ω': 'Europe/Berlin',
    '—Ä–∏–º': 'Europe/Rome',
    '–º–∞–¥—Ä–∏–¥': 'Europe/Madrid',
    '–∞–º—Å—Ç–µ—Ä–¥–∞–º': 'Europe/Amsterdam',
    '–±—Ä—é—Å—Å–µ–ª—å': 'Europe/Brussels',
    '–≤–µ–Ω–∞': 'Europe/Vienna',
    '–ø—Ä–∞–≥–∞': 'Europe/Prague',
    '–≤–∞—Ä—à–∞–≤–∞': 'Europe/Warsaw',
    '—Å—Ç–æ–∫–≥–æ–ª—å–º': 'Europe/Stockholm',
    '—Ö–µ–ª—å—Å–∏–Ω–∫–∏': 'Europe/Helsinki',
    '–æ—Å–ª–æ': 'Europe/Oslo',
    '–∫–æ–ø–µ–Ω–≥–∞–≥–µ–Ω': 'Europe/Copenhagen',
    '–¥—É–±–ª–∏–Ω': 'Europe/Dublin',
    '–ª–∏—Å—Å–∞–±–æ–Ω': 'Europe/Lisbon',
    '–∞—Ñ–∏–Ω—ã': 'Europe/Athens',
    '–±—É–¥–∞–ø–µ—à—Ç': 'Europe/Budapest',
    '–±—É—Ö–∞—Ä–µ—Å—Ç': 'Europe/Bucharest',
    '—Å–æ—Ñ–∏—è': 'Europe/Sofia',
    '–±–µ–ª–≥—Ä–∞–¥': 'Europe/Belgrade',
    '–∑–∞–≥—Ä–µ–±': 'Europe/Zagreb',
    '–ª—é–±–ª—è–Ω–∞': 'Europe/Ljubljana',
    '–±—Ä–∞—Ç–∏—Å–ª–∞–≤–∞': 'Europe/Bratislava',
    '—Ç–∞–ª–ª–∏–Ω': 'Europe/Tallinn',
    '—Ä–∏–≥–∞': 'Europe/Riga',
    '–≤–∏–ª—å–Ω—é—Å': 'Europe/Vilnius',
    '–Ω—å—é-–π–æ—Ä–∫': 'America/New_York',
    '–ª–æ—Å-–∞–Ω–¥–∂–µ–ª–µ—Å': 'America/Los_Angeles',
    '—á–∏–∫–∞–≥–æ': 'America/Chicago',
    '—Ö—å—é—Å—Ç–æ–Ω': 'America/Chicago',
    '—Ç–æ—Ä–æ–Ω—Ç–æ': 'America/Toronto',
    '–≤–∞–Ω–∫—É–≤–µ—Ä': 'America/Vancouver',
    '—Ç–æ–∫–∏–æ': 'Asia/Tokyo',
    '–ø–µ–∫–∏–Ω': 'Asia/Shanghai',
    '—à–∞–Ω—Ö–∞–π': 'Asia/Shanghai',
    '—Å–µ—É–ª': 'Asia/Seoul',
    '–±–∞–Ω–≥–∫–æ–∫': 'Asia/Bangkok',
    '—Å–∏–Ω–≥–∞–ø—É—Ä': 'Asia/Singapore',
    '–¥–∂–∞–∫–∞—Ä—Ç–∞': 'Asia/Jakarta',
    '–º—É–º–±–∞–∏': 'Asia/Kolkata',
    '–¥–µ–ª–∏': 'Asia/Kolkata',
    '–¥—É–±–∞–π': 'Asia/Dubai',
    '—Ç–µ–ª—å-–∞–≤–∏–≤': 'Asia/Jerusalem',
    '—Å—Ç–∞–º–±—É–ª': 'Europe/Istanbul',
    '–∫–∞–∏—Ä': 'Africa/Cairo',
    '–π–æ—Ö–∞–Ω–Ω–µ—Å–±—É—Ä–≥': 'Africa/Johannesburg',
    '—Å–∏–¥–Ω–µ–π': 'Australia/Sydney',
    '–º–µ–ª—å–±—É—Ä–Ω': 'Australia/Melbourne',
    '—Å–∞–Ω-–ø–∞—É–ª—É': 'America/Sao_Paulo',
    '—Ä–∏–æ-–¥–µ-–∂–∞–Ω–µ–π—Ä–æ': 'America/Sao_Paulo',
    '–±—É—ç–Ω–æ—Å-–∞–π—Ä–µ—Å': 'America/Argentina/Buenos_Aires',
    '–º–µ—Ö–∏–∫–æ': 'America/Mexico_City',
}

def get_timezone_by_city(city):
    """–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –≥–æ—Ä–æ–¥–∞."""
    if not city:
        return 'Europe/Moscow'  # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –º–æ—Å–∫–æ–≤—Å–∫–æ–µ –≤—Ä–µ–º—è
    
    city_lower = city.lower().strip()
    return CITY_TIMEZONE_MAP.get(city_lower, 'Europe/Moscow')

def detect_timezone_from_message(message_text):
    """–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç, —É–∫–∞–∑–∞–Ω –ª–∏ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å."""
    message_lower = message_text.lower()
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —É–ø–æ–º–∏–Ω–∞–Ω–∏—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —á–∞—Å–æ–≤—ã—Ö –ø–æ—è—Å–æ–≤
    timezone_patterns = [
        (r'–ø–æ\s+–º–æ—Å–∫–≤–µ|–º–æ—Å–∫–æ–≤—Å–∫–æ–µ\s+–≤—Ä–µ–º—è|–º—Å–∫', 'Europe/Moscow'),
        (r'–ø–æ\s+–ø–∏—Ç–µ—Ä—É|–ø–æ\s+—Å–ø–±|–ø–∏—Ç–µ—Ä—Å–∫–æ–µ\s+–≤—Ä–µ–º—è', 'Europe/Moscow'),
        (r'–ø–æ\s+–µ–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥—É|–µ–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥—Å–∫–æ–µ\s+–≤—Ä–µ–º—è', 'Asia/Yekaterinburg'),
        (r'–ø–æ\s+–Ω–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫—É|–Ω–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫–æ–µ\s+–≤—Ä–µ–º—è', 'Asia/Novosibirsk'),
        (r'–ø–æ\s+–≤–ª–∞–¥–∏–≤–æ—Å—Ç–æ–∫—É|–≤–ª–∞–¥–∏–≤–æ—Å—Ç–æ–∫—Å–∫–æ–µ\s+–≤—Ä–µ–º—è', 'Asia/Vladivostok'),
        (r'utc|–≥—Ä–∏–Ω–≤–∏—á', 'UTC'),
        (r'–ø–æ\s+–∫–∏–µ–≤—É|–∫–∏–µ–≤—Å–∫–æ–µ\s+–≤—Ä–µ–º—è', 'Europe/Kiev'),
        (r'–ø–æ\s+–º–∏–Ω—Å–∫—É|–º–∏–Ω—Å–∫–æ–µ\s+–≤—Ä–µ–º—è', 'Europe/Minsk'),
        (r'–ø–æ\s+–∞–ª–º–∞—Ç—ã', 'Asia/Almaty'),
    ]
    
    for pattern, timezone in timezone_patterns:
        if re.search(pattern, message_lower):
            return timezone
    
    return None

# --- –ü–†–û–ú–ü–¢–´ –î–õ–Ø AI ---
PROMPT_ANALYZE_DIALOGUE = """
–¢—ã ‚Äî AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç, –∞–Ω–∞–ª–∏–∑–∏—Ä—É—é—â–∏–π –¥–∏–∞–ª–æ–≥–∏ –æ–Ω–ª–∞–π–Ω-—à–∫–æ–ª—ã –º—É–∑—ã–∫–∏ –¥–ª—è –≤—ã—è–≤–ª–µ–Ω–∏—è –¥–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç–µ–π –æ –±—É–¥—É—â–µ–º –∫–æ–Ω—Ç–∞–∫—Ç–µ.

–¢–í–û–Ø –ó–ê–î–ê–ß–ê: –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–∏–∞–ª–æ–≥–∞ –∏ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å, –µ—Å—Ç—å –ª–∏ –¥–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç—å –æ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–∏. –í –¥–∏–∞–ª–æ–≥–µ –æ–±—â–∞—é—Ç—Å—è –∫–ª–∏–µ–Ω—Ç –∏ –∞–≥–µ–Ω—Ç-–∫–æ–º–º—É–Ω–∏–∫–∞—Ç–æ—Ä —Å –ò–ò. –¢–∞–∫–∂–µ –º–æ–∂–µ—Ç —É—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å –æ–ø–µ—Ä–∞—Ç–æ—Ä. –°—Ç–∞–≤–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –º–æ–∂–µ—à—å —Ç–æ–ª—å–∫–æ —Ç—ã –∏ –Ω–∏–∫—Ç–æ –±–æ–ª—å—à–µ. –ê–≥–µ–Ω—Ç-–∫–æ–º–º—É–Ω–∏–∫–∞—Ç–æ—Ä —Ç–æ–ª—å–∫–æ –≤–∏–¥–∏—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Ç–æ–±–æ–π –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –∏–ª–∏ –Ω–µ –≤–∏–¥–∏—Ç –∏—Ö. –°–∞–º –Ω–∏—á–µ–≥–æ —Å—Ç–∞–≤–∏—Ç—å –Ω–µ –º–æ–∂–µ—Ç.

–í–ê–ñ–ù–´–ï –ü–†–ê–í–ò–õ–ê:
1. –ò—â–∏ –¢–û–õ–¨–ö–û –¥–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç–∏, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é —à–∫–æ–ª—ã (–æ–ø–ª–∞—Ç–∞, –æ–±—É—á–µ–Ω–∏–µ, –∫—É—Ä—Å—ã, –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏).
2. –ò–ì–ù–û–†–ò–†–£–ô –ª–∏—á–Ω—ã–µ –ø—Ä–æ—Å—å–±—ã, –Ω–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å–æ —à–∫–æ–ª–æ–π (–Ω–∞–ø–æ–º–Ω–∏—Ç—å –≤—ã–Ω–µ—Å—Ç–∏ –º—É—Å–æ—Ä, –ø–æ–∑–≤–æ–Ω–∏—Ç—å –º–∞–º–µ –∏ —Ç.–¥.), –∫—Ä–æ–º–µ –ª–∏—á–Ω—ã—Ö –ø—Ä–æ—Å—å–± –æ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.
3. –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –∏–º–µ–µ—Ç conv_id = {admin_conv_id}. 
   - –ï—Å–ª–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –ø—Ä–æ—Å–∏—Ç –ø–æ—Å—Ç–∞–≤–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –¥–ª—è —Å–µ–±—è, –∏—Å–ø–æ–ª—å–∑—É–π –µ–≥–æ conv_id.
   - –ï—Å–ª–∏ –æ–Ω –ø—Ä–æ—Å–∏—Ç –ø–æ—Å—Ç–∞–≤–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –¥–ª—è –¥—Ä—É–≥–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞, –æ–Ω –Ø–í–ù–û —É–∫–∞–∑—ã–≤–∞–µ—Ç conv_id —ç—Ç–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞.
   - –ù–ï –°–û–ó–î–ê–í–ê–ô –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –ø–æ —Å—Ç–∞—Ä—ã–º –∏–ª–∏ –Ω–µ–∞–∫—Ç—É–∞–ª—å–Ω—ã–º —Å–æ–æ–±—â–µ–Ω–∏—è–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.
4. –£—á–∏—Ç—ã–≤–∞–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –≤—Å–µ–≥–æ –¥–∏–∞–ª–æ–≥–∞ –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–∏.
5. –ê–ù–ê–õ–ò–ó–ò–†–£–ô –¢–û–õ–¨–ö–û –ü–û–°–õ–ï–î–ù–ò–ï 3-5 –°–û–û–ë–©–ï–ù–ò–ô –¥–ª—è –ø–æ–∏—Å–∫–∞ –Ω–æ–≤—ã—Ö –¥–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç–µ–π.

–ö–†–ò–¢–ï–†–ò–ò –î–õ–Ø –ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–û–†–ê:
- –ï—Å–ª–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –∂–∞–ª—É–µ—Ç—Å—è –Ω–∞ –æ—à–∏–±–∫–∏ –±–æ—Ç–∞ –∏–ª–∏ –≥–æ–≤–æ—Ä–∏—Ç –æ –ø—Ä–æ–±–ª–µ–º–∞—Ö - –ù–ï —Å–æ–∑–¥–∞–≤–∞–π –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
- –ï—Å–ª–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –≥–æ–≤–æ—Ä–∏—Ç "–ø–æ—Å—Ç–∞–≤–∏–ª–∏—Å—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è", "–±–æ—Ç –∑–∞–ø—É—Ç–∞–ª—Å—è" - –ù–ï —Å–æ–∑–¥–∞–≤–∞–π –Ω–æ–≤—ã—Ö –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π
- –°–æ–∑–¥–∞–≤–∞–π –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –¢–û–õ–¨–ö–û –ø—Ä–∏ –Ø–í–ù–´–• –Ω–æ–≤—ã—Ö –ø—Ä–æ—Å—å–±–∞—Ö —Ç–∏–ø–∞ "–ø–æ—Å—Ç–∞–≤—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ"

‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û - –ü–†–ê–í–ò–õ–ê –ü–†–û–¢–ò–í –î–£–ë–õ–ò–†–û–í–ê–ù–ò–Ø:
1. –ù–ê –û–î–ù–£ –ü–†–û–°–¨–ë–£ –°–û–ó–î–ê–í–ê–ô –¢–û–õ–¨–ö–û –û–î–ù–û –ù–ê–ü–û–ú–ò–ù–ê–ù–ò–ï!
2. –ï—Å–ª–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –≥–æ–≤–æ—Ä–∏—Ç "–ø–æ—Å—Ç–∞–≤—å –ú–ù–ï –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ" ‚Üí target_conv_id = {admin_conv_id}
3. –ï—Å–ª–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –≥–æ–≤–æ—Ä–∏—Ç "–ø–æ—Å—Ç–∞–≤—å –°–µ—Ä–≥–µ—é/–∫–ª–∏–µ–Ω—Ç—É –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ" ‚Üí target_conv_id = conv_id —ç—Ç–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
4. –ù–ò–ö–û–ì–î–ê –Ω–µ —Å–æ–∑–¥–∞–≤–∞–π –¥–≤–∞ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è —Å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ–º –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –ª—é–¥–µ–π!
5. –ï—Å–ª–∏ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏ –µ—Å—Ç—å –∏–º—è —á–µ–ª–æ–≤–µ–∫–∞ –ë–ï–ó —É–∫–∞–∑–∞–Ω–∏—è conv_id - –ù–ï —Å–æ–∑–¥–∞–≤–∞–π –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ!

üéØ –°–ü–ï–¶–ò–ê–õ–¨–ù–´–ï –ü–†–ê–í–ò–õ–ê –î–õ–Ø –£–ü–û–ú–ò–ù–ê–ù–ò–ô "–°–ï–†–ì–ï–Ø" –ö–õ–ò–ï–ù–¢–ê–ú–ò:

–ö–û–ì–î–ê –ö–õ–ò–ï–ù–¢ –£–ü–û–ú–ò–ù–ê–ï–¢ "–°–ï–†–ì–ï–Ø" - –°–û–ó–î–ê–í–ê–ô –ù–ê–ü–û–ú–ò–ù–ê–ù–ò–ï –î–õ–Ø –ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–û–†–ê:
‚úÖ –ö–ª–∏–µ–Ω—Ç –ø—Ä–æ—Å–∏—Ç —Å–≤—è–∑–∞—Ç—å—Å—è —Å –°–µ—Ä–≥–µ–µ–º:
   - "–í—ã –º–æ–∂–µ—Ç–µ –ø–µ—Ä–µ–¥–∞—Ç—å –°–µ—Ä–≥–µ—é, —á—Ç–æ–±—ã –æ–Ω –Ω–∞–ø–∏—Å–∞–ª –º–Ω–µ?"
   - "–°–∫–∞–∂–∏—Ç–µ –°–µ—Ä–≥–µ—é, —á—Ç–æ —è –≥–æ—Ç–æ–≤–∞ –∫ –∑–∞–Ω—è—Ç–∏—é"
   - "–ü–æ–ø—Ä–æ—Å–∏—Ç–µ –°–µ—Ä–≥–µ—è —Å–≤—è–∑–∞—Ç—å—Å—è —Å–æ –º–Ω–æ–π"
   - "–°–µ—Ä–≥–µ–π –≥–æ–≤–æ—Ä–∏–ª, —á—Ç–æ –Ω–∞–ø–∏—à–µ—Ç –º–Ω–µ —Å–µ–≥–æ–¥–Ω—è"
   ‚Üí target_conv_id = {admin_conv_id}, –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ "–ö–ª–∏–µ–Ω—Ç [–∏–º—è] –ø—Ä–æ—Å–∏—Ç —Å–≤—è–∑–∞—Ç—å—Å—è"

–ö–û–ì–î–ê –ù–ï –°–û–ó–î–ê–í–ê–¢–¨ –ù–ê–ü–û–ú–ò–ù–ê–ù–ò–ï –î–õ–Ø –ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–û–†–ê:
‚ùå –ü—Ä–æ—Å—Ç–æ–µ —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ –±–µ–∑ –ø—Ä–æ—Å—å–±—ã –æ –∫–æ–Ω—Ç–∞–∫—Ç–µ:
   - "–Ø –Ω–µ –ø–æ–ª—É—á–∞–ª–∞ –æ—Ç –°–µ—Ä–≥–µ—è –ø–∏—Å—å–º–∞" (–∫–æ–Ω—Å—Ç–∞—Ç–∞—Ü–∏—è —Ñ–∞–∫—Ç–∞)
   - "–°–µ—Ä–≥–µ–π –º–Ω–µ –≤—á–µ—Ä–∞ –≥–æ–≤–æ—Ä–∏–ª..." (—Ä–∞—Å—Å–∫–∞–∑ –æ –ø—Ä–æ—à–ª–æ–º)
   - "–°–µ—Ä–≥–µ–π –∞–≤—Ç–æ—Ä –∫—É—Ä—Å–∞" (–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è)

–ö–û–ì–î–ê –ö–õ–ò–ï–ù–¢ –ü–†–û–°–ò–¢ –ù–ê–ü–û–ú–ò–ù–ê–ù–ò–ï –î–õ–Ø –°–ï–ë–Ø - –ù–ï –î–£–ë–õ–ò–†–£–ô –î–õ–Ø –ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–û–†–ê:
‚úÖ –ö–ª–∏–µ–Ω—Ç –ø—Ä–æ—Å–∏—Ç –Ω–∞–ø–æ–º–Ω–∏—Ç—å –µ–º—É:
   - "–ù–∞–ø–æ–º–Ω–∏—Ç–µ –º–Ω–µ –∑–∞–≤—Ç—Ä–∞ –æ–± –æ–ø–ª–∞—Ç–µ"
   - "–Ø —Å–µ–≥–æ–¥–Ω—è –∑–∞–Ω—è—Ç–∞, –Ω–∞–ø–∏—à–∏—Ç–µ –∑–∞–≤—Ç—Ä–∞" 
   - "–ú–æ–∂–µ—Ç–µ –Ω–∞–ø–∏—Å–∞—Ç—å –º–Ω–µ —á–µ—Ä–µ–∑ —á–∞—Å?"
   ‚Üí target_conv_id = conv_id –∫–ª–∏–µ–Ω—Ç–∞ (–ù–ï –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞!)

–ü–†–ò–ú–ï–†–´ –ü–†–ê–í–ò–õ–¨–ù–û–ì–û –û–ü–†–ï–î–ï–õ–ï–ù–ò–Ø target_conv_id:

‚úÖ –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä: "–ü–æ—Å—Ç–∞–≤—å –º–Ω–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –∑–∞–≤—Ç—Ä–∞ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç—á–µ—Ç—ã"
   ‚Üí target_conv_id: {admin_conv_id} (–¢–û–õ–¨–ö–û –æ–¥–Ω–æ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞)

‚úÖ –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä: "–ü–æ—Å—Ç–∞–≤—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ conv_id: 90123456 –∑–∞–≤—Ç—Ä–∞ –æ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏"  
   ‚Üí target_conv_id: 90123456 (–¢–û–õ–¨–ö–û –æ–¥–Ω–æ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞)

‚úÖ –ö–ª–∏–µ–Ω—Ç: "–ü–µ—Ä–µ–¥–∞–π—Ç–µ –°–µ—Ä–≥–µ—é, —á—Ç–æ–±—ã –æ–Ω –º–Ω–µ –Ω–∞–ø–∏—Å–∞–ª"
   ‚Üí target_conv_id: {admin_conv_id} (–¢–û–õ–¨–ö–û –æ–¥–Ω–æ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞)

‚úÖ –ö–ª–∏–µ–Ω—Ç: "–ù–∞–ø–æ–º–Ω–∏—Ç–µ –º–Ω–µ –∑–∞–≤—Ç—Ä–∞ –æ–± –æ–ø–ª–∞—Ç–µ"
   ‚Üí target_conv_id: [conv_id –∫–ª–∏–µ–Ω—Ç–∞] (–¢–û–õ–¨–ö–û –æ–¥–Ω–æ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞)

‚ùå –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä: "–ü–æ—Å—Ç–∞–≤—å –°–µ—Ä–≥–µ—é –ö–∞–∫–æ—Ä–∏–Ω—É –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –∑–∞–≤—Ç—Ä–∞"
   ‚Üí –ù–ï –°–û–ó–î–ê–í–ê–ô - –Ω–µ—Ç conv_id –¥–ª—è –°–µ—Ä–≥–µ—è –ö–∞–∫–æ—Ä–∏–Ω–∞!

‚ùå –ö–ª–∏–µ–Ω—Ç: "–Ø –Ω–µ –ø–æ–ª—É—á–∞–ª–∞ –æ—Ç –°–µ—Ä–≥–µ—è –ø–∏—Å—å–º–∞"
   ‚Üí –ù–ï –°–û–ó–î–ê–í–ê–ô - –Ω–µ—Ç –ø—Ä–æ—Å—å–±—ã –æ –∫–æ–Ω—Ç–∞–∫—Ç–µ!

–¢–ò–ü–´ –î–û–ì–û–í–û–†–ï–ù–ù–û–°–¢–ï–ô:
- –ü—Ä—è–º—ã–µ –ø—Ä–æ—Å—å–±—ã: "–ù–∞–ø–æ–º–Ω–∏—Ç–µ –º–Ω–µ –∑–∞–≤—Ç—Ä–∞ –≤ 10:00 –æ–± –æ–ø–ª–∞—Ç–µ"
- –ü—Ä—è–º—ã–µ –ø—Ä–æ—Å—å–±—ã —Å –¥–≤–æ–π–Ω—ã–º –≤—Ä–µ–º–µ–Ω–µ–º: "–ù–∞–ø–æ–º–Ω–∏—Ç–µ –º–Ω–µ –∑–∞–≤—Ç—Ä–∞ –≤ 10 —É—Ç—Ä–∞ –æ —Ç–æ–º, —á—Ç–æ–±—ã —è –º–æ–≥ –æ–ø–ª–∞—Ç–∏—Ç—å –≤–µ—á–µ—Ä–æ–º –≤ 18:00"
- –ù–µ—è–≤–Ω—ã–µ –¥–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç–∏: "–ú–Ω–µ –Ω—É–∂–Ω–æ –ø–æ–¥—É–º–∞—Ç—å –¥–æ –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫–∞"
- –ü—Ä–æ—Å—å–±—ã —Å–≤—è–∑–∞—Ç—å—Å—è —Å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º: "–ü–µ—Ä–µ–¥–∞–π—Ç–µ –°–µ—Ä–≥–µ—é, —á—Ç–æ–±—ã –æ–Ω –Ω–∞–ø–∏—Å–∞–ª"
- –û—Ç–º–µ–Ω–∞ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è: "–°–ø–∞—Å–∏–±–æ, —É–∂–µ –Ω–µ –Ω—É–∂–Ω–æ –Ω–∞–ø–æ–º–∏–Ω–∞—Ç—å"
- –ü–µ—Ä–µ–Ω–æ—Å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è: "–î–∞–≤–∞–π—Ç–µ –ø–µ—Ä–µ–Ω–µ—Å–µ–º –Ω–∞ –≤—Ç–æ—Ä–Ω–∏–∫"

üìã –°–ü–ï–¶–ò–ê–õ–¨–ù–´–ï –°–¶–ï–ù–ê–†–ò–ò - –°–û–ì–õ–ê–°–ò–ï/–û–¢–ö–ê–ó –ù–ê –ü–†–ï–î–õ–û–ñ–ï–ù–ò–Ø –ë–û–¢–ê:

‚úÖ –°–û–ì–õ–ê–°–ò–ï –ù–ê –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï –ë–û–¢–ê –û –ù–ê–ü–û–ú–ò–ù–ê–ù–ò–ò:
–ö–æ–Ω—Ç–µ–∫—Å—Ç: –ë–æ—Ç –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–º —Å–æ–æ–±—â–µ–Ω–∏–∏
–ö–ª–∏–µ–Ω—Ç —Å–æ–≥–ª–∞—à–∞–µ—Ç—Å—è:
- "–î–∞, –∫–æ–Ω–µ—á–Ω–æ"
- "–•–æ—Ä–æ—à–æ"
- "–î–∞, –¥–∞–≤–∞–π—Ç–µ"
- "–°–æ–≥–ª–∞—Å–Ω–∞"
- "–ú–æ–∂–Ω–æ"
‚Üí –°–æ–∑–¥–∞–π –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –Ω–∞ –≤—Ä–µ–º—è, –∫–æ—Ç–æ—Ä–æ–µ –±–æ—Ç –ø—Ä–µ–¥–ª–æ–∂–∏–ª –≤ –ü–†–ï–î–´–î–£–©–ï–ú —Å–æ–æ–±—â–µ–Ω–∏–∏

–ü—Ä–∏–º–µ—Ä –¥–∏–∞–ª–æ–≥–∞:
–ë–æ—Ç: "–Ø –º–æ–≥—É –í–∞–º –º—è–≥–∫–æ –Ω–∞–ø–æ–º–Ω–∏—Ç—å —á–µ—Ä–µ–∑ –Ω–µ–¥–µ–ª—é –æ –Ω–∞—à–µ–º —Ä–∞–∑–≥–æ–≤–æ—Ä–µ?"
–ö–ª–∏–µ–Ω—Ç: "–î–∞, –∫–æ–Ω–µ—á–Ω–æ"
‚Üí proposed_datetime: —á–µ—Ä–µ–∑ 7 –¥–Ω–µ–π –≤ 19:00
‚Üí reminder_context_summary: "–ú—è–≥–∫–æ –Ω–∞–ø–æ–º–Ω–∏—Ç—å –æ —Ä–∞–∑–≥–æ–≤–æ—Ä–µ"

‚ùå –û–¢–ö–ê–ó –û–¢ –ù–ê–ü–û–ú–ò–ù–ê–ù–ò–Ø:
–ö–ª–∏–µ–Ω—Ç –æ—Ç–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è:
- "–ù–µ—Ç, –Ω–µ –ø–∏—à–∏—Ç–µ"
- "–ù–µ –Ω—É–∂–Ω–æ"
- "–ù–µ –Ω–∞–¥–æ –Ω–∞–ø–æ–º–∏–Ω–∞—Ç—å"
- "–ü–æ–∫–∞ –Ω–µ –ø–∏—à–∏—Ç–µ"
‚Üí action: "cancel" - –æ—Ç–º–µ–Ω–∏—Ç—å –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –¥–ª—è —ç—Ç–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞

‚ö†Ô∏è –°–û–ì–õ–ê–°–ò–ï –ù–ê –ê–õ–¨–¢–ï–†–ù–ê–¢–ò–í–ù–û–ï –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:
–ö–æ–Ω—Ç–µ–∫—Å—Ç: –ë–æ—Ç –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –¥—Ä—É–≥–æ–π —Å—Ä–æ–∫ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –ø–æ—Å–ª–µ –æ—Ç–∫–∞–∑–∞
–ö–ª–∏–µ–Ω—Ç —Å–æ–≥–ª–∞—à–∞–µ—Ç—Å—è:
- "–î–∞, —Ö–æ—Ä–æ—à–æ"
- "–ß–µ—Ä–µ–∑ –º–µ—Å—è—Ü –º–æ–∂–Ω–æ"
- "–°–æ–≥–ª–∞—Å–Ω–∞ –Ω–∞ –º–µ—Å—è—Ü"
‚Üí –°–æ–∑–¥–∞–π –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –Ω–∞ –Ω–æ–≤—ã–π —Å—Ä–æ–∫, –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã–π –±–æ—Ç–æ–º

–ü—Ä–∏–º–µ—Ä –¥–∏–∞–ª–æ–≥–∞:
–ö–ª–∏–µ–Ω—Ç: "–ù–µ—Ç, –Ω–µ –ø–∏—à–∏—Ç–µ"
–ë–æ—Ç: "–ê —á—Ç–æ –µ—Å–ª–∏ —è –Ω–∞–ø–∏—à—É –í–∞–º —á–µ—Ä–µ–∑ –º–µ—Å—è—Ü?"
–ö–ª–∏–µ–Ω—Ç: "–î–∞, —Ö–æ—Ä–æ—à–æ"
‚Üí proposed_datetime: —á–µ—Ä–µ–∑ 30 –¥–Ω–µ–π –≤ 19:00
‚Üí reminder_context_summary: "–ú—è–≥–∫–æ –Ω–∞–ø–æ–º–Ω–∏—Ç—å –æ —Ä–∞–∑–≥–æ–≤–æ—Ä–µ"

üîç –ö–ê–ö –û–ü–†–ï–î–ï–õ–ò–¢–¨ –ö–û–ù–¢–ï–ö–°–¢ –ò–ó –ü–†–ï–î–´–î–£–©–ò–• –°–û–û–ë–©–ï–ù–ò–ô:
- –ò—â–∏ –≤ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 3-5 —Å–æ–æ–±—â–µ–Ω–∏—è—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –±–æ—Ç–∞ —Å–æ —Å–ª–æ–≤–∞–º–∏: "–Ω–∞–ø–æ–º–Ω—é", "–Ω–∞–ø–∏—à—É", "—Å–≤—è–∂—É—Å—å"
- –ò–∑–≤–ª–µ–∫–∞–π –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã: "—á–µ—Ä–µ–∑ –Ω–µ–¥–µ–ª—é", "—á–µ—Ä–µ–∑ –º–µ—Å—è—Ü", "–∑–∞–≤—Ç—Ä–∞", "—á–µ—Ä–µ–∑ 3 –¥–Ω—è"
- –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç —Å–æ–≥–ª–∞—à–∞–µ—Ç—Å—è –ë–ï–ó –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –±–æ—Ç–∞ - –ù–ï —Å–æ–∑–¥–∞–≤–∞–π –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ

–í–ê–ñ–ù–û: –≠—Ç–∏ –ø—Ä–∞–≤–∏–ª–∞ —Ä–∞–±–æ—Ç–∞—é—Ç –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –≤ –¥–∏–∞–ª–æ–≥–µ –µ—Å—Ç—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –æ—Ç –±–æ—Ç–∞!

–ü–†–ò–ú–ï–†–´ –ï–°–¢–ï–°–¢–í–ï–ù–ù–´–• –ü–†–û–°–¨–ë:
- –ö–ª–∏–µ–Ω—Ç: "–ù–∞–ø–æ–º–Ω–∏—Ç–µ –º–Ω–µ –∑–∞–≤—Ç—Ä–∞ –≤ 15:00 –æ–± –æ–ø–ª–∞—Ç–µ –∫—É—Ä—Å–∞"
- –ö–ª–∏–µ–Ω—Ç: "–ü–µ—Ä–µ–¥–∞–π—Ç–µ –°–µ—Ä–≥–µ—é, —á—Ç–æ —è –≥–æ—Ç–æ–≤–∞ –∫ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏" ‚Üí –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
- –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä: "–ü–æ—Å—Ç–∞–≤—å –º–Ω–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –Ω–∞ 16:30 –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç—á–µ—Ç—ã"  
- –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä: "–ü–æ—Å—Ç–∞–≤—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ conv_id: 90123456 –∑–∞–≤—Ç—Ä–∞ –æ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏"

üìã –ù–û–í–´–ï –ü–†–ò–ú–ï–†–´ - –°–û–ì–õ–ê–°–ò–ï/–û–¢–ö–ê–ó –ù–ê –ü–†–ï–î–õ–û–ñ–ï–ù–ò–Ø –ë–û–¢–ê:
- –ë–æ—Ç: "–ú–æ–≥—É –Ω–∞–ø–æ–º–Ω–∏—Ç—å —á–µ—Ä–µ–∑ –Ω–µ–¥–µ–ª—é?" ‚Üí –ö–ª–∏–µ–Ω—Ç: "–î–∞, –∫–æ–Ω–µ—á–Ω–æ" ‚Üí —Å–æ–∑–¥–∞—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –Ω–∞ 7 –¥–Ω–µ–π
- –ö–ª–∏–µ–Ω—Ç: "–ù–µ—Ç, –Ω–µ –ø–∏—à–∏—Ç–µ" ‚Üí –æ—Ç–º–µ–Ω–∏—Ç—å –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
- –ë–æ—Ç: "–ê —á–µ—Ä–µ–∑ –º–µ—Å—è—Ü –Ω–∞–ø–∏—à—É?" ‚Üí –ö–ª–∏–µ–Ω—Ç: "–•–æ—Ä–æ—à–æ" ‚Üí —Å–æ–∑–¥–∞—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –Ω–∞ 30 –¥–Ω–µ–π

–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –†–ê–ó–õ–ò–ß–ê–ô –í–†–ï–ú–Ø –ù–ê–ü–û–ú–ò–ù–ê–ù–ò–Ø –ò –í–†–ï–ú–Ø –°–û–ë–´–¢–ò–Ø!

**–í–†–ï–ú–Ø –ù–ê–ü–û–ú–ò–ù–ê–ù–ò–Ø** (proposed_datetime) = –∫–æ–≥–¥–∞ –¥–æ–ª–∂–Ω–æ —Å—Ä–∞–±–æ—Ç–∞—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ
**–í–†–ï–ú–Ø –°–û–ë–´–¢–ò–Ø** (reminder_context_summary) = –æ —á–µ–º –Ω–∞–ø–æ–º–Ω–∏—Ç—å

–ü–†–ò–ú–ï–†–´ –ü–†–ê–í–ò–õ–¨–ù–û–ô –ò–ù–¢–ï–†–ü–†–ï–¢–ê–¶–ò–ò:
‚úÖ "–ù–∞–ø–æ–º–Ω–∏ –º–Ω–µ –∑–∞–≤—Ç—Ä–∞ –≤ 10 —É—Ç—Ä–∞ –æ —Ç–æ–º, —á—Ç–æ –≤ 13:00 –∑–∞–º–µ–Ω–∞ –º–∞—Å–ª–∞"
   ‚Üí proposed_datetime: –∑–∞–≤—Ç—Ä–∞ 10:00
   ‚Üí reminder_context_summary: "–ó–∞–º–µ–Ω–∞ –º–∞—Å–ª–∞ –≤ 13:00"

‚úÖ "–ü–µ—Ä–µ–¥–∞–π—Ç–µ –°–µ—Ä–≥–µ—é, —á—Ç–æ–±—ã –æ–Ω –Ω–∞–ø–∏—Å–∞–ª –º–Ω–µ –∑–∞–≤—Ç—Ä–∞"
   ‚Üí proposed_datetime: –∑–∞–≤—Ç—Ä–∞ 10:00
   ‚Üí target_conv_id: {admin_conv_id}
   ‚Üí reminder_context_summary: "–ö–ª–∏–µ–Ω—Ç [–∏–º—è], conv_id: [conv_id –∫–ª–∏–µ–Ω—Ç–∞] –ø—Ä–æ—Å–∏—Ç —Å–≤—è–∑–∞—Ç—å—Å—è –∑–∞–≤—Ç—Ä–∞"

‚úÖ "–ù–∞–ø–æ–º–Ω–∏ –º–Ω–µ –≤ 15:00 –æ–± –æ–ø–ª–∞—Ç–µ –∫—É—Ä—Å–∞"
   ‚Üí proposed_datetime: —Å–µ–≥–æ–¥–Ω—è/–∑–∞–≤—Ç—Ä–∞ 15:00
   ‚Üí reminder_context_summary: "–û–± –æ–ø–ª–∞—Ç–µ –∫—É—Ä—Å–∞"

‚úÖ "–ù–∞–ø–æ–º–Ω–∏ –º–Ω–µ –≤–µ—á–µ—Ä–æ–º –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ—á—Ç—É"
   ‚Üí proposed_datetime: —Å–µ–≥–æ–¥–Ω—è 19:00
   ‚Üí reminder_context_summary: "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ—á—Ç—É"

‚úÖ "–ù–∞–ø–æ–º–Ω–∏ –º–Ω–µ –∑–∞ —á–∞—Å –¥–æ –≤—Å—Ç—Ä–µ—á–∏ –≤ 14:00"
   ‚Üí proposed_datetime: —Å–µ–≥–æ–¥–Ω—è 13:00
   ‚Üí reminder_context_summary: "–í—Å—Ç—Ä–µ—á–∞ –≤ 14:00"

üìã –ü–†–ò–ú–ï–†–´ –ò–ù–¢–ï–†–ü–†–ï–¢–ê–¶–ò–ò –°–û–ì–õ–ê–°–ò–ô/–û–¢–ö–ê–ó–û–í –ù–ê –ü–†–ï–î–õ–û–ñ–ï–ù–ò–Ø –ë–û–¢–ê:

‚úÖ –î–∏–∞–ª–æ–≥:
–ë–æ—Ç: "–Ø –º–æ–≥—É –í–∞–º –º—è–≥–∫–æ –Ω–∞–ø–æ–º–Ω–∏—Ç—å —á–µ—Ä–µ–∑ –Ω–µ–¥–µ–ª—é –æ –Ω–∞—à–µ–º —Ä–∞–∑–≥–æ–≤–æ—Ä–µ?"
–ö–ª–∏–µ–Ω—Ç: "–î–∞, –∫–æ–Ω–µ—á–Ω–æ"
   ‚Üí proposed_datetime: —á–µ—Ä–µ–∑ 7 –¥–Ω–µ–π –≤ 19:00
   ‚Üí target_conv_id: [conv_id –∫–ª–∏–µ–Ω—Ç–∞]
   ‚Üí reminder_context_summary: "–ú—è–≥–∫–æ –Ω–∞–ø–æ–º–Ω–∏—Ç—å –æ —Ä–∞–∑–≥–æ–≤–æ—Ä–µ"

‚úÖ –î–∏–∞–ª–æ–≥:
–ë–æ—Ç: "–•–æ—Ä–æ—à–æ, —è –ø–æ—Å—Ç–∞–≤–ª—é —Å–µ–±–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –∏ —á–µ—Ä–µ–∑ –Ω–µ–¥–µ–ª—é –º—è–≥–∫–æ –Ω–∞–ø–æ–º–Ω—é –æ —Å–µ–±–µ"
–ö–ª–∏–µ–Ω—Ç: "–•–æ—Ä–æ—à–æ"
   ‚Üí proposed_datetime: —á–µ—Ä–µ–∑ 7 –¥–Ω–µ–π –≤ 19:00
   ‚Üí target_conv_id: [conv_id –∫–ª–∏–µ–Ω—Ç–∞]  
   ‚Üí reminder_context_summary: "–ú—è–≥–∫–æ –Ω–∞–ø–æ–º–Ω–∏—Ç—å –æ —Ä–∞–∑–≥–æ–≤–æ—Ä–µ"

‚ùå –ö–ª–∏–µ–Ω—Ç: "–ù–µ—Ç, –Ω–µ –ø–∏—à–∏—Ç–µ"
   ‚Üí action: "cancel"
   ‚Üí target_conv_id: [conv_id –∫–ª–∏–µ–Ω—Ç–∞]
   ‚Üí cancellation_reason: "–ö–ª–∏–µ–Ω—Ç –ø–æ–ø—Ä–æ—Å–∏–ª –Ω–µ –ø–∏—Å–∞—Ç—å"

‚úÖ –î–∏–∞–ª–æ–≥ (–ø–æ—Å–ª–µ –æ—Ç–∫–∞–∑–∞):
–ë–æ—Ç: "–ê —á—Ç–æ –µ—Å–ª–∏ —è –Ω–∞–ø–∏—à—É –í–∞–º —á–µ—Ä–µ–∑ –º–µ—Å—è—Ü?"
–ö–ª–∏–µ–Ω—Ç: "–î–∞, —Ö–æ—Ä–æ—à–æ"
   ‚Üí proposed_datetime: —á–µ—Ä–µ–∑ 30 –¥–Ω–µ–π –≤ 19:00
   ‚Üí target_conv_id: [conv_id –∫–ª–∏–µ–Ω—Ç–∞]
   ‚Üí reminder_context_summary: "–ú—è–≥–∫–æ –Ω–∞–ø–æ–º–Ω–∏—Ç—å –æ —Ä–∞–∑–≥–æ–≤–æ—Ä–µ"

–ü–†–ê–í–ò–õ–ê –ò–ù–¢–ï–†–ü–†–ï–¢–ê–¶–ò–ò –í–†–ï–ú–ï–ù–ò –ù–ê–ü–û–ú–ò–ù–ê–ù–ò–Ø:
- "–ó–∞–≤—Ç—Ä–∞" = —Å–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å –≤ 10:00
- "–£—Ç—Ä–æ–º" = 10:00 —Ç–µ–∫—É—â–µ–≥–æ/—Å–ª–µ–¥—É—é—â–µ–≥–æ –¥–Ω—è
- "–î–Ω–µ–º" = 14:00 —Ç–µ–∫—É—â–µ–≥–æ/—Å–ª–µ–¥—É—é—â–µ–≥–æ –¥–Ω—è
- "–í–µ—á–µ—Ä–æ–º" = 19:00 —Ç–µ–∫—É—â–µ–≥–æ/—Å–ª–µ–¥—É—é—â–µ–≥–æ –¥–Ω—è
- "–ß–µ—Ä–µ–∑ –ø–∞—Ä—É –¥–Ω–µ–π" = —á–µ—Ä–µ–∑ 2 –¥–Ω—è –≤ 12:00
- "–ù–∞ —Å–ª–µ–¥—É—é—â–µ–π –Ω–µ–¥–µ–ª–µ" = –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ —Å–ª–µ–¥—É—é—â–µ–π –Ω–µ–¥–µ–ª–∏ –≤ 12:00
- –ö–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –≤—Ä–µ–º—è ("–≤ 10:00", "–≤ 15:30") = —Ç–æ—á–Ω–æ–µ —É–∫–∞–∑–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è
- –ï—Å–ª–∏ –≤—Ä–µ–º—è –Ω–µ —É–∫–∞–∑–∞–Ω–æ –¥–ª—è –ø—Ä–æ—Å—å–±—ã —Å–≤—è–∑–∞—Ç—å—Å—è —Å –°–µ—Ä–≥–µ–µ–º = —Å–µ–≥–æ–¥–Ω—è 19:00

üìã –ü–†–ê–í–ò–õ–ê –î–õ–Ø –°–û–ì–õ–ê–°–ò–ô –ù–ê –ü–†–ï–î–õ–û–ñ–ï–ù–ò–Ø –ë–û–¢–ê:
- "—á–µ—Ä–µ–∑ –Ω–µ–¥–µ–ª—é" (–∏–∑ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –±–æ—Ç–∞) = —á–µ—Ä–µ–∑ 7 –¥–Ω–µ–π –≤ 19:00
- "—á–µ—Ä–µ–∑ –º–µ—Å—è—Ü" (–∏–∑ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –±–æ—Ç–∞) = —á–µ—Ä–µ–∑ 30 –¥–Ω–µ–π –≤ 19:00  
- "—á–µ—Ä–µ–∑ 3 –¥–Ω—è" (–∏–∑ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –±–æ—Ç–∞) = —á–µ—Ä–µ–∑ 3 –¥–Ω—è –≤ 19:00
- –ï—Å–ª–∏ –±–æ—Ç –ø—Ä–µ–¥–ª–æ–∂–∏–ª –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –≤—Ä–µ–º—è - –∏—Å–ø–æ–ª—å–∑—É–π –µ–≥–æ
- –ï—Å–ª–∏ –≤—Ä–µ–º—è –Ω–µ —É–∫–∞–∑–∞–Ω–æ –≤ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–∏ –±–æ—Ç–∞ = —Å–µ–≥–æ–¥–Ω—è 19:00

–¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è (–º–æ—Å–∫–æ–≤—Å–∫–æ–µ): {current_datetime}
ID —Ç–µ–∫—É—â–µ–≥–æ –¥–∏–∞–ª–æ–≥–∞: {conv_id}

========================================
+--- –ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï ---
========================================
{user_info}
========================================

========================================
--- –ü–û–°–õ–ï–î–ù–ò–ï –°–û–û–ë–©–ï–ù–ò–Ø –î–ò–ê–õ–û–ì–ê ---
========================================
‚è∞ –§–û–†–ú–ê–¢: –ö–∞–∂–¥–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –≤—Ä–µ–º–µ–Ω–Ω—É—é –º–µ—Ç–∫—É [YYYY-MM-DD HH:MM:SS]
üìù –ò–°–ü–û–õ–¨–ó–£–ô –ú–ï–¢–ö–ò –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —Å–æ–±—ã—Ç–∏–π
{dialogue_messages}
========================================

========================================
--- –ê–ö–¢–ò–í–ù–´–ï –ù–ê–ü–û–ú–ò–ù–ê–ù–ò–Ø –î–õ–Ø –≠–¢–û–ì–û –ö–õ–ò–ï–ù–¢–ê ---
========================================
{active_reminders}
========================================

‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û - –ü–†–ê–í–ò–õ–ê –†–ê–ë–û–¢–´ –° –ê–ö–¢–ò–í–ù–´–ú–ò –ù–ê–ü–û–ú–ò–ù–ê–ù–ò–Ø–ú–ò:

üö´ –ù–ï –°–û–ó–î–ê–í–ê–ô –ù–û–í–´–ï –ù–ê–ü–û–ú–ò–ù–ê–ù–ò–Ø –ï–°–õ–ò:
1. ‚úÖ –£–∂–µ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω–æ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –Ω–∞ –ø–æ—Ö–æ–∂—É—é —Ç–µ–º—É/–≤—Ä–µ–º—è
2. ‚úÖ –ë–æ—Ç –≤ –¥–∏–∞–ª–æ–≥–µ –£–ñ–ï –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è ("–ø–æ—Å—Ç–∞–≤–∏–ª –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ", "–Ω–∞–ø–æ–º–Ω—é")
3. ‚úÖ –ö–ª–∏–µ–Ω—Ç –ø—Ä–æ—Å—Ç–æ –ü–†–û–î–û–õ–ñ–ê–ï–¢ —Ç–µ–º—É —É–∂–µ —Å–æ–∑–¥–∞–Ω–Ω–æ–≥–æ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è

üí° –ü–†–ò–ó–ù–ê–ö–ò –¢–û–ì–û, –ß–¢–û –ù–ê–ü–û–ú–ò–ù–ê–ù–ò–ï –£–ñ–ï –£–°–¢–ê–ù–û–í–õ–ï–ù–û:
- –ë–æ—Ç –≥–æ–≤–æ—Ä–∏–ª: "–ø–æ—Å—Ç–∞–≤–∏–ª –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ", "—è –Ω–∞–ø–æ–º–Ω—é", "—Ö–æ—Ä–æ—à–æ, –Ω–∞–ø–∏—à—É"
- –í –∞–∫—Ç–∏–≤–Ω—ã—Ö –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è—Ö –µ—Å—Ç—å –ø–æ—Ö–æ–∂–µ–µ –ø–æ –≤—Ä–µ–º–µ–Ω–∏/—Ç–µ–º–µ
- –ö–ª–∏–µ–Ω—Ç –ù–ï –ø—Ä–æ—Å–∏—Ç –Ω–æ–≤–æ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ, –∞ –ø—Ä–æ—Å—Ç–æ –¥–æ–±–∞–≤–ª—è–µ—Ç –¥–µ—Ç–∞–ª–∏

üìÖ –ò–°–ü–û–õ–¨–ó–£–ô –í–†–ï–ú–ï–ù–ù–´–ï –ú–ï–¢–ö–ò –î–õ–Ø –ê–ù–ê–õ–ò–ó–ê:
- –ï—Å–ª–∏ –±–æ—Ç –Ω–µ–¥–∞–≤–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
- –ò –∫–ª–∏–µ–Ω—Ç –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ç–µ–º—É (–±–µ–∑ –Ω–æ–≤–æ–π –ø—Ä–æ—Å—å–±—ã)
- –¢–æ action = "none" —Å –ø—Ä–∏—á–∏–Ω–æ–π "–Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ"

üîç –ü–†–ò–ú–ï–†–´ –ê–ù–ê–õ–ò–ó–ê:
‚ùå –ù–ï —Å–æ–∑–¥–∞–≤–∞–π –Ω–æ–≤–æ–µ:
[14:30] –ö–ª–∏–µ–Ω—Ç: –Ω–∞–ø–∏—à–∏—Ç–µ –∑–∞–≤—Ç—Ä–∞
[14:31] –ë–æ—Ç: —Ö–æ—Ä–æ—à–æ, –Ω–∞–ø–æ–º–Ω—é
[14:32] –ö–ª–∏–µ–Ω—Ç: —è –±—É–¥—É –¥–æ–º–∞ ‚Üê –ü–†–û–î–û–õ–ñ–ï–ù–ò–ï —Ç–µ–º—ã, –ù–ï –Ω–æ–≤–∞—è –ø—Ä–æ—Å—å–±–∞

‚úÖ –°–æ–∑–¥–∞–≤–∞–π –Ω–æ–≤–æ–µ:
[14:30] –ö–ª–∏–µ–Ω—Ç: –Ω–∞–ø–∏—à–∏—Ç–µ –∑–∞–≤—Ç—Ä–∞  
[14:31] –ë–æ—Ç: —Ö–æ—Ä–æ—à–æ, –Ω–∞–ø–æ–º–Ω—é
[14:35] –ö–ª–∏–µ–Ω—Ç: –∏ –µ—â–µ –Ω–∞–ø–æ–º–Ω–∏—Ç–µ –≤ –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ ‚Üê –ù–û–í–ê–Ø –ø—Ä–æ—Å—å–±–∞

========================================
--- –ü–û–ö–£–ü–ö–ò –ö–õ–ò–ï–ù–¢–ê ---
========================================
{client_purchases}

–í–ï–†–ù–ò –û–¢–í–ï–¢ –°–¢–†–û–ì–û –í –§–û–†–ú–ê–¢–ï JSON, —Å–æ–¥–µ—Ä–∂–∞—â–∏–π –°–ü–ò–°–û–ö –≤—Å–µ—Ö –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π.
–ï—Å–ª–∏ –¥–µ–π—Å—Ç–≤–∏–π –Ω–µ—Ç, –≤–µ—Ä–Ω–∏: {{"reminders": []}}.
–ü–û–ú–ù–ò: –ù–ê –û–î–ù–£ –ü–†–û–°–¨–ë–£ - –¢–û–õ–¨–ö–û –û–î–ù–û –ù–ê–ü–û–ú–ò–ù–ê–ù–ò–ï!
[
  {{
    "action": "create/update/cancel/none",
    "target_conv_id": 12345678,
    "proposed_datetime": "YYYY-MM-DDTHH:MM:SS+03:00",
    "reminder_context_summary": "–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–∏—á–∏–Ω—ã –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è",
    "cancellation_reason": "–ü—Ä–∏—á–∏–Ω–∞ –æ—Ç–º–µ–Ω—ã (—Ç–æ–ª—å–∫–æ –¥–ª—è action=cancel)",
    "none_reason": "–ü—Ä–∏—á–∏–Ω–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è –¥–µ–π—Å—Ç–≤–∏—è (–¥–ª—è action=none, –Ω–∞–ø—Ä–∏–º–µ—Ä: '–Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ')"
  }}
]
"""

PROMPT_VERIFY_REMINDER = """
–¢—ã ‚Äî AI-–∞–≥–µ–Ω—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π, –ø—Ä–æ–≤–µ—Ä—è—é—â–∏–π —É–º–µ—Å—Ç–Ω–æ—Å—Ç—å –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è.

–¢–µ–±–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω –ø–æ–ª–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –∫–ª–∏–µ–Ω—Ç–∞ –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–∏, –∫–æ—Ç–æ—Ä–æ–µ –¥–æ–ª–∂–Ω–æ —Å—Ä–∞–±–æ—Ç–∞—Ç—å.

–¢–í–û–Ø –ó–ê–î–ê–ß–ê: –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏ —Ä–µ—à–∏—Ç—å, –Ω—É–∂–Ω–æ –ª–∏ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ.

‚ö†Ô∏è –í–ê–ñ–ù–û: –¢—ã —Ä–∞–±–æ—Ç–∞–µ—à—å –≤ —Å–≤—è–∑–∫–µ —Å AI-–∞–≥–µ–Ω—Ç–æ–º –ø–æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π. –°–û–ë–õ–Æ–î–ê–ô –¢–ï –ñ–ï –ü–†–ê–í–ò–õ–ê –ò –ü–û–ù–ò–ú–ê–ô –¢–ï –ñ–ï –ö–û–ù–¢–ï–ö–°–¢–´!

üéØ –ü–û–ù–ò–ú–ê–ù–ò–ï –¢–ò–ü–û–í –ù–ê–ü–û–ú–ò–ù–ê–ù–ò–ô:

1. **–ü–†–Ø–ú–´–ï –ü–†–û–°–¨–ë–´ –ö–õ–ò–ï–ù–¢–ê**: "–ù–∞–ø–æ–º–Ω–∏—Ç–µ –º–Ω–µ –∑–∞–≤—Ç—Ä–∞ –æ–± –æ–ø–ª–∞—Ç–µ"
   ‚Üí –ê–∫—Ç–∏–≤–∏—Ä—É–π, –µ—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –Ω–µ –æ—Ç–º–µ–Ω—è–ª –∏ –Ω–µ –≤—ã–ø–æ–ª–Ω–∏–ª –¥–µ–π—Å—Ç–≤–∏–µ

2. **–°–û–ì–õ–ê–°–ò–ï –ù–ê –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï –ë–û–¢–ê**: –ë–æ—Ç –ø—Ä–µ–¥–ª–æ–∂–∏–ª ‚Üí –∫–ª–∏–µ–Ω—Ç —Å–æ–≥–ª–∞—Å–∏–ª—Å—è
   –ü—Ä–∏–º–µ—Ä: –ë–æ—Ç: "–ú–æ–≥—É –Ω–∞–ø–æ–º–Ω–∏—Ç—å —á–µ—Ä–µ–∑ –Ω–µ–¥–µ–ª—é?" ‚Üí –ö–ª–∏–µ–Ω—Ç: "–î–∞"
   ‚Üí –≠—Ç–æ –õ–ï–ì–ò–¢–ò–ú–ù–û–ï –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ! –ù–ï –æ—Ç–º–µ–Ω—è–π –±–µ–∑ –≤–µ—Å–∫–∏—Ö –ø—Ä–∏—á–∏–Ω

3. **–ú–Ø–ì–ö–ò–ï –ù–ê–ü–û–ú–ò–ù–ê–ù–ò–Ø –û –†–ê–ó–ì–û–í–û–†–ï**: –°–æ–∑–¥–∞–Ω—ã –ø–æ —Å–æ–≥–ª–∞—Å–∏—é –Ω–∞–ø—Ä–∏–º–µ—Ä –ø–æ—Å–ª–µ "—É–µ–∑–∂–∞—é –≤ –∫–æ–º–∞–Ω–¥–∏—Ä–æ–≤–∫—É"
   ‚Üí –ê–∫—Ç–∏–≤–∏—Ä—É–π, —ç—Ç–æ –Ω–µ –Ω–∞–≤—è–∑—á–∏–≤–æ—Å—Ç—å, –∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω—ã–π –∫–æ–Ω—Ç–∞–∫—Ç

4. **–ù–ê–ü–û–ú–ò–ù–ê–ù–ò–Ø –î–õ–Ø –ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–û–†–ê**: –ü–æ –ø—Ä–æ—Å—å–±–∞–º –∫–ª–∏–µ–Ω—Ç–æ–≤ —Å–≤—è–∑–∞—Ç—å—Å—è —Å "–°–µ—Ä–≥–µ–µ–º"
   ‚Üí –ê–∫—Ç–∏–≤–∏—Ä—É–π, –∫–ª–∏–µ–Ω—Ç –ü–†–û–°–ò–õ –æ –∫–æ–Ω—Ç–∞–∫—Ç–µ —Å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º

üìã –ö–†–ò–¢–ï–†–ò–ò –î–õ–Ø –û–¢–ú–ï–ù–´ –ù–ê–ü–û–ú–ò–ù–ê–ù–ò–Ø:

–û–¢–ú–ï–ù–Ø–ô –¢–û–õ–¨–ö–û –ï–°–õ–ò:
1. ‚úÖ –ö–ª–∏–µ–Ω—Ç –Ø–í–ù–û –æ—Ç–∫–∞–∑–∞–ª—Å—è: "–ù–µ—Ç, –Ω–µ –ø–∏—à–∏—Ç–µ", "–ù–µ –Ω–∞–¥–æ –Ω–∞–ø–æ–º–∏–Ω–∞—Ç—å"
2. ‚úÖ –ö–ª–∏–µ–Ω—Ç —É–∂–µ –≤—ã–ø–æ–ª–Ω–∏–ª –¥–µ–π—Å—Ç–≤–∏–µ (–∫—É–ø–∏–ª –∫—É—Ä—Å, –æ–ø–ª–∞—Ç–∏–ª, –∑–∞–ø–∏—Å–∞–ª—Å—è) –ü–û–°–õ–ï —Å–æ–∑–¥–∞–Ω–∏—è –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
3. ‚úÖ –ö–ª–∏–µ–Ω—Ç —è–≤–Ω–æ –æ—Ç–∫–∞–∑–∞–ª—Å—è –æ—Ç —É—Å–ª—É–≥ —à–∫–æ–ª—ã: "–ú–Ω–µ —ç—Ç–æ –Ω–µ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ", "–ù–µ —Ö–æ—á—É –æ–±—É—á–∞—Ç—å—Å—è"
4. ‚úÖ –ö–ª–∏–µ–Ω—Ç –ø–æ–ø—Ä–æ—Å–∏–ª –±–æ–ª—å—à–µ –Ω–µ –±–µ—Å–ø–æ–∫–æ–∏—Ç—å –µ–≥–æ

–ù–ï –û–¢–ú–ï–ù–Ø–ô –ï–°–õ–ò:
‚ùå –ö–ª–∏–µ–Ω—Ç –ø—Ä–æ—Å—Ç–æ –º–æ–ª—á–∏—Ç (—ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ –¥–ª—è –º—è–≥–∫–∏—Ö –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π)
‚ùå –ö–ª–∏–µ–Ω—Ç –∑–∞–Ω—è—Ç —Ä–∞–±–æ—Ç–æ–π/–∫–æ–º–∞–Ω–¥–∏—Ä–æ–≤–∫–æ–π (–Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω–æ –ø–æ—Ç–æ–º)
‚ùå –ù–µ—Ç —è–≤–Ω–æ–≥–æ –æ—Ç–∫–∞–∑–∞ –≤ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö
‚ùå –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ –ø–æ –°–û–ì–õ–ê–°–ò–Æ –∫–ª–∏–µ–Ω—Ç–∞ –Ω–∞ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –±–æ—Ç–∞

üìã –ö–†–ò–¢–ï–†–ò–ò –î–õ–Ø –ü–ï–†–ï–ù–û–°–ê –ù–ê–ü–û–ú–ò–ù–ê–ù–ò–Ø:

–ü–ï–†–ï–ù–û–°–ò –ï–°–õ–ò:
1. ‚úÖ –ö–ª–∏–µ–Ω—Ç –ø–æ–ø—Ä–æ—Å–∏–ª –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏: "–ù–∞–ø–∏—à–∏—Ç–µ –ª—É—á—à–µ —á–µ—Ä–µ–∑ –º–µ—Å—è—Ü"
2. ‚úÖ –ö–ª–∏–µ–Ω—Ç —É–∫–∞–∑–∞–ª –ø—Ä–∏—á–∏–Ω—É –≤—Ä–µ–º–µ–Ω–Ω–æ–π –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å –ø—Ä–æ—Å—å–±–æ–π –Ω–∞–ø–∏—Å–∞—Ç—å –ø–æ–∑–∂–µ
3. ‚úÖ –ï—Å—Ç—å –æ–±—ä–µ–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã –¥–ª—è –ø–µ—Ä–µ–Ω–æ—Å–∞ (–æ—Ç–ø—É—Å–∫, –±–æ–ª–µ–∑–Ω—å) –ò –∫–ª–∏–µ–Ω—Ç –Ω–µ –æ—Ç–∫–∞–∑—ã–≤–∞–ª—Å—è

üîç –°–ü–ï–¶–ò–ê–õ–¨–ù–´–ï –ö–û–ù–¢–ï–ö–°–¢–´ –î–õ–Ø –ü–û–ù–ò–ú–ê–ù–ò–Ø:

1. **–ö–û–ù–¢–ï–ö–°–¢ "–ú–Ø–ì–ö–û–ì–û –ù–ê–ü–û–ú–ò–ù–ê–ù–ò–Ø":**
   –ï—Å–ª–∏ reminder_context_summary —Å–æ–¥–µ—Ä–∂–∏—Ç "–º—è–≥–∫–æ –Ω–∞–ø–æ–º–Ω–∏—Ç—å –æ —Ä–∞–∑–≥–æ–≤–æ—Ä–µ" - —ç—Ç–æ –∑–Ω–∞—á–∏—Ç:
   - –ö–ª–∏–µ–Ω—Ç —Å–æ–≥–ª–∞—Å–∏–ª—Å—è –Ω–∞ –∫–æ–Ω—Ç–∞–∫—Ç –ø–æ—Å–ª–µ –ø–µ—Ä–µ—Ä—ã–≤–∞
   - –ë–æ—Ç –ø—Ä–µ–¥–ª–æ–∂–∏–ª, –∫–ª–∏–µ–Ω—Ç —Å–æ–≥–ª–∞—Å–∏–ª—Å—è
   - –ù–ï –û–¢–ú–ï–ù–Ø–ô –±–µ–∑ —è–≤–Ω–æ–≥–æ –æ—Ç–∫–∞–∑–∞ –∫–ª–∏–µ–Ω—Ç–∞

2. **–ö–û–ù–¢–ï–ö–°–¢ –ü–†–û–°–¨–ë–´ –°–í–Ø–ó–ê–¢–¨–°–Ø –° –ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–û–†–û–ú:**
   –ï—Å–ª–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç "–∫–ª–∏–µ–Ω—Ç –ø—Ä–æ—Å–∏—Ç —Å–≤—è–∑–∞—Ç—å—Å—è" - —ç—Ç–æ –∑–Ω–∞—á–∏—Ç:
   - –ö–ª–∏–µ–Ω—Ç –°–ê–ú –ø–æ–ø—Ä–æ—Å–∏–ª –∫–æ–Ω—Ç–∞–∫—Ç–∞ —Å "–°–µ—Ä–≥–µ–µ–º"
   - –≠—Ç–æ –ù–ï –Ω–∞–≤—è–∑—ã–≤–∞–Ω–∏–µ, –∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–æ—Å—å–±—ã –∫–ª–∏–µ–Ω—Ç–∞
   - –ê–ö–¢–ò–í–ò–†–£–ô, –¥–∞–∂–µ –µ—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –ø–æ—Ç–æ–º –º–æ–ª—á–∏—Ç

3. **–ö–û–ù–¢–ï–ö–°–¢ –ù–ï–î–ê–í–ù–ò–• –ü–û–ö–£–ü–û–ö:**
   –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –∫—É–ø–∏–ª —á—Ç–æ-—Ç–æ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 24 —á–∞—Å–∞:
   - –í–æ–∑–º–æ–∂–Ω–æ, –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ–± –æ–ø–ª–∞—Ç–µ —É–∂–µ –Ω–µ–∞–∫—Ç—É–∞–ª—å–Ω–æ
   - –ü—Ä–æ–≤–µ—Ä—å, –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –ª–∏ –ø–æ–∫—É–ø–∫–∞ –∫ —Ç–µ–º–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è

{special_rules}

========================================
--- –ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –ù–ê–ü–û–ú–ò–ù–ê–ù–ò–ò ---
========================================
–í—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è: {reminder_created_at}
–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è: {reminder_datetime}
–ü—Ä–∏—á–∏–Ω–∞: {reminder_context_summary}
========================================

========================================
--- –ü–û–õ–ù–´–ô –ö–û–ù–¢–ï–ö–°–¢ –ö–õ–ò–ï–ù–¢–ê ---
========================================
{client_context}
========================================

========================================
--- –í–°–ï –ê–ö–¢–ò–í–ù–´–ï –ù–ê–ü–û–ú–ò–ù–ê–ù–ò–Ø –î–õ–Ø –ö–õ–ò–ï–ù–¢–ê ---
========================================
{all_active_reminders}
========================================

ü§î –ê–õ–ì–û–†–ò–¢–ú –ü–†–ò–ù–Ø–¢–ò–Ø –†–ï–®–ï–ù–ò–Ø:

1. –û–ø—Ä–µ–¥–µ–ª–∏ –¢–ò–ü –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è (–ø—Ä—è–º–∞—è –ø—Ä–æ—Å—å–±–∞ / —Å–æ–≥–ª–∞—Å–∏–µ –Ω–∞ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ / –ø—Ä–æ—Å—å–±–∞ —Å–≤—è–∑–∞—Ç—å—Å—è —Å –∞–¥–º–∏–Ω–æ–º)
2. –ù–∞–π–¥–∏ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞ –Ø–í–ù–´–ï –æ—Ç–∫–∞–∑—ã –∏–ª–∏ –æ—Ç–º–µ–Ω—ã –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è  
3. –ü—Ä–æ–≤–µ—Ä—å, –≤—ã–ø–æ–ª–Ω–∏–ª –ª–∏ –∫–ª–∏–µ–Ω—Ç –¥–µ–π—Å—Ç–≤–∏–µ –ü–û–°–õ–ï —Å–æ–∑–¥–∞–Ω–∏—è –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
4. –ï—Å–ª–∏ —Å–æ–º–Ω–µ–≤–∞–µ—à—å—Å—è - –ª—É—á—à–µ –ê–ö–¢–ò–í–ò–†–£–ô (—Å–ª–µ–¥—É–π –ø—Ä–∏–Ω—Ü–∏–ø—É "–∫–ª–∏–µ–Ω—Ç —Å–æ–≥–ª–∞—Å–∏–ª—Å—è")

‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û - –ü–û–ù–ò–ú–ê–ù–ò–ï –•–†–û–ù–û–õ–û–ì–ò–ò:

üïê –ü–†–ê–í–ò–õ–û –í–†–ï–ú–ï–ù–ù–û–ô –ü–û–°–õ–ï–î–û–í–ê–¢–ï–õ–¨–ù–û–°–¢–ò:
- –£—á–∏—Ç—ã–≤–∞–π –¢–û–õ–¨–ö–û —Å–æ–±—ã—Ç–∏—è –ü–û–°–õ–ï –≤—Ä–µ–º–µ–Ω–∏ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
- –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –æ—Ç–∫–∞–∑—ã–≤–∞–ª—Å—è –î–û —Å–æ–∑–¥–∞–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è - —ç—Ç–æ –ù–ï –ü–†–ò–ß–ò–ù–ê –¥–ª—è –æ—Ç–º–µ–Ω—ã
- –ö–ª—é—á–µ–≤–æ–µ –ø–æ–Ω–∏–º–∞–Ω–∏–µ: –∫–∞–∂–¥–æ–µ –Ω–æ–≤–æ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ = –Ω–æ–≤—ã–π –¥–æ–≥–æ–≤–æ—Ä —Å –∫–ª–∏–µ–Ω—Ç–æ–º

üìã –°–¶–ï–ù–ê–†–ò–ô "–ü–ï–†–ï–ü–û–°–¢–ê–ù–û–í–ö–ò –ü–û–°–õ–ï –û–¢–ö–ê–ó–ê":
–ü—Ä–∏–º–µ—Ä:
1. –ë–æ—Ç: "–ù–∞–ø–æ–º–Ω—é —á–µ—Ä–µ–∑ –º–µ—Å—è—Ü" 
2. –ö–ª–∏–µ–Ω—Ç: "–ù–µ—Ç, –Ω–µ –ø–∏—à–∏—Ç–µ" (–æ—Ç–∫–∞–∑ –æ—Ç –ø–µ—Ä–≤–æ–≥–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)
3. –ë–æ—Ç: "–ê —á–µ—Ä–µ–∑ 3 –º–µ—Å—è—Ü–∞?"
4. –ö–ª–∏–µ–Ω—Ç: "–î–∞, –æ–∫" (—Å–æ–≥–ª–∞—Å–∏–µ –Ω–∞ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—É)
‚Üí –°–æ–∑–¥–∞–µ—Ç—Å—è –ù–û–í–û–ï –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –Ω–∞ 3 –º–µ—Å—è—Ü–∞

‚úÖ –ö–ê–ö –ê–ù–ê–õ–ò–ó–ò–†–û–í–ê–¢–¨:
- –í—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è: –∫–æ–≥–¥–∞ –∫–ª–∏–µ–Ω—Ç —Å–∫–∞–∑–∞–ª "–î–∞, –æ–∫"
- –û—Ç–∫–∞–∑ "–ù–µ—Ç, –Ω–µ –ø–∏—à–∏—Ç–µ" –±—ã–ª –î–û —Å–æ–∑–¥–∞–Ω–∏—è ‚Üí –ù–ï —É—á–∏—Ç—ã–≤–∞–π
- –°–æ–≥–ª–∞—Å–∏–µ "–î–∞, –æ–∫" –ø—Ä–∏–≤–µ–ª–æ –∫ —Å–æ–∑–¥–∞–Ω–∏—é ‚Üí —ç—Ç–æ –∞–∫—Ç—É–∞–ª—å–Ω—ã–π –¥–æ–≥–æ–≤–æ—Ä
- –ê–ö–¢–ò–í–ò–†–£–ô –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ, –Ω–µ—Å–º–æ—Ç—Ä—è –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏–π –æ—Ç–∫–∞–∑

üîç –ü–†–ê–ö–¢–ò–ß–ï–°–ö–ò–ô –ê–õ–ì–û–†–ò–¢–ú:
1. –ù–∞–π–¥–∏ –≤—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
2. –ê–Ω–∞–ª–∏–∑–∏—Ä—É–π –¢–û–õ–¨–ö–û —Å–æ–æ–±—â–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞ –ü–û–°–õ–ï —ç—Ç–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
3. –ò–≥–Ω–æ—Ä–∏—Ä—É–π –æ—Ç–∫–∞–∑—ã –î–û —Å–æ–∑–¥–∞–Ω–∏—è –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
4. –ò—â–∏ –Ω–æ–≤—ã–µ –æ—Ç–∫–∞–∑—ã –∏–ª–∏ –æ—Ç–º–µ–Ω—ã –ü–û–°–õ–ï —Å–æ–∑–¥–∞–Ω–∏—è

üìÖ –ö–ê–ö –†–ê–ë–û–¢–ê–¢–¨ –° –í–†–ï–ú–ï–ù–ù–´–ú–ò –ú–ï–¢–ö–ê–ú–ò:
- –ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç –º–µ—Ç–∫–∏ –≤—Ä–µ–º–µ–Ω–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ [YYYY-MM-DD HH:MM:SS]
- –í—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è —É–∫–∞–∑–∞–Ω–æ –≤—ã—à–µ –≤ —Ä–∞–∑–¥–µ–ª–µ "–ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –ù–ê–ü–û–ú–ò–ù–ê–ù–ò–ò"
- –°—Ä–∞–≤–Ω–∏–≤–∞–π –≤—Ä–µ–º—è —Å–æ–æ–±—â–µ–Ω–∏–π —Å –≤—Ä–µ–º–µ–Ω–µ–º —Å–æ–∑–¥–∞–Ω–∏—è –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
- –£—á–∏—Ç—ã–≤–∞–π –¢–û–õ–¨–ö–û —Å–æ–æ–±—â–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞ –ü–û–°–õ–ï –≤—Ä–µ–º–µ–Ω–∏ —Å–æ–∑–¥–∞–Ω–∏—è

üí° –ü–†–ò–ú–ï–† –ê–ù–ê–õ–ò–ó–ê –•–†–û–ù–û–õ–û–ì–ò–ò:
–í—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è: 2024-01-15 14:33:15
–ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞:
[2024-01-15 14:30:00] –ë–æ—Ç: –î–∞–≤–∞–π—Ç–µ —è –í–∞–º –Ω–∞–ø–æ–º–Ω—é —á–µ—Ä–µ–∑ –º–µ—Å—è—Ü
[2024-01-15 14:31:00] –ö–ª–∏–µ–Ω—Ç: –ù–µ—Ç, –Ω–µ –ø–∏—à–∏—Ç–µ ‚Üê –î–û —Å–æ–∑–¥–∞–Ω–∏—è (–∏–≥–Ω–æ—Ä–∏—Ä—É–π)
[2024-01-15 14:32:00] –ë–æ—Ç: –ê —á—Ç–æ –µ—Å–ª–∏ —á–µ—Ä–µ–∑ 3 –º–µ—Å—è—Ü–∞?
[2024-01-15 14:33:00] –ö–ª–∏–µ–Ω—Ç: –î–∞, –æ–∫ ‚Üê –ø—Ä–∏–≤–µ–ª–æ –∫ —Å–æ–∑–¥–∞–Ω–∏—é –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
[2024-01-15 14:35:00] –ö–ª–∏–µ–Ω—Ç: –°–ø–∞—Å–∏–±–æ ‚Üê –ü–û–°–õ–ï —Å–æ–∑–¥–∞–Ω–∏—è (—É—á–∏—Ç—ã–≤–∞–π)

‚Üí –†–ï–®–ï–ù–ò–ï: –ê–ö–¢–ò–í–ò–†–£–ô (–æ—Ç–∫–∞–∑ –±—ã–ª –¥–æ —Å–æ–∑–¥–∞–Ω–∏—è, —Å–æ–≥–ª–∞—Å–∏–µ –ø—Ä–∏–≤–µ–ª–æ –∫ —Å–æ–∑–¥–∞–Ω–∏—é)

–í–ï–†–ù–ò –û–¢–í–ï–¢ –°–¢–†–û–ì–û –í –§–û–†–ú–ê–¢–ï JSON:
{{
  "should_activate": true/false,
  "reason": "–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ —Ä–µ—à–µ–Ω–∏—è —Å —É–∫–∞–∑–∞–Ω–∏–µ–º —Ç–∏–ø–∞ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –∏ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ —Ñ–∞–∫—Ç–æ–≤",
  "suggested_action": "cancel/postpone/activate",
  "postpone_to": "YYYY-MM-DDTHH:MM:SS (–≤ —á–∞—Å–æ–≤–æ–º –ø–æ—è—Å–µ –∫–ª–∏–µ–Ω—Ç–∞, –∫–æ—Ç–æ—Ä—ã–π —Ä–∞–≤–µ–Ω {client_timezone})"
}}
"""

# --- –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ---

def setup_logging():
    """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–∏—Å—Ç–µ–º—ã –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è."""
    logging.basicConfig(
        level=logging.INFO,
        format='%(asctime)s - %(levelname)s - %(funcName)s - %(message)s',
        handlers=[
            logging.FileHandler(LOG_FILE_NAME, mode='a', encoding='utf-8'),
            logging.StreamHandler(sys.stdout)
        ]
    )

def get_db_connection():
    """–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –ë–î."""
    if not DATABASE_URL:
        raise ConnectionError("–ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–∫—Ä—É–∂–µ–Ω–∏—è DATABASE_URL –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞!")
    return psycopg2.connect(DATABASE_URL)

def call_gemini_api(model, prompt, expect_json=True):
    """–í—ã–∑—ã–≤–∞–µ—Ç –º–æ–¥–µ–ª—å Gemini —á–µ—Ä–µ–∑ Vertex AI SDK."""
    try:
        # logging.info(f"–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –≤ Gemini. –ü—Ä–æ–º–ø—Ç (–ø–µ—Ä–≤—ã–µ 200 —Å–∏–º–≤–æ–ª–æ–≤): {prompt[:200]}...")
        
        response = model.generate_content(prompt)
        raw_response = response.text
        
        # logging.info(f"–ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç –æ—Ç Gemini (–¥–ª–∏–Ω–∞: {len(raw_response)} —Å–∏–º–≤–æ–ª–æ–≤)")
        # logging.info(f"–°—ã—Ä–æ–π –æ—Ç–≤–µ—Ç –æ—Ç Gemini: {raw_response}")
        
        if expect_json:
            # –£–ª—É—á—à–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è JSON –∏–∑ –æ—Ç–≤–µ—Ç–∞
            # –°–Ω–∞—á–∞–ª–∞ –∏—â–µ–º JSON –≤ markdown-–±–ª–æ–∫–µ
            match = re.search(r"```(json)?\s*([\s\S]*?)\s*```", raw_response)
            if match:
                json_str = match.group(2)
            else:
                # –ï—Å–ª–∏ markdown-–±–ª–æ–∫–∞ –Ω–µ—Ç, –∏—â–µ–º –ø–µ—Ä–≤—ã–π —Å–∏–º–≤–æ–ª '{' –∏–ª–∏ '['
                start_index = -1
                for i, char in enumerate(raw_response):
                    if char in ('{', '['):
                        start_index = i
                        break
                if start_index != -1:
                    json_str = raw_response[start_index:]
                else:
                    json_str = raw_response
            
            # –£–¥–∞–ª—è–µ–º —É–ø—Ä–∞–≤–ª—è—é—â–∏–µ —Å–∏–º–≤–æ–ª—ã –≤ –Ω–∞—á–∞–ª–µ —Å—Ç—Ä–æ–∫–∏, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
            json_str = json_str.strip()

            parsed_response = json.loads(json_str)
            # logging.info(f"JSON —É—Å–ø–µ—à–Ω–æ —Ä–∞—Å–ø–∞—Ä—Å–µ–Ω: {parsed_response}")
            return parsed_response
        else:
            return raw_response.strip()

    except json.JSONDecodeError as je:
        logging.error(f"–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON –æ—Ç Gemini: {je}. –°—ã—Ä–æ–π –æ—Ç–≤–µ—Ç: {raw_response}")
        raise
    except Exception as e:
        logging.error(f"–û—à–∏–±–∫–∞ –≤—ã–∑–æ–≤–∞ Vertex AI API: {e}", exc_info=True)
        raise

def get_moscow_time():
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—É—â–µ–µ –º–æ—Å–∫–æ–≤—Å–∫–æ–µ –≤—Ä–µ–º—è."""
    moscow_tz = pytz.timezone('Europe/Moscow')
    return datetime.now(moscow_tz)

def parse_datetime_with_timezone(datetime_str, client_timezone='Europe/Moscow'):
    """–ü–∞—Ä—Å–∏—Ç —Å—Ç—Ä–æ–∫—É –¥–∞—Ç—ã/–≤—Ä–µ–º–µ–Ω–∏ —Å —É—á–µ—Ç–æ–º —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å–∞ –∫–ª–∏–µ–Ω—Ç–∞."""
    try:
        # –ï—Å–ª–∏ –¥–∞—Ç–∞ —É–∂–µ —Å–æ–¥–µ—Ä–∂–∏—Ç timezone info
        if '+' in datetime_str or 'Z' in datetime_str:
            return datetime.fromisoformat(datetime_str.replace('Z', '+00:00'))
        
        # –ò–Ω–∞—á–µ —Å—á–∏—Ç–∞–µ–º, —á—Ç–æ –≤—Ä–µ–º—è –≤ —á–∞—Å–æ–≤–æ–º –ø–æ—è—Å–µ –∫–ª–∏–µ–Ω—Ç–∞
        tz = pytz.timezone(client_timezone)
        naive_dt = datetime.fromisoformat(datetime_str)
        return tz.localize(naive_dt)
    except Exception as e:
        logging.error(f"–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –¥–∞—Ç—ã '{datetime_str}': {e}")
        raise

# --- –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò ---

def analyze_dialogue_for_reminders(conn, conv_id, model):
    """
    –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–∏–∞–ª–æ–≥–∞ –¥–ª—è –≤—ã—è–≤–ª–µ–Ω–∏—è –¥–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç–µ–π –æ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–∏.
    """
    try:
        logging.info(f"–ù–∞—á–∞—Ç –∞–Ω–∞–ª–∏–∑ –Ω–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –¥–ª—è conv_id={conv_id}")
        with conn.cursor(cursor_factory=psycopg2.extras.DictCursor) as cur:
            # –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–∏–∞–ª–æ–≥–∞ (—É–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–æ 10 —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
            message_limit = 10  # –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–æ –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            
            cur.execute("""
                SELECT role, message, created_at 
                FROM dialogues 
                WHERE conv_id = %s 
                ORDER BY created_at DESC 
                LIMIT %s
            """, (conv_id, message_limit))
            messages = cur.fetchall()
            
            if not messages:
                logging.info(f"–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –≤ –¥–∏–∞–ª–æ–≥–µ {conv_id}")
                return None
            
            # –î–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ —Ñ–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Å–≤–µ–∂–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
            if conv_id == ADMIN_CONV_ID:
                # –ë–µ—Ä–µ–º —Ç–æ–ª—å–∫–æ —Å–æ–æ–±—â–µ–Ω–∏—è –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 –º–∏–Ω—É—Ç
                cutoff_time = datetime.now(timezone.utc) - timedelta(minutes=10)
                
                # –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–æ–±–ª–µ–º—É —Å—Ä–∞–≤–Ω–µ–Ω–∏—è datetime —Å —Ä–∞–∑–Ω—ã–º–∏ timezone
                filtered_messages = []
                for msg in messages:
                    msg_time = msg['created_at']
                    # –ï—Å–ª–∏ –≤—Ä–µ–º—è –∏–∑ –ë–î –±–µ–∑ timezone, —Å—á–∏—Ç–∞–µ–º –µ–≥–æ UTC
                    if msg_time.tzinfo is None:
                        msg_time = msg_time.replace(tzinfo=timezone.utc)
                    
                    if msg_time > cutoff_time:
                        filtered_messages.append(msg)
                
                messages = filtered_messages
                
                if not messages:
                    logging.info(f"–ù–µ—Ç —Å–≤–µ–∂–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (–∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 –º–∏–Ω—É—Ç) –æ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ {conv_id}")
                    return None
                
                logging.info(f"–ê–Ω–∞–ª–∏–∑ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞: –Ω–∞–π–¥–µ–Ω–æ {len(messages)} —Å–≤–µ–∂–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 –º–∏–Ω—É—Ç")
            
            # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –ø—Ä–æ–º–ø—Ç–∞
            dialogue_text = []
            for msg in reversed(messages):
                role_map = {'user': '–ö–ª–∏–µ–Ω—Ç', 'bot': '–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç', 'operator': '–û–ø–µ—Ä–∞—Ç–æ—Ä'}
                role = role_map.get(msg['role'], msg['role'])
                message_text = re.sub(r'^\[.*?\]\s*', '', msg['message'])
                
                # –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –î–æ–±–∞–≤–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–∫–∏ –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è —Ö—Ä–æ–Ω–æ–ª–æ–≥–∏–∏ (—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å –∞–≥–µ–Ω—Ç–æ–º –∞–∫—Ç–∏–≤–∞—Ü–∏–∏)
                timestamp = msg['created_at'].strftime('%Y-%m-%d %H:%M:%S') if msg['created_at'] else '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'
                dialogue_text.append(f"[{timestamp}] {role}: {message_text}")
            
            # –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞
            cur.execute("""
                SELECT reminder_datetime, reminder_context_summary 
                FROM reminders 
                WHERE conv_id = %s AND status = 'active'
                ORDER BY reminder_datetime
            """, (conv_id,))
            active_reminders = cur.fetchall()
            
            reminders_text = []
            for rem in active_reminders:
                reminders_text.append(f"- {rem['reminder_datetime']}: {rem['reminder_context_summary']}")
            
            # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–ª–∏–µ–Ω—Ç–µ –∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ–º —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å
            cur.execute("""
                SELECT first_name, last_name, city 
                FROM user_profiles 
                WHERE conv_id = %s
            """, (conv_id,))
            profile_result = cur.fetchone()
            
            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å –∫–ª–∏–µ–Ω—Ç–∞
            client_timezone = 'Europe/Moscow'  # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –º–æ—Å–∫–æ–≤—Å–∫–æ–µ –≤—Ä–µ–º—è
            if profile_result and profile_result['city']:
                client_timezone = get_timezone_by_city(profile_result['city'])
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —É–∫–∞–∑–∞–Ω –ª–∏ –≤ —Å–æ–æ–±—â–µ–Ω–∏—è—Ö –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å
            for msg in messages:
                if msg['role'] == 'user':  # –¢–æ–ª—å–∫–æ —Å–æ–æ–±—â–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞
                    explicit_timezone = detect_timezone_from_message(msg['message'])
                    if explicit_timezone:
                        client_timezone = explicit_timezone
                        break  # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π —è–≤–Ω–æ —É–∫–∞–∑–∞–Ω–Ω—ã–π —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å
            
            # –§–æ—Ä–º–∏—Ä—É–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–µ–∫—É—â–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –¥–ª—è –ø—Ä–æ–º–ø—Ç–∞
            user_info = ""
            if profile_result:
                full_name = f"{profile_result['first_name']} {profile_result['last_name']}".strip()
                city = profile_result.get('city', '')
                user_info = f"–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–µ–∫—É—â–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ: conv_id={conv_id}, –∏–º—è='{full_name}'"
                if city:
                    user_info += f", –≥–æ—Ä–æ–¥='{city}'"
                user_info += f", —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å={client_timezone}"
                if conv_id == ADMIN_CONV_ID:
                    user_info += " (–ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–û–†)"
                    logging.info(f"=== –ê–ù–ê–õ–ò–ó –°–û–û–ë–©–ï–ù–ò–ô –ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–û–†–ê ===")
                    logging.info(f"–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ (conv_id={ADMIN_CONV_ID})")
                    # –õ–æ–≥–∏—Ä—É–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ
                    user_messages = [msg for msg in messages if msg['role'] == 'user']
                    if user_messages:
                        last_user_msg = user_messages[0]  # –°–∞–º–æ–µ –ø–æ—Å–ª–µ–¥–Ω–µ–µ
                        logging.info(f"–ü–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: '{last_user_msg['message']}'")
                    logging.info("=== –ö–û–ù–ï–¶ –ê–ù–ê–õ–ò–ó–ê –ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–û–†–ê ===")
            else:
                user_info = f"conv_id={conv_id}, —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å={client_timezone}"
            
            # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–∫—É–ø–∫–∞—Ö –∫–ª–∏–µ–Ω—Ç–∞
            cur.execute("""
                SELECT product_name, purchase_date, amount
                FROM client_purchases 
                WHERE conv_id = %s
                ORDER BY purchase_date DESC
                LIMIT 5
            """, (conv_id,))
            
            purchases = cur.fetchall()
            purchases_text = []
            if purchases:
                for purchase in purchases:
                    date_str = purchase['purchase_date'].strftime('%Y-%m-%d %H:%M') if purchase['purchase_date'] else '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'
                    amount_str = f" –Ω–∞ —Å—É–º–º—É {purchase['amount']}" if purchase.get('amount') else ""
                    purchases_text.append(f"- {purchase['product_name']} (–¥–∞—Ç–∞: {date_str}{amount_str})")
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–µ–¥–∞–≤–Ω–∏–µ –ø–æ–∫—É–ø–∫–∏
                current_analysis_time = datetime.now(timezone.utc)
                recent_purchases = []
                for p in purchases:
                    if p['purchase_date']:
                        purchase_time = p['purchase_date']
                        # –ï—Å–ª–∏ –≤—Ä–µ–º—è –∏–∑ –ë–î –±–µ–∑ timezone, —Å—á–∏—Ç–∞–µ–º –µ–≥–æ UTC
                        if purchase_time.tzinfo is None:
                            purchase_time = purchase_time.replace(tzinfo=timezone.utc)
                        
                        time_diff = (current_analysis_time - purchase_time).total_seconds()
                        if time_diff < 86400:  # 24 —á–∞—Å–∞
                            recent_purchases.append(p)
                if recent_purchases:
                    purchases_text.append("\n‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: –ï—Å—Ç—å –ø–æ–∫—É–ø–∫–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 24 —á–∞—Å–∞!")

            # –§–æ—Ä–º–∏—Ä—É–µ–º –ø—Ä–æ–º–ø—Ç
            prompt = PROMPT_ANALYZE_DIALOGUE.format(
                admin_conv_id=ADMIN_CONV_ID,
                current_datetime=get_moscow_time().strftime("%Y-%m-%d %H:%M:%S"),
                conv_id=conv_id,
                user_info=user_info,
                dialogue_messages="\n".join(dialogue_text),
                active_reminders="\n".join(reminders_text) if reminders_text else "–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π",
                client_purchases="\n".join(purchases_text) if purchases_text else "–ù–µ—Ç –ø–æ–∫—É–ø–æ–∫"
            )
            
            # –õ–æ–≥–∏—Ä—É–µ–º –ø–æ–ª–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
            logging.info(f"=== –ü–û–õ–ù–´–ô –ü–†–û–ú–ü–¢ –î–õ–Ø –ê–ù–ê–õ–ò–ó–ê –î–ò–ê–õ–û–ì–ê {conv_id} ===")
            logging.info(prompt)
            logging.info("=== –ö–û–ù–ï–¶ –ü–†–û–ú–ü–¢–ê ===")
            
            # –í—ã–∑—ã–≤–∞–µ–º AI –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
            result = call_gemini_api(model, prompt, expect_json=True)
            
            # ===== –î–û–ë–ê–í–õ–Ø–ï–ú –î–ï–¢–ê–õ–¨–ù–û–ï –õ–û–ì–ò–†–û–í–ê–ù–ò–ï =====
            logging.info(f"=== –ü–û–õ–ù–´–ô –û–¢–í–ï–¢ AI –î–õ–Ø –î–ò–ê–õ–û–ì–ê {conv_id} ===")
            logging.info(f"–°—ã—Ä–æ–π –æ—Ç–≤–µ—Ç AI: {json.dumps(result, ensure_ascii=False, indent=2)}")
            logging.info("=== –ö–û–ù–ï–¶ –û–¢–í–ï–¢–ê AI ===")
            
            # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–µ—Ç –±—ã—Ç—å —Å–ø–∏—Å–∫–æ–º –∏–ª–∏ —Å–ª–æ–≤–∞—Ä–µ–º
            reminders_to_process = []
            if isinstance(result, list):
                reminders_to_process = result
            elif isinstance(result, dict):
                reminders_to_process = result.get('reminders', [])

            logging.info(f"–ê–ù–ê–õ–ò–ó –î–ò–ê–õ–û–ì–ê {conv_id}: AI –≤–µ—Ä–Ω—É–ª {len(reminders_to_process)} –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π")

            if reminders_to_process:
                processed_reminders = []
                
                # ===== –î–û–ë–ê–í–õ–Ø–ï–ú –ü–†–û–í–ï–†–ö–£ –ù–ê –î–£–ë–õ–ò–ö–ê–¢–´ –í–ù–£–¢–†–ò –û–î–ù–û–ì–û –û–¢–í–ï–¢–ê =====
                unique_reminders = {}  # –∫–ª—é—á: (target_conv_id, summary_hash), –∑–Ω–∞—á–µ–Ω–∏–µ: reminder_data
                
                for i, reminder_data in enumerate(reminders_to_process):
                    logging.info(f"–ê–ù–ê–õ–ò–ó –î–ò–ê–õ–û–ì–ê {conv_id}: –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ {i+1}: {reminder_data}")
                    
                    if reminder_data.get('action') != 'none':
                        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å target_conv_id
                        target_conv_id = reminder_data.get('target_conv_id')
                        if not target_conv_id:
                            logging.warning(f"–û–¢–ö–õ–û–ù–ï–ù–û –ù–ê–ü–û–ú–ò–ù–ê–ù–ò–ï {conv_id}: –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç target_conv_id: {reminder_data}")
                            continue
                        
                        # –°–æ–∑–¥–∞–µ–º –∫–ª—é—á –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –≤–Ω—É—Ç—Ä–∏ –æ–¥–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ AI
                        summary = reminder_data.get('reminder_context_summary', '').lower().strip()
                        summary_hash = hash(summary)
                        duplicate_key = (target_conv_id, summary_hash)
                        
                        if duplicate_key in unique_reminders:
                            logging.warning(f"–î–£–ë–õ–ò–ö–ê–¢ –í –û–¢–í–ï–¢–ï AI {conv_id}: –û–±–Ω–∞—Ä—É–∂–µ–Ω –¥—É–±–ª–∏–∫–∞—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –¥–ª—è target_conv_id={target_conv_id}, summary='{summary}'. –ü—Ä–æ–ø—É—Å–∫–∞—é.")
                            continue
                        
                        unique_reminders[duplicate_key] = reminder_data
                        
                        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —Å–æ–∑–¥–∞–µ–º –ª–∏ –º—ã –¥—É–±–ª–∏—Ä—É—é—â–µ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏
                        if reminder_data.get('action') == 'create' and active_reminders:
                            new_summary = summary
                            is_duplicate = False
                            
                            logging.info(f"–ü–†–û–í–ï–†–ö–ê –î–£–ë–õ–ò–ö–ê–¢–û–í {conv_id}: –ù–æ–≤–æ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ '{new_summary}' –ø—Ä–æ—Ç–∏–≤ {len(active_reminders)} —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö")
                            
                            for existing in active_reminders:
                                existing_summary = existing['reminder_context_summary'].lower()
                                # –ü—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å—Ö–æ–∂–µ—Å—Ç—å (–±–æ–ª–µ–µ 50% –æ–±—â–∏—Ö —Å–ª–æ–≤)
                                new_words = set(new_summary.split())
                                existing_words = set(existing_summary.split())
                                intersection = new_words & existing_words
                                
                                if new_words and existing_words:
                                    similarity = len(intersection) / len(new_words)
                                    logging.info(f"–°–†–ê–í–ù–ï–ù–ò–ï –î–£–ë–õ–ò–ö–ê–¢–û–í {conv_id}: '{new_summary}' vs '{existing_summary}' - —Å—Ö–æ–∂–µ—Å—Ç—å {similarity:.2f}")
                                    
                                    if similarity > 0.5:
                                        logging.info(f"–î–£–ë–õ–ò–ö–ê–¢ –ù–ê–ô–î–ï–ù {conv_id}: –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ –¥—É–±–ª–∏—Ä—É—é—â–µ–≥–æ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è '{new_summary}'")
                                        is_duplicate = True
                                        break
                                        
                            if is_duplicate:
                                continue
                        
                        # –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
                        if conv_id == ADMIN_CONV_ID:
                            summary = reminder_data.get('reminder_context_summary', '').lower()
                            # –û—Ç–∫–ª–æ–Ω—è–µ–º –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –ø–æ –∂–∞–ª–æ–±–∞–º –Ω–∞ –æ—à–∏–±–∫–∏
                            if any(word in summary for word in ['–æ—à–∏–±–∫', '–∑–∞–ø—É—Ç–∞–ª', '–ø–æ—Å—Ç–∞–≤–∏–ª', '–ø—Ä–æ–±–ª–µ–º', '–±–∞–≥']):
                                logging.info(f"–§–ò–õ–¨–¢–† –ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–û–†–ê {conv_id}: –ü—Ä–æ–ø—É—Å–∫–∞—é –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –ø–æ –∂–∞–ª–æ–±–µ/–æ—à–∏–±–∫–µ: '{summary}'")
                                continue
                        
                        reminder_data['client_timezone'] = client_timezone
                        logging.info(f"–ü–†–ò–ù–Ø–¢–û –ù–ê–ü–û–ú–ò–ù–ê–ù–ò–ï {conv_id}: {reminder_data}")
                        processed_reminders.append(reminder_data)
                    else:
                        none_reason = reminder_data.get('none_reason', '–ø—Ä–∏—á–∏–Ω–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞')
                        logging.info(f"–ü–†–û–ü–£–©–ï–ù–û –ù–ê–ü–û–ú–ò–ù–ê–ù–ò–ï {conv_id}: action='none' - {none_reason}")

                if processed_reminders:
                    logging.info(f"–ò–¢–û–ì –ê–ù–ê–õ–ò–ó–ê {conv_id}: –ü—Ä–∏–Ω—è—Ç–æ {len(processed_reminders)} –∏–∑ {len(reminders_to_process)} –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤")
                return processed_reminders if processed_reminders else None
            
            logging.info(f"–ê–ù–ê–õ–ò–ó –î–ò–ê–õ–û–ì–ê {conv_id}: –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã")
            return None
            
    except Exception as e:
        logging.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ –¥–∏–∞–ª–æ–≥–∞ {conv_id}: {e}", exc_info=True)
        return None

def create_or_update_reminder(conn, conv_id, reminder_data, created_by_conv_id=None):
    """
    –°–æ–∑–¥–∞–µ—Ç –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –≤ –ë–î.
    """
    try:
        with conn.cursor() as cur:
            action = reminder_data.get('action')
            target_conv_id = reminder_data.get('target_conv_id', conv_id)
            
            # ===== –î–û–ë–ê–í–õ–Ø–ï–ú –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–£–Æ –í–ê–õ–ò–î–ê–¶–ò–Æ =====
            if action == 'create':
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å target_conv_id
                if not target_conv_id or target_conv_id == 0:
                    logging.error(f"–û–¢–ö–õ–û–ù–ï–ù–û –°–û–ó–î–ê–ù–ò–ï –ù–ê–ü–û–ú–ò–ù–ê–ù–ò–Ø {conv_id}: –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π target_conv_id={target_conv_id}")
                    return
                
                # –õ–æ–≥–∏—Ä—É–µ–º –¥–µ—Ç–∞–ª–∏ —Å–æ–∑–¥–∞–Ω–∏—è
                logging.info(f"–°–û–ó–î–ê–ù–ò–ï –ù–ê–ü–û–ú–ò–ù–ê–ù–ò–Ø: conv_id={conv_id}, target_conv_id={target_conv_id}, created_by={created_by_conv_id}")
                logging.info(f"–î–ï–¢–ê–õ–ò –ù–ê–ü–û–ú–ò–ù–ê–ù–ò–Ø: {reminder_data}")
                
                # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ—Ö–æ–∂–∏–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
                summary = reminder_data.get('reminder_context_summary', '').strip()
                if summary:
                    cur.execute("""
                        SELECT id, reminder_context_summary, reminder_datetime
                        FROM reminders 
                        WHERE conv_id = %s AND status = 'active'
                        AND similarity(reminder_context_summary, %s) > 0.6
                        ORDER BY created_at DESC
                        LIMIT 3
                    """, (target_conv_id, summary))
                    
                    similar_reminders = cur.fetchall()
                    if similar_reminders:
                        logging.warning(f"–ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï {conv_id}: –ù–∞–π–¥–µ–Ω—ã –ø–æ—Ö–æ–∂–∏–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –¥–ª—è target_conv_id={target_conv_id}:")
                        for similar in similar_reminders:
                            logging.warning(f"  - ID={similar[0]}: '{similar[1]}' –Ω–∞ {similar[2]}")
                        
                        # –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –±–æ–ª–µ–µ —Å—Ç—Ä–æ–≥—É—é –ø—Ä–æ–≤–µ—Ä–∫—É, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
                        # return  # –†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–ª—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ—Ö–æ–∂–∏—Ö –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π
                
                # –ü–∞—Ä—Å–∏–º –¥–∞—Ç—É/–≤—Ä–µ–º—è —Å —É—á–µ—Ç–æ–º —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å–∞
                reminder_dt = parse_datetime_with_timezone(
                    reminder_data['proposed_datetime'],
                    reminder_data.get('client_timezone', 'Europe/Moscow')
                )
                
                # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—Ä–æ—à–µ–¥—à–µ–µ –≤—Ä–µ–º—è
                if reminder_dt < datetime.now(timezone.utc):
                    logging.warning(f"–ü–æ–ø—ã—Ç–∫–∞ —Å–æ–∑–¥–∞—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –Ω–∞ –ø—Ä–æ—à–µ–¥—à–µ–µ –≤—Ä–µ–º—è ({reminder_dt}) –¥–ª—è conv_id={target_conv_id}. –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –Ω–µ –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω–æ.")
                    return
                
                # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ
                cur.execute("""
                    INSERT INTO reminders (
                        conv_id, reminder_datetime, reminder_context_summary,
                        created_by_conv_id, client_timezone, status
                    ) VALUES (%s, %s, %s, %s, %s, 'active')
                    RETURNING id
                """, (
                    target_conv_id,
                    reminder_dt,
                    reminder_data['reminder_context_summary'],
                    created_by_conv_id or conv_id,
                    reminder_data.get('client_timezone', 'Europe/Moscow')
                ))
                
                reminder_id = cur.fetchone()[0]
                conn.commit()
                logging.info(f"‚úÖ –°–û–ó–î–ê–ù–û –ù–ê–ü–û–ú–ò–ù–ê–ù–ò–ï ID={reminder_id} –¥–ª—è target_conv_id={target_conv_id} (—Å–æ–∑–¥–∞–ª conv_id={created_by_conv_id or conv_id})")
                
            elif action == 'cancel':
                # –û—Ç–º–µ–Ω—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
                cancellation_source = 'admin' if conv_id == ADMIN_CONV_ID else 'user'
                
                cur.execute("""
                    UPDATE reminders 
                    SET status = %s, cancellation_reason = %s
                    WHERE conv_id = %s AND status = 'active'
                """, (
                    f'cancelled_by_{cancellation_source}',
                    reminder_data.get('cancellation_reason', '–û—Ç–º–µ–Ω–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º'),
                    target_conv_id
                ))
                
                affected = cur.rowcount
                conn.commit()
                if affected > 0:
                    logging.info(f"–û—Ç–º–µ–Ω–µ–Ω–æ {affected} –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –¥–ª—è conv_id={target_conv_id}")
                
            elif action == 'update':
                # –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ
                reminder_dt = parse_datetime_with_timezone(
                    reminder_data['proposed_datetime'],
                    reminder_data.get('client_timezone', 'Europe/Moscow')
                )
                
                # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—Ä–æ—à–µ–¥—à–µ–µ –≤—Ä–µ–º—è
                if reminder_dt < datetime.now(timezone.utc):
                    logging.warning(f"–ü–æ–ø—ã—Ç–∫–∞ –æ–±–Ω–æ–≤–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –Ω–∞ –ø—Ä–æ—à–µ–¥—à–µ–µ –≤—Ä–µ–º—è ({reminder_dt}) –¥–ª—è conv_id={target_conv_id}. –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –Ω–µ –±—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–æ.")
                    return
                
                cur.execute("""
                    UPDATE reminders 
                    SET reminder_datetime = %s, reminder_context_summary = %s
                    WHERE id = (
                        SELECT id FROM reminders
                        WHERE conv_id = %s AND status = 'active'
                        ORDER BY created_at DESC
                        LIMIT 1
                    )
                """, (
                    reminder_dt,
                    reminder_data['reminder_context_summary'],
                    target_conv_id
                ))
                
                conn.commit()
                logging.info(f"–û–±–Ω–æ–≤–ª–µ–Ω–æ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –¥–ª—è conv_id={target_conv_id}")
                
    except Exception as e:
        conn.rollback()
        logging.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è: {e}", exc_info=True)
        raise

def process_reminder_batch(reminders, model):
    """
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–∞—á–∫—É –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –¥–ª—è –æ–¥–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    """
    if not reminders:
        return

    conv_id = reminders[0]['conv_id']
    logging.info(f"–û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–∞—á–∫–∏ –∏–∑ {len(reminders)} –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –¥–ª—è conv_id={conv_id}")

    activated_contexts = []
    activated_ids = []
    cancelled_ids = []

    # –≠—Ç–∞–ø 1: –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥–æ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –Ω–∞ —É–º–µ—Å—Ç–Ω–æ—Å—Ç—å –∞–∫—Ç–∏–≤–∞—Ü–∏–∏
    for reminder in reminders:
        try:
            # –ü–µ—Ä–µ–¥–∞–µ–º –¥—Ä—É–≥–∏–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –∏–∑ –ø–∞—á–∫–∏ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏
            other_reminders_in_batch = [r for r in reminders if r['id'] != reminder['id']]
            result = process_single_reminder(reminder, model, activate_immediately=False, batch_context=other_reminders_in_batch)
            
            if result and result.get('status') == 'should_activate':
                activated_contexts.append(result['context'])
                activated_ids.append(result['id'])
            elif result and result.get('status') == 'cancelled':
                cancelled_ids.append(result['id'])
                
        except Exception as e:
            logging.error(f"–ü–ê–ö–ï–¢–ù–ê–Ø –û–ë–†–ê–ë–û–¢–ö–ê –¥–ª—è conv_id={conv_id}: –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è ID={reminder['id']}: {e}")
            # –ü—Ä–∏ –æ—à–∏–±–∫–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–µ –¥–æ–±–∞–≤–ª—è–µ–º –≤ —Å–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏
            continue

    # –≠—Ç–∞–ø 2: –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å—ã –æ—Ç–º–µ–Ω–µ–Ω–Ω—ã—Ö –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π
    if cancelled_ids:
        conn = None
        try:
            conn = get_db_connection()
            logging.info(f"–ü–ê–ö–ï–¢–ù–ê–Ø –û–ë–†–ê–ë–û–¢–ö–ê –¥–ª—è conv_id={conv_id}: –û–±–Ω–æ–≤–ª—è—é —Å—Ç–∞—Ç—É—Å—ã –æ—Ç–º–µ–Ω–µ–Ω–Ω—ã—Ö –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π {cancelled_ids}")
            # –°—Ç–∞—Ç—É—Å—ã —É–∂–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã –≤ process_single_reminder, –ø—Ä–æ—Å—Ç–æ –ª–æ–≥–∏—Ä—É–µ–º
        except Exception as e:
            logging.error(f"–ü–ê–ö–ï–¢–ù–ê–Ø –û–ë–†–ê–ë–û–¢–ö–ê –¥–ª—è conv_id={conv_id}: –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –æ—Ç–º–µ–Ω–µ–Ω–Ω—ã–º–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è–º–∏: {e}")
        finally:
            if conn:
                conn.close()

    if not activated_contexts:
        logging.info(f"–í –ø–∞—á–∫–µ –¥–ª—è conv_id={conv_id} –Ω–µ—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏.")
        return

    # –≠—Ç–∞–ø 3: –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ
    logging.info(f"–ü–ê–ö–ï–¢–ù–ê–Ø –ê–ö–¢–ò–í–ê–¶–ò–Ø –¥–ª—è conv_id={conv_id}: –ó–∞–ø—É—Å–∫–∞—é –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—É—é –∞–∫—Ç–∏–≤–∞—Ü–∏—é –¥–ª—è {len(activated_ids)} –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π")
    
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ç–¥–µ–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫ –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏, —á—Ç–æ–±—ã –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫
    activation_thread = threading.Thread(
        target=_activate_reminders_async,
        args=(conv_id, activated_contexts, activated_ids),
        daemon=True
    )
    activation_thread.start()

def _activate_reminders_async(conv_id, activated_contexts, activated_ids):
    """
    –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –∞–∫—Ç–∏–≤–∞—Ü–∏—è –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ.
    """
    conn = None
    try:
        conn = get_db_connection()
        combined_context = f"–£ –≤–∞—Å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å—Ä–∞–±–æ—Ç–∞–≤—à–∏—Ö –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π:\n\n" + "\n".join([f"- {ctx}" for ctx in activated_contexts])

        port = os.environ.get("PORT", 8080)
        activate_url = f"http://127.0.0.1:{port}/activate_reminder"
        payload = {"conv_id": conv_id, "reminder_context_summary": combined_context}
        
        logging.info(f"–ê–°–ò–ù–•–†–û–ù–ù–ê–Ø –ê–ö–¢–ò–í–ê–¶–ò–Ø –¥–ª—è conv_id={conv_id} (ID: {activated_ids}): –û—Ç–ø—Ä–∞–≤–ª—è—é –∑–∞–ø—Ä–æ—Å –Ω–∞ {activate_url}")
        
        # –£–≤–µ–ª–∏—á–µ–Ω–Ω—ã–π —Ç–∞–π–º–∞—É—Ç –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è worker timeout
        response = requests.post(activate_url, json=payload, timeout=ACTIVATION_TIMEOUT)
        response.raise_for_status()
        
        response_text = response.text
        logging.info(f"–ê–°–ò–ù–•–†–û–ù–ù–ê–Ø –ê–ö–¢–ò–í–ê–¶–ò–Ø –¥–ª—è conv_id={conv_id}: –ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç. –°—Ç–∞—Ç—É—Å: {response.status_code}, –¢–µ–ª–æ: '{response_text}'")

        with conn.cursor() as cur:
            logging.info(f"–ê–°–ò–ù–•–†–û–ù–ù–ê–Ø –ê–ö–¢–ò–í–ê–¶–ò–Ø –¥–ª—è conv_id={conv_id} (ID: {activated_ids}): –û–±–Ω–æ–≤–ª—è—é —Å—Ç–∞—Ç—É—Å—ã –≤ –ë–î –Ω–∞ 'done'.")
            cur.execute("UPDATE reminders SET status = 'done' WHERE id = ANY(%s::int[])", (activated_ids,))
            conn.commit()
            logging.info(f"–ê–°–ò–ù–•–†–û–ù–ù–ê–Ø –ê–ö–¢–ò–í–ê–¶–ò–Ø –¥–ª—è conv_id={conv_id}: –£—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã —Å—Ç–∞—Ç—É—Å—ã –¥–ª—è {len(activated_ids)} –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π.")
            
    except requests.exceptions.Timeout as e:
        logging.error(f"–ê–°–ò–ù–•–†–û–ù–ù–ê–Ø –ê–ö–¢–ò–í–ê–¶–ò–Ø –¥–ª—è conv_id={conv_id}: –¢–ê–ô–ú–ê–£–¢. –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è {activated_ids} –±—É–¥—É—Ç –≤–æ–∑–≤—Ä–∞—â–µ–Ω—ã –≤ 'active'. –û—à–∏–±–∫–∞: {e}")
        _revert_reminder_statuses(activated_ids, "timeout")
        
    except requests.exceptions.RequestException as e:
        logging.error(f"–ê–°–ò–ù–•–†–û–ù–ù–ê–Ø –ê–ö–¢–ò–í–ê–¶–ò–Ø –¥–ª—è conv_id={conv_id}: –û–®–ò–ë–ö–ê HTTP. –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è {activated_ids} –±—É–¥—É—Ç –≤–æ–∑–≤—Ä–∞—â–µ–Ω—ã –≤ 'active'. –û—à–∏–±–∫–∞: {e}")
        _revert_reminder_statuses(activated_ids, f"http_error: {e}")
        
    except Exception as e:
        logging.error(f"–ê–°–ò–ù–•–†–û–ù–ù–ê–Ø –ê–ö–¢–ò–í–ê–¶–ò–Ø –¥–ª—è conv_id={conv_id}: –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê. –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è {activated_ids} –±—É–¥—É—Ç –≤–æ–∑–≤—Ä–∞—â–µ–Ω—ã –≤ 'active'. –û—à–∏–±–∫–∞: {e}", exc_info=True)
        _revert_reminder_statuses(activated_ids, f"critical_error: {e}")
        
    finally:
        if conn:
            conn.close()

def _revert_reminder_statuses(reminder_ids, reason):
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç–∞—Ç—É—Å—ã –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –æ–±—Ä–∞—Ç–Ω–æ –≤ 'active' –ø—Ä–∏ –æ—à–∏–±–∫–µ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏.
    """
    conn = None
    try:
        conn = get_db_connection()
        with conn.cursor() as cur:
            cur.execute(
                """
                UPDATE reminders 
                SET status = 'active', 
                    cancellation_reason = %s 
                WHERE id = ANY(%s::int[]) AND status = 'in_progress'
                """,
                (f"–ê–∫—Ç–∏–≤–∞—Ü–∏—è –Ω–µ —É–¥–∞–ª–∞—Å—å: {reason}", reminder_ids)
            )
            affected = cur.rowcount
            conn.commit()
            logging.info(f"–°—Ç–∞—Ç—É—Å {affected} –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π {reminder_ids} –≤–æ–∑–≤—Ä–∞—â–µ–Ω –≤ 'active' –∏–∑-–∑–∞: {reason}")
    except Exception as e_revert:
        logging.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å –≤–µ—Ä–Ω—É—Ç—å —Å—Ç–∞—Ç—É—Å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è–º {reminder_ids}: {e_revert}")
    finally:
        if conn:
            conn.close()

def check_and_activate_reminders(model):
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∏ –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç —Å–æ–∑—Ä–µ–≤—à–∏–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è, –≥—Ä—É–ø–ø–∏—Ä—É—è –∏—Ö –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º.
    """
    conn = None
    try:
        conn = get_db_connection()
        
        with conn.cursor(cursor_factory=psycopg2.extras.DictCursor) as cur:
            # –ü–æ–ª—É—á–∞–µ–º —Å–æ–∑—Ä–µ–≤—à–∏–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
            cur.execute("""
                SELECT id, conv_id, reminder_datetime, reminder_context_summary,
                       created_at, client_timezone
                FROM reminders 
                WHERE status = 'active' AND reminder_datetime <= NOW()
                ORDER BY conv_id, reminder_datetime
            """)
            
            reminders = cur.fetchall()
            
            if not reminders:
                logging.debug("–ù–µ—Ç —Å–æ–∑—Ä–µ–≤—à–∏—Ö –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π")
                return
            
            logging.info(f"–ù–∞–π–¥–µ–Ω–æ {len(reminders)} —Å–æ–∑—Ä–µ–≤—à–∏—Ö –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π. –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º.")

            # –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –ø–æ conv_id
            reminders_by_user = {k: list(g) for k, g in groupby(reminders, itemgetter('conv_id'))}

            for conv_id, user_reminders in reminders_by_user.items():
                try:
                    # –ë–ª–æ–∫–∏—Ä—É–µ–º –≤—Å–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –¥–ª—è —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    reminder_ids = [r['id'] for r in user_reminders]
                    cur.execute(
                        "UPDATE reminders SET status = 'in_progress' WHERE id = ANY(%s::int[])",
                        (reminder_ids,)
                    )
                    conn.commit()
                    
                    # –í—ã–±–∏—Ä–∞–µ–º, –∫–∞–∫ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å: –ø–æ –æ–¥–Ω–æ–º—É –∏–ª–∏ –ø–∞—á–∫–æ–π
                    if len(user_reminders) == 1:
                        target_func = process_single_reminder
                        args = (user_reminders[0], model)
                    else:
                        target_func = process_reminder_batch
                        args = (user_reminders, model)
                    
                    # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ
                    thread = threading.Thread(target=target_func, args=args, daemon=True)
                    thread.start()
                    
                except Exception as e:
                    logging.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –ø–∞—á–∫–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –¥–ª—è conv_id={conv_id}: {e}")
                    conn.rollback()
                    
    except Exception as e:
        logging.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π: {e}", exc_info=True)
    finally:
        if conn:
            conn.close()

def process_single_reminder(reminder, model, activate_immediately=True, batch_context=None):
    """
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ–¥–Ω–æ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ.
    –ï—Å–ª–∏ activate_immediately=False, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –¥–ª—è –ø–∞–∫–µ—Ç–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏.
    batch_context - –¥—Ä—É–≥–∏–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º—ã–µ –≤ —Ç–æ–π –∂–µ –ø–∞—á–∫–µ.
    """
    conn = None
    try:
        conn = get_db_connection()
        
        # –°–æ–±–∏—Ä–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –∫–ª–∏–µ–Ω—Ç–∞ (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ context_builder.py)
        context = collect_client_context(conn, reminder['conv_id'])
        
        # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞ –∏–∑ –ë–î
        with conn.cursor(cursor_factory=psycopg2.extras.DictCursor) as cur:
            cur.execute("""
                SELECT reminder_datetime, reminder_context_summary 
                FROM reminders 
                WHERE conv_id = %s AND status = 'active' AND id != %s
                ORDER BY reminder_datetime
            """, (reminder['conv_id'], reminder['id']))
            
            other_reminders_from_db = cur.fetchall()
            
        # –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –∏–∑ —Ç–µ–∫—É—â–µ–π –ø–∞—á–∫–∏ –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
        all_other_reminders = other_reminders_from_db
        if batch_context:
            all_other_reminders.extend(batch_context)
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –ø—Ä–æ–º–ø—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
        reminders_text = []
        for rem in all_other_reminders:
            reminders_text.append(f"- {rem['reminder_datetime']}: {rem['reminder_context_summary']}")
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
        is_admin_reminder = reminder['conv_id'] == ADMIN_CONV_ID
        special_rules_text = ""
        if is_admin_reminder:
            special_rules_text = (
                "–û–°–û–ë–´–ï –ü–†–ê–í–ò–õ–ê:\\n"
                "1. –≠—Ç–æ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.\\n"
                "2. –ó–ê–ü–†–ï–©–ï–ù–û –æ—Ç–º–µ–Ω—è—Ç—å –∏–ª–∏ –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞, –µ—Å–ª–∏ –æ–Ω –Ø–í–ù–û –Ω–µ –ø–æ–ø—Ä–æ—Å–∏–ª –æ–± —ç—Ç–æ–º –≤ –¥–∏–∞–ª–æ–≥–µ.\\n"
                "3. –°–æ–æ–±—â–µ–Ω–∏—è –æ '—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏', '–æ—Ç–ª–∞–¥–∫–µ' –∏–ª–∏ –ª—é–±—ã–µ –¥—Ä—É–≥–∏–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –æ–±—Å—É–∂–¥–µ–Ω–∏—è –ù–ï –Ø–í–õ–Ø–Æ–¢–°–Ø –ø—Ä–∏—á–∏–Ω–æ–π –¥–ª—è –æ—Ç–º–µ–Ω—ã. –ê–∫—Ç–∏–≤–∏—Ä—É–π –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –≤ –ª—é–±–æ–º —Å–ª—É—á–∞–µ, –µ—Å–ª–∏ –Ω–µ—Ç –ø—Ä—è–º–æ–π –∫–æ–º–∞–Ω–¥—ã –Ω–∞ –æ—Ç–º–µ–Ω—É."
            )

        verify_prompt = PROMPT_VERIFY_REMINDER.format(
            special_rules=special_rules_text,
            reminder_created_at=reminder['created_at'],
            reminder_datetime=reminder['reminder_datetime'],
            reminder_context_summary=reminder['reminder_context_summary'],
            client_context=context,
            all_active_reminders="\\n".join(reminders_text) if reminders_text else "–ù–µ—Ç –¥—Ä—É–≥–∏—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π",
            client_timezone=reminder.get('client_timezone', 'Europe/Moscow')
        )
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —É–º–µ—Å—Ç–Ω–æ—Å—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
        verification = call_gemini_api(model, verify_prompt, expect_json=True)
        
        with conn.cursor() as cur:
            if verification['should_activate']:
                logging.info(f"–ê–ö–¢–ò–í–ê–¶–ò–Ø ID={reminder['id']}: –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –ø—Ä–æ—à–ª–æ –ø—Ä–æ–≤–µ—Ä–∫—É. –ù–∞—á–∏–Ω–∞—é –ø—Ä–æ—Ü–µ—Å—Å –∞–∫—Ç–∏–≤–∞—Ü–∏–∏.")
                # –î–ª—è –ø–∞–∫–µ—Ç–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø—Ä–æ—Å—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                if not activate_immediately:
                    logging.info(f"–ê–ö–¢–ò–í–ê–¶–ò–Ø ID={reminder['id']}: –ì–æ—Ç–æ–≤–æ –∫ –ø–∞–∫–µ—Ç–Ω–æ–π –∞–∫—Ç–∏–≤–∞—Ü–∏–∏.")
                    return {'status': 'should_activate', 'context': reminder['reminder_context_summary'], 'id': reminder['id']}
                
                # –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ
                try:
                    # –§–æ—Ä–º–∏—Ä—É–µ–º –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π URL –¥–ª—è –≤—ã–∑–æ–≤–∞ –≤–Ω—É—Ç—Ä–∏ —Ç–æ–≥–æ –∂–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
                    port = os.environ.get("PORT", 8080)
                    activate_url = f"http://127.0.0.1:{port}/activate_reminder"
                    
                    payload = {
                        "conv_id": reminder['conv_id'],
                        "reminder_context_summary": reminder['reminder_context_summary']
                    }
                    logging.info(f"–ê–ö–¢–ò–í–ê–¶–ò–Ø ID={reminder['id']}: –û—Ç–ø—Ä–∞–≤–ª—è—é –∑–∞–ø—Ä–æ—Å –Ω–∞ {activate_url}")
                    
                    response = requests.post(activate_url, json=payload, timeout=60)
                    response.raise_for_status()
                    
                    response_text = response.text
                    logging.info(f"–ê–ö–¢–ò–í–ê–¶–ò–Ø ID={reminder['id']}: –ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç. –°—Ç–∞—Ç—É—Å: {response.status_code}, –¢–µ–ª–æ: '{response_text}'")
                    
                    # –ü–æ–º–µ—á–∞–µ–º –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–µ
                    logging.info(f"–ê–ö–¢–ò–í–ê–¶–ò–Ø ID={reminder['id']}: –û–±–Ω–æ–≤–ª—è—é —Å—Ç–∞—Ç—É—Å –≤ –ë–î –Ω–∞ 'done'.")
                    cur.execute(
                        "UPDATE reminders SET status = 'done' WHERE id = %s",
                        (reminder['id'],)
                    )

                except requests.exceptions.RequestException as e:
                    logging.error(f"–ê–ö–¢–ò–í–ê–¶–ò–Ø ID={reminder['id']}: –û–®–ò–ë–ö–ê. –ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–∑–≤–∞—Ç—å —ç–Ω–¥–ø–æ–∏–Ω—Ç –∞–∫—Ç–∏–≤–∞—Ü–∏–∏. –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –ù–ï –±—É–¥–µ—Ç –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–æ –≤ —ç—Ç–æ—Ç —Ä–∞–∑. –û—à–∏–±–∫–∞: {e}")
                    # –ü—Ä–∏ –æ—à–∏–±–∫–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ—Å—Ç–∞–Ω–µ—Ç—Å—è –≤ —Å—Ç–∞—Ç—É—Å–µ 'in_progress', 
                    # –∏ –±–ª–æ–∫ except –≤—ã—à–µ –≤–µ—Ä–Ω–µ—Ç –µ–≥–æ –≤ 'active'
                    raise  # –ü–µ—Ä–µ–¥–∞–µ–º –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –≤—ã—à–µ, —á—Ç–æ–±—ã —Å—Ä–∞–±–æ—Ç–∞–ª rollback –∏ –≤–æ–∑–≤—Ä–∞—Ç —Å—Ç–∞—Ç—É—Å–∞
                
            else:
                # –û—Ç–º–µ–Ω—è–µ–º –∏–ª–∏ –ø–µ—Ä–µ–Ω–æ—Å–∏–º –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ
                suggested_action = verification.get('suggested_action')
                reason = verification.get('reason', '–ü—Ä–∏—á–∏–Ω–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞ AI')

                if suggested_action == 'cancel':
                    logging.info(f"–û–¢–ú–ï–ù–ê ID={reminder['id']}: –û–±–Ω–æ–≤–ª—è—é —Å—Ç–∞—Ç—É—Å –Ω–∞ 'cancelled_by_reminder'. –ü—Ä–∏—á–∏–Ω–∞: {reason}")
                    cur.execute("""
                        UPDATE reminders 
                        SET status = 'cancelled_by_reminder', 
                            cancellation_reason = %s
                        WHERE id = %s
                    """, (reason, reminder['id']))
                    return_status = 'cancelled'
                    
                elif suggested_action == 'postpone':
                    postpone_to_str = verification.get('postpone_to')
                    if not postpone_to_str:
                        logging.warning(f"–ü–ï–†–ï–ù–û–° ID={reminder['id']}: AI –ø—Ä–µ–¥–ª–æ–∂–∏–ª –ø–µ—Ä–µ–Ω–æ—Å, –Ω–æ –Ω–µ —É–∫–∞–∑–∞–ª –≤—Ä–µ–º—è. –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –±—É–¥–µ—Ç –æ—Ç–º–µ–Ω–µ–Ω–æ.")
                        cur.execute("""
                            UPDATE reminders SET status = 'cancelled_by_reminder', cancellation_reason = %s WHERE id = %s
                        """, (f"–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–Ω–æ—Å–∞: –Ω–µ —É–∫–∞–∑–∞–Ω–æ –≤—Ä–µ–º—è. –ò—Å—Ö–æ–¥–Ω–∞—è –ø—Ä–∏—á–∏–Ω–∞: {reason}", reminder['id']))
                        return_status = 'cancelled'
                    else:
                        new_datetime = parse_datetime_with_timezone(
                            postpone_to_str,
                            reminder.get('client_timezone') or 'Europe/Moscow'
                        )
                        
                        cur.execute("""
                            UPDATE reminders 
                            SET reminder_datetime = %s, 
                                status = 'active',
                                cancellation_reason = %s
                            WHERE id = %s
                        """, (new_datetime, f"–ü–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ: {reason}", reminder['id']))
                        
                        logging.info(f"–ü–ï–†–ï–ù–û–° ID={reminder['id']}: –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ –Ω–∞ {new_datetime}")
                        return_status = 'postponed'
                else:
                    logging.warning(f"–ù–ï–ò–ó–í–ï–°–¢–ù–û–ï –î–ï–ô–°–¢–í–ò–ï ID={reminder['id']}: AI –ø—Ä–µ–¥–ª–æ–∂–∏–ª '{suggested_action}'. –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –±—É–¥–µ—Ç –æ—Ç–º–µ–Ω–µ–Ω–æ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.")
                    cur.execute("""
                        UPDATE reminders SET status = 'cancelled_by_reminder', cancellation_reason = %s WHERE id = %s
                    """, (f"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ –æ—Ç AI: {suggested_action}. –ü—Ä–∏—á–∏–Ω–∞: {reason}", reminder['id']))
                    return_status = 'cancelled'

            conn.commit()
            logging.info(f"ID={reminder['id']}: –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞.")
            return {'status': return_status, 'id': reminder['id']} # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞—Ç—É—Å –¥–ª—è –ø–∞–∫–µ—Ç–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏
            
    except Exception as e:
        logging.error(f"–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê ID={reminder['id']}: –ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞. –û—Ç–∫–∞—Ç—ã–≤–∞—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é. –°—Ç–∞—Ç—É—Å –±—É–¥–µ—Ç –≤–æ–∑–≤—Ä–∞—â–µ–Ω –≤ 'active'. –û—à–∏–±–∫–∞: {e}", exc_info=True)
        if conn:
            conn.rollback()
            # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞—Ç—É—Å –æ–±—Ä–∞—Ç–Ω–æ –≤ active –ø—Ä–∏ –æ—à–∏–±–∫–µ
            try:
                with conn.cursor() as cur:
                    cur.execute(
                        "UPDATE reminders SET status = 'active' WHERE id = %s",
                        (reminder['id'],)
                    )
                    conn.commit()
            except:
                pass
        return None # –ü—Ä–∏ –æ—à–∏–±–∫–µ
    finally:
        if conn:
            conn.close()

def collect_client_context(conn, conv_id):
    """
    –°–æ–±–∏—Ä–∞–µ—Ç –ø–æ–ª–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –∫–ª–∏–µ–Ω—Ç–∞ (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ context_builder.py).
    """
    context_parts = []
    
    try:
        with conn.cursor(cursor_factory=psycopg2.extras.DictCursor) as cur:
            # –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            cur.execute("SELECT * FROM user_profiles WHERE conv_id = %s", (conv_id,))
            profile = cur.fetchone()
            
            if profile:
                context_parts.append("--- –ö–ê–†–¢–û–ß–ö–ê –ö–õ–ò–ï–ù–¢–ê ---")
                if profile.get('first_name') or profile.get('last_name'):
                    context_parts.append(f"–ò–º—è: {profile.get('first_name', '')} {profile.get('last_name', '')}".strip())
                if profile.get('dialogue_summary'):
                    context_parts.append(f"\n–ö—Ä–∞—Ç–∫–æ–µ —Å–∞–º–º–∞—Ä–∏ –¥–∏–∞–ª–æ–≥–∞:\n{profile['dialogue_summary']}")
            
            # –ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞
            cur.execute("""
                SELECT role, message, created_at 
                FROM dialogues 
                WHERE conv_id = %s 
                ORDER BY created_at DESC 
                LIMIT 30
            """, (conv_id,))
            
            messages = cur.fetchall()
            if messages:
                context_parts.append("\n--- –ü–û–°–õ–ï–î–ù–Ø–Ø –ò–°–¢–û–†–ò–Ø –î–ò–ê–õ–û–ì–ê ---")
                for msg in reversed(messages):
                    role_map = {'user': '–ö–ª–∏–µ–Ω—Ç', 'bot': '–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç', 'operator': '–û–ø–µ—Ä–∞—Ç–æ—Ä'}
                    role = role_map.get(msg['role'], msg['role'])
                    message_text = re.sub(r'^\[.*?\]\s*', '', msg['message'])
                    
                    # –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –î–æ–±–∞–≤–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–∫–∏ –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è —Ö—Ä–æ–Ω–æ–ª–æ–≥–∏–∏
                    timestamp = msg['created_at'].strftime('%Y-%m-%d %H:%M:%S') if msg['created_at'] else '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'
                    context_parts.append(f"[{timestamp}] {role}: {message_text}")
            
            # –ü–æ–∫—É–ø–∫–∏ (–≤–∫–ª—é—á–∞—è –Ω–µ–¥–∞–≤–Ω–∏–µ)
            cur.execute("""
                SELECT product_name, purchase_date, amount
                FROM client_purchases 
                WHERE conv_id = %s
                ORDER BY purchase_date DESC
                LIMIT 10
            """, (conv_id,))
            
            purchases = cur.fetchall()
            if purchases:
                context_parts.append("\n--- –ü–û–ö–£–ü–ö–ò –ö–õ–ò–ï–ù–¢–ê ---")
                for purchase in purchases:
                    date_str = purchase['purchase_date'].strftime('%Y-%m-%d %H:%M') if purchase['purchase_date'] else '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'
                    amount_str = f" –Ω–∞ —Å—É–º–º—É {purchase['amount']}" if purchase.get('amount') else ""
                    context_parts.append(f"- {purchase['product_name']} (–¥–∞—Ç–∞: {date_str}{amount_str})")
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–µ–¥–∞–≤–Ω–∏–µ –ø–æ–∫—É–ø–∫–∏ (–∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 24 —á–∞—Å–∞)
                current_time = datetime.now(timezone.utc)
                recent_purchases = []
                for p in purchases:
                    if p['purchase_date']:
                        purchase_time = p['purchase_date']
                        # –ï—Å–ª–∏ –≤—Ä–µ–º—è –∏–∑ –ë–î –±–µ–∑ timezone, —Å—á–∏—Ç–∞–µ–º –µ–≥–æ UTC
                        if purchase_time.tzinfo is None:
                            purchase_time = purchase_time.replace(tzinfo=timezone.utc)
                        
                        time_diff = (current_time - purchase_time).total_seconds()
                        if time_diff < 86400:  # 24 —á–∞—Å–∞
                            recent_purchases.append(p)
                if recent_purchases:
                    context_parts.append("\n‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: –ï—Å—Ç—å –ø–æ–∫—É–ø–∫–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 24 —á–∞—Å–∞!")
                    for purchase in recent_purchases:
                        purchase_time = purchase['purchase_date']
                        if purchase_time.tzinfo is None:
                            purchase_time = purchase_time.replace(tzinfo=timezone.utc)
                        
                        hours_ago = int((current_time - purchase_time).total_seconds() / 3600)
                        context_parts.append(f"  ‚Ä¢ {purchase['product_name']} ({hours_ago} —á–∞—Å–æ–≤ –Ω–∞–∑–∞–¥)")
    
    except Exception as e:
        logging.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±–æ—Ä–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –¥–ª—è conv_id={conv_id}: {e}")
    
    return "\n".join(context_parts)

# --- –ü–õ–ê–ù–ò–†–û–í–©–ò–ö ---

scheduler = None

def start_scheduler(model):
    """–ó–∞–ø—É—Å–∫–∞–µ—Ç –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –¥–ª—è –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π."""
    global scheduler
    
    scheduler = BackgroundScheduler(timezone='UTC')
    
    # –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–¥–∞—á—É –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π
    scheduler.add_job(
        func=lambda: check_and_activate_reminders(model),
        trigger="interval",
        minutes=CHECK_INTERVAL_MINUTES,
        id='check_reminders',
        replace_existing=True
    )
    
    scheduler.start()
    logging.info(f"–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–ø—É—â–µ–Ω. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –∫–∞–∂–¥—ã–µ {CHECK_INTERVAL_MINUTES} –º–∏–Ω—É—Ç.")

    # –ù–µ–º–µ–¥–ª–µ–Ω–Ω—ã–π –ø–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫ –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ
    logging.info("–ó–∞–ø—É—Å–∫–∞–µ–º –Ω–µ–º–µ–¥–ª–µ–Ω–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ —Å–µ—Ä–≤–∏—Å–∞...")
    initial_check_thread = threading.Thread(target=check_and_activate_reminders, args=(model,), daemon=True)
    initial_check_thread.start()

def stop_scheduler():
    """–û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫."""
    global scheduler
    if scheduler:
        scheduler.shutdown()
        logging.info("–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.")

# --- –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –í–´–ó–û–í–ê –ò–ó MAIN.PY ---

def process_new_message(conv_id):
    """
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –ø–æ–∏—Å–∫–∞ –¥–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç–µ–π –æ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–∏.
    –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ main.py –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    """
    conn = None
    try:
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–¥–µ–ª–∏
        credentials_path = os.environ.get("GOOGLE_APPLICATION_CREDENTIALS")
        if not credentials_path:
            logging.error("GOOGLE_APPLICATION_CREDENTIALS –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞")
            return
        
        credentials = service_account.Credentials.from_service_account_file(credentials_path.strip(' "'))
        vertexai.init(project=PROJECT_ID, location=LOCATION, credentials=credentials)
        model = GenerativeModel(MODEL_NAME)
        
        conn = get_db_connection()
        
        # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –¥–∏–∞–ª–æ–≥. –¢–µ–ø–µ—Ä—å reminders_data - —ç—Ç–æ —Å–ø–∏—Å–æ–∫.
        reminders_data = analyze_dialogue_for_reminders(conn, conv_id, model)
        
        if reminders_data:
            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∫—Ç–æ —Å–æ–∑–¥–∞–µ—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ
            created_by = conv_id if conv_id == ADMIN_CONV_ID else None
            
            # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∂–¥–æ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –∏–∑ —Å–ø–∏—Å–∫–∞
            for reminder_item in reminders_data:
                try:
                    create_or_update_reminder(conn, conv_id, reminder_item, created_by)
                except Exception as e_item:
                    logging.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –æ–¥–Ω–æ–≥–æ –∏–∑ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –¥–ª—è conv_id={conv_id}: {reminder_item}. –û—à–∏–±–∫–∞: {e_item}")

    except Exception as e:
        logging.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è conv_id={conv_id}: {e}", exc_info=True)
    finally:
        if conn:
            conn.close()

# --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ü–†–ò –ò–ú–ü–û–†–¢–ï ---

def initialize_reminder_service():
    """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Å–µ—Ä–≤–∏—Å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π."""
    setup_logging()
    
    try:
        # –õ–æ–≥–∏—Ä—É–µ–º –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π –ø–æ—Ä—Ç –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
        port = os.environ.get("PORT", 8080)
        logging.info(f"–°–µ—Ä–≤–∏—Å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–æ—Ä—Ç {port} –¥–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏.")
        
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–¥–µ–ª–∏ Vertex AI
        credentials_path = os.environ.get("GOOGLE_APPLICATION_CREDENTIALS")
        if not credentials_path:
            raise RuntimeError("–ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–∫—Ä—É–∂–µ–Ω–∏—è 'GOOGLE_APPLICATION_CREDENTIALS' –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞.")
        
        credentials = service_account.Credentials.from_service_account_file(credentials_path.strip(' "'))
        vertexai.init(project=PROJECT_ID, location=LOCATION, credentials=credentials)
        model = GenerativeModel(MODEL_NAME)
        
        logging.info("–°–µ—Ä–≤–∏—Å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω. –ú–æ–¥–µ–ª—å Vertex AI –∑–∞–≥—Ä—É–∂–µ–Ω–∞.")
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫
        start_scheduler(model)
        
        return True
        
    except Exception as e:
        logging.critical(f"–ù–µ —É–¥–∞–ª–æ—Å—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–µ—Ä–≤–∏—Å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π: {e}")
        return False

if __name__ == "__main__":
    # –î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    if initialize_reminder_service():
        logging.info("–°–µ—Ä–≤–∏—Å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –∑–∞–ø—É—â–µ–Ω –≤ —Ç–µ—Å—Ç–æ–≤–æ–º —Ä–µ–∂–∏–º–µ.")
        try:
            # –î–µ—Ä–∂–∏–º –ø—Ä–æ—Ü–µ—Å—Å –∞–∫—Ç–∏–≤–Ω—ã–º
            import time
            while True:
                time.sleep(60)
        except KeyboardInterrupt:
            stop_scheduler()
            logging.info("–°–µ—Ä–≤–∏—Å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.")