#!/usr/bin/env python
# -*- coding: utf-8 -*-
# =======================================================================================
#               –°–ï–†–í–ò–° –ò–ù–¢–ï–ì–†–ò–†–û–í–ê–ù–ù–´–• –ù–ê–ü–û–ú–ò–ù–ê–ù–ò–ô (REMINDER SERVICE) - v1.0
# =======================================================================================
#
# –ß–¢–û –î–ï–õ–ê–ï–¢ –≠–¢–û–¢ –°–ï–†–í–ò–°:
#
# –≠—Ç–æ—Ç —Å–µ—Ä–≤–∏—Å ‚Äî "—É–º–Ω—ã–π –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫", –∫–æ—Ç–æ—Ä—ã–π –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –¥–∏–∞–ª–æ–≥–∏
# –∏ —Å–æ–∑–¥–∞–µ—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ –±—É–¥—É—â–∏—Ö –∫–æ–Ω—Ç–∞–∫—Ç–∞—Ö —Å –∫–ª–∏–µ–Ω—Ç–∞–º–∏.
#
# –ï–ì–û –ó–ê–î–ê–ß–ò:
#
# 1. –ê–ù–ê–õ–ò–ó –î–ò–ê–õ–û–ì–û–í: –°–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –≤—ã—è–≤–ª–µ–Ω–∏—è
#    –¥–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç–µ–π –æ –±—É–¥—É—â–µ–º –∫–æ–Ω—Ç–∞–∫—Ç–µ.
#
# 2. –°–û–ó–î–ê–ù–ò–ï –ù–ê–ü–û–ú–ò–ù–ê–ù–ò–ô: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –Ω–∞ –æ—Å–Ω–æ–≤–µ
#    –≤—ã—è–≤–ª–µ–Ω–Ω—ã—Ö –¥–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç–µ–π —Å —É—á–µ—Ç–æ–º —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å–∞ –∫–ª–∏–µ–Ω—Ç–∞.
#
# 3. –ê–ö–¢–ò–í–ê–¶–ò–Ø –ù–ê–ü–û–ú–ò–ù–ê–ù–ò–ô: –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –∞–∫—Ç–∏–≤–∞—Ü–∏—è –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π —Å –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–π
#    –ø—Ä–æ–≤–µ—Ä–∫–æ–π –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ —á–µ—Ä–µ–∑ AI-–∞–≥–µ–Ω—Ç–∞ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π.
#
# 4. –£–ü–†–ê–í–õ–ï–ù–ò–ï –ù–ê–ü–û–ú–ò–ù–ê–ù–ò–Ø–ú–ò: –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è,
#    –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏ –æ—Ç–º–µ–Ω—ã –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π.
#
# =======================================================================================

import os
import sys
import json
import logging
import re
import psycopg2
import psycopg2.extras
from datetime import datetime, timedelta, timezone
import threading
from apscheduler.schedulers.background import BackgroundScheduler
import pytz
import requests
from itertools import groupby
from operator import itemgetter

# –°–ª–æ–≤–∞—Ä—å –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π
reminder_creation_locks = {}

# –°–ª–æ–≤–∞—Ä—å –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –Ω–µ—É–¥–∞—á–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π
# –§–æ—Ä–º–∞—Ç: {reminder_id: {"attempts": count, "last_error": "error_message", "first_attempt": datetime}}
failed_activation_attempts = {}

try:
    import vertexai
    from vertexai.generative_models import GenerativeModel
    from google.oauth2 import service_account
    VERTEXAI_AVAILABLE = True
except ImportError:
    VERTEXAI_AVAILABLE = False
    print("–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: Vertex AI SDK –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω.", file=sys.stderr)
    sys.exit(1)

# --- –ù–ê–°–¢–†–û–ô–ö–ò ---
DATABASE_URL = os.environ.get("DATABASE_URL")
PROJECT_ID = os.environ.get("GCP_PROJECT_ID", "hardy-technique-470816-f2")
LOCATION = os.environ.get("GEMINI_LOCATION", "us-central1")
ADMIN_CONV_ID = 78671089  # ID –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞

MODEL_NAME = "gemini-2.5-flash"
API_TIMEOUT = 45

# –ò–Ω—Ç–µ—Ä–≤–∞–ª –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π (–≤ –º–∏–Ω—É—Ç–∞—Ö)
CHECK_INTERVAL_MINUTES = 5

# –£–≤–µ–ª–∏—á–µ–Ω–Ω—ã–π —Ç–∞–π–º–∞—É—Ç –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π
ACTIVATION_TIMEOUT = 120  # 2 –º–∏–Ω—É—Ç—ã

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
LOG_FILE_NAME = "reminder_service.log"

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤ Telegram
TELEGRAM_TOKEN = os.environ.get("TELEGRAM_TOKEN")
ADMIN_CHAT_ID = os.environ.get("ADMIN_CHAT_ID")
MAX_RETRY_ATTEMPTS = 3  # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

# –°–ª–æ–≤–∞—Ä—å –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å–∞ –ø–æ –≥–æ—Ä–æ–¥—É
CITY_TIMEZONE_MAP = {
    # –†–æ—Å—Å–∏—è
    '–º–æ—Å–∫–≤–∞': 'Europe/Moscow',
    '—Å–∞–Ω–∫—Ç-–ø–µ—Ç–µ—Ä–±—É—Ä–≥': 'Europe/Moscow', 
    '—Å–ø–±': 'Europe/Moscow',
    '–ø–µ—Ç–µ—Ä–±—É—Ä–≥': 'Europe/Moscow',
    '–µ–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥': 'Asia/Yekaterinburg',
    '–Ω–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫': 'Asia/Novosibirsk',
    '–∫—Ä–∞—Å–Ω–æ—è—Ä—Å–∫': 'Asia/Krasnoyarsk',
    '–∏—Ä–∫—É—Ç—Å–∫': 'Asia/Irkutsk',
    '–≤–ª–∞–¥–∏–≤–æ—Å—Ç–æ–∫': 'Asia/Vladivostok',
    '—Ö–∞–±–∞—Ä–æ–≤—Å–∫': 'Asia/Vladivostok',
    '–æ–º—Å–∫': 'Asia/Omsk',
    '—á–µ–ª—è–±–∏–Ω—Å–∫': 'Asia/Yekaterinburg',
    '–∫–∞–∑–∞–Ω—å': 'Europe/Moscow',
    '–Ω–∏–∂–Ω–∏–π –Ω–æ–≤–≥–æ—Ä–æ–¥': 'Europe/Moscow',
    '—Å–∞–º–∞—Ä–∞': 'Europe/Samara',
    '—É—Ñ–∞': 'Asia/Yekaterinburg',
    '—Ä–æ—Å—Ç–æ–≤-–Ω–∞-–¥–æ–Ω—É': 'Europe/Moscow',
    '–∫—Ä–∞—Å–Ω–æ–¥–∞—Ä': 'Europe/Moscow',
    '–ø–µ—Ä–º—å': 'Asia/Yekaterinburg',
    '–≤–æ—Ä–æ–Ω–µ–∂': 'Europe/Moscow',
    '–≤–æ–ª–≥–æ–≥—Ä–∞–¥': 'Europe/Moscow',
    '—Å–∞—Ä–∞—Ç–æ–≤': 'Europe/Moscow',
    '—Ç—é–º–µ–Ω—å': 'Asia/Yekaterinburg',
    '—Ç–æ–ª—å—è—Ç—Ç–∏': 'Europe/Samara',
    '–±–∞—Ä–Ω–∞—É–ª': 'Asia/Barnaul',
    '—É–ª—å—è–Ω–æ–≤—Å–∫': 'Europe/Samara',
    '–∏–≤–∞–Ω–æ–≤–æ': 'Europe/Moscow',
    '—è—Ä–æ—Å–ª–∞–≤–ª—å': 'Europe/Moscow',
    '–º–∞—Ö–∞—á–∫–∞–ª–∞': 'Europe/Moscow',
    '—Ö–∞–±–∞—Ä–æ–≤—Å–∫': 'Asia/Vladivostok',
    '–æ—Ä–µ–Ω–±—É—Ä–≥': 'Asia/Yekaterinburg',
    '–Ω–æ–≤–æ–∫—É–∑–Ω–µ—Ü–∫': 'Asia/Novokuznetsk',
    '—Ä—è–∑–∞–Ω—å': 'Europe/Moscow',
    '—Ç—É–ª–∞': 'Europe/Moscow',
    '–ª–∏–ø–µ—Ü–∫': 'Europe/Moscow',
    '–∫–∏—Ä–æ–≤': 'Europe/Moscow',
    '—á–µ–±–æ–∫—Å–∞—Ä—ã': 'Europe/Moscow',
    '–∫–∞–ª–∏–Ω–∏–Ω–≥—Ä–∞–¥': 'Europe/Kaliningrad',
    '–±—Ä—è–Ω—Å–∫': 'Europe/Moscow',
    '–º–∞–≥–Ω–∏—Ç–æ–≥–æ—Ä—Å–∫': 'Asia/Yekaterinburg',
    '–∫—É—Ä—Å–∫': 'Europe/Moscow',
    '—Ç–≤–µ—Ä—å': 'Europe/Moscow',
    '–∏–≤–∞–Ω–æ–≤–æ': 'Europe/Moscow',
    '–∞—Ä—Ö–∞–Ω–≥–µ–ª—å—Å–∫': 'Europe/Moscow',
    '—Å–æ—á–∏': 'Europe/Moscow',
    '–±–µ–ª–≥–æ—Ä–æ–¥': 'Europe/Moscow',
    '–∫–∞–ª—É–≥–∞': 'Europe/Moscow',
    '–≤–ª–∞–¥–∏–º–∏—Ä': 'Europe/Moscow',
    '—Å—É—Ä–≥—É—Ç': 'Asia/Yekaterinburg',
    '—Å–º–æ–ª–µ–Ω—Å–∫': 'Europe/Moscow',
    '–∫—É—Ä–≥–∞–Ω': 'Asia/Yekaterinburg',
    '–æ—Ä—ë–ª': 'Europe/Moscow',
    '—á–µ—Ä–µ–ø–æ–≤–µ—Ü': 'Europe/Moscow',
    '–≤–æ–ª–æ–≥–¥–∞': 'Europe/Moscow',
    '–º—É—Ä–º–∞–Ω—Å–∫': 'Europe/Moscow',
    '—Ç–∞–º–±–æ–≤': 'Europe/Moscow',
    '—Å—Ç–µ—Ä–ª–∏—Ç–∞–º–∞–∫': 'Asia/Yekaterinburg',
    '–≥—Ä–æ–∑–Ω—ã–π': 'Europe/Moscow',
    '—è–∫—É—Ç—Å–∫': 'Asia/Yakutsk',
    '–∫–æ—Å—Ç—Ä–æ–º–∞': 'Europe/Moscow',
    '–∫–æ–º—Å–æ–º–æ–ª—å—Å–∫-–Ω–∞-–∞–º—É—Ä–µ': 'Asia/Vladivostok',
    '–ø–µ—Ç—Ä–æ–∑–∞–≤–æ–¥—Å–∫': 'Europe/Moscow',
    '—Ç–∞–≥–∞–Ω—Ä–æ–≥': 'Europe/Moscow',
    '–Ω–∏–∂–Ω–µ–≤–∞—Ä—Ç–æ–≤—Å–∫': 'Asia/Yekaterinburg',
    '–π–æ—à–∫–∞—Ä-–æ–ª–∞': 'Europe/Moscow',
    '–±—Ä–∞—Ç—Å–∫': 'Asia/Irkutsk',
    '–Ω–æ–≤–æ—Ä–æ—Å—Å–∏–π—Å–∫': 'Europe/Moscow',
    '–¥–∑–µ—Ä–∂–∏–Ω—Å–∫': 'Europe/Moscow',
    '—à–∞—Ö—Ç—ã': 'Europe/Moscow',
    '–æ—Ä—Å–∫': 'Asia/Yekaterinburg',
    '–∞–Ω–≥–∞—Ä—Å–∫': 'Asia/Irkutsk',
    '—Å—ã–∫—Ç—ã–≤–∫–∞—Ä': 'Europe/Moscow',
    '–Ω–∏–∂–Ω–µ–∫–∞–º—Å–∫': 'Europe/Moscow',
    '—Å—Ç–∞—Ä—ã–π –æ—Å–∫–æ–ª': 'Europe/Moscow',
    '–º—ã—Ç–∏—â–∏': 'Europe/Moscow',
    '–ø—Ä–æ–∫–æ–ø—å–µ–≤—Å–∫': 'Asia/Novokuznetsk',
    '–±–∞–ª–∞—à–∏—Ö–∞': 'Europe/Moscow',
    '—Ä—ã–±–∏–Ω—Å–∫': 'Europe/Moscow',
    '–±–∏–π—Å–∫': 'Asia/Barnaul',
    '–ø–æ–¥–æ–ª—å—Å–∫': 'Europe/Moscow',
    '–∫–æ—Ä–æ–ª—ë–≤': 'Europe/Moscow',
    '—Å—ã–∑—Ä–∞–Ω—å': 'Europe/Samara',
    '–≤–æ–ª–∂—Å–∫–∏–π': 'Europe/Moscow',
    '–∂–µ–ª–µ–∑–Ω–æ–¥–æ—Ä–æ–∂–Ω—ã–π': 'Europe/Moscow',
    '–∞–±–∞–∫–∞–Ω': 'Asia/Krasnoyarsk',
    '—É—Å—Å—É—Ä–∏–π—Å–∫': 'Asia/Vladivostok',
    '–Ω–æ—Ä–∏–ª—å—Å–∫': 'Asia/Krasnoyarsk',
    '–∫–∞–º–µ–Ω—Å–∫-—É—Ä–∞–ª—å—Å–∫–∏–π': 'Asia/Yekaterinburg',
    '–≤–µ–ª–∏–∫–∏–π –Ω–æ–≤–≥–æ—Ä–æ–¥': 'Europe/Moscow',
    '–ª—é–±–µ—Ä—Ü—ã': 'Europe/Moscow',
    '—é–∂–Ω–æ-—Å–∞—Ö–∞–ª–∏–Ω—Å–∫': 'Asia/Sakhalin',
    
    # –£–∫—Ä–∞–∏–Ω–∞
    '–∫–∏–µ–≤': 'Europe/Kiev',
    '—Ö–∞—Ä—å–∫–æ–≤': 'Europe/Kiev',
    '–æ–¥–µ—Å—Å–∞': 'Europe/Kiev',
    '–¥–Ω–µ–ø—Ä–æ–ø–µ—Ç—Ä–æ–≤—Å–∫': 'Europe/Kiev',
    '–¥–æ–Ω–µ—Ü–∫': 'Europe/Kiev',
    '–∑–∞–ø–æ—Ä–æ–∂—å–µ': 'Europe/Kiev',
    '–ª—å–≤–æ–≤': 'Europe/Kiev',
    
    # –ë–µ–ª–∞—Ä—É—Å—å
    '–º–∏–Ω—Å–∫': 'Europe/Minsk',
    '–≥–æ–º–µ–ª—å': 'Europe/Minsk',
    '–º–æ–≥–∏–ª—ë–≤': 'Europe/Minsk',
    '–≤–∏—Ç–µ–±—Å–∫': 'Europe/Minsk',
    '–≥—Ä–æ–¥–Ω–æ': 'Europe/Minsk',
    '–±—Ä–µ—Å—Ç': 'Europe/Minsk',
    
    # –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω
    '–∞–ª–º–∞—Ç—ã': 'Asia/Almaty',
    '–Ω—É—Ä-—Å—É–ª—Ç–∞–Ω': 'Asia/Almaty',
    '–∞—Å—Ç–∞–Ω–∞': 'Asia/Almaty',
    '—à—ã–º–∫–µ–Ω—Ç': 'Asia/Almaty',
    '–∫–∞—Ä–∞–≥–∞–Ω–¥–∞': 'Asia/Almaty',
    '–∞–∫—Ç–æ–±–µ': 'Asia/Aqtobe',
    '—Ç–∞—Ä–∞–∑': 'Asia/Almaty',
    '–ø–∞–≤–ª–æ–¥–∞—Ä': 'Asia/Almaty',
    '—É—Å—Ç—å-–∫–∞–º–µ–Ω–æ–≥–æ—Ä—Å–∫': 'Asia/Almaty',
    '—Å–µ–º–µ–π': 'Asia/Almaty',
    '–∞—Ç—ã—Ä–∞—É': 'Asia/Aqtau',
    '–∫–æ—Å—Ç–∞–Ω–∞–π': 'Asia/Almaty',
    '–∫—ã–∑—ã–ª–æ—Ä–¥–∞': 'Asia/Qyzylorda',
    '—É—Ä–∞–ª—å—Å–∫': 'Asia/Oral',
    '–ø–µ—Ç—Ä–æ–ø–∞–≤–ª–æ–≤—Å–∫': 'Asia/Almaty',
    '–∞–∫—Ç–∞—É': 'Asia/Aqtau',
    
    # –î—Ä—É–≥–∏–µ —Å—Ç—Ä–∞–Ω—ã (–æ—Å–Ω–æ–≤–Ω—ã–µ –≥–æ—Ä–æ–¥–∞)
    '–ª–æ–Ω–¥–æ–Ω': 'Europe/London',
    '–ø–∞—Ä–∏–∂': 'Europe/Paris',
    '–±–µ—Ä–ª–∏–Ω': 'Europe/Berlin',
    '—Ä–∏–º': 'Europe/Rome',
    '–º–∞–¥—Ä–∏–¥': 'Europe/Madrid',
    '–∞–º—Å—Ç–µ—Ä–¥–∞–º': 'Europe/Amsterdam',
    '–±—Ä—é—Å—Å–µ–ª—å': 'Europe/Brussels',
    '–≤–µ–Ω–∞': 'Europe/Vienna',
    '–ø—Ä–∞–≥–∞': 'Europe/Prague',
    '–≤–∞—Ä—à–∞–≤–∞': 'Europe/Warsaw',
    '—Å—Ç–æ–∫–≥–æ–ª—å–º': 'Europe/Stockholm',
    '—Ö–µ–ª—å—Å–∏–Ω–∫–∏': 'Europe/Helsinki',
    '–æ—Å–ª–æ': 'Europe/Oslo',
    '–∫–æ–ø–µ–Ω–≥–∞–≥–µ–Ω': 'Europe/Copenhagen',
    '–¥—É–±–ª–∏–Ω': 'Europe/Dublin',
    '–ª–∏—Å—Å–∞–±–æ–Ω': 'Europe/Lisbon',
    '–∞—Ñ–∏–Ω—ã': 'Europe/Athens',
    '–±—É–¥–∞–ø–µ—à—Ç': 'Europe/Budapest',
    '–±—É—Ö–∞—Ä–µ—Å—Ç': 'Europe/Bucharest',
    '—Å–æ—Ñ–∏—è': 'Europe/Sofia',
    '–±–µ–ª–≥—Ä–∞–¥': 'Europe/Belgrade',
    '–∑–∞–≥—Ä–µ–±': 'Europe/Zagreb',
    '–ª—é–±–ª—è–Ω–∞': 'Europe/Ljubljana',
    '–±—Ä–∞—Ç–∏—Å–ª–∞–≤–∞': 'Europe/Bratislava',
    '—Ç–∞–ª–ª–∏–Ω': 'Europe/Tallinn',
    '—Ä–∏–≥–∞': 'Europe/Riga',
    '–≤–∏–ª—å–Ω—é—Å': 'Europe/Vilnius',
    '–Ω—å—é-–π–æ—Ä–∫': 'America/New_York',
    '–ª–æ—Å-–∞–Ω–¥–∂–µ–ª–µ—Å': 'America/Los_Angeles',
    '—á–∏–∫–∞–≥–æ': 'America/Chicago',
    '—Ö—å—é—Å—Ç–æ–Ω': 'America/Chicago',
    '—Ç–æ—Ä–æ–Ω—Ç–æ': 'America/Toronto',
    '–≤–∞–Ω–∫—É–≤–µ—Ä': 'America/Vancouver',
    '—Ç–æ–∫–∏–æ': 'Asia/Tokyo',
    '–ø–µ–∫–∏–Ω': 'Asia/Shanghai',
    '—à–∞–Ω—Ö–∞–π': 'Asia/Shanghai',
    '—Å–µ—É–ª': 'Asia/Seoul',
    '–±–∞–Ω–≥–∫–æ–∫': 'Asia/Bangkok',
    '—Å–∏–Ω–≥–∞–ø—É—Ä': 'Asia/Singapore',
    '–¥–∂–∞–∫–∞—Ä—Ç–∞': 'Asia/Jakarta',
    '–º—É–º–±–∞–∏': 'Asia/Kolkata',
    '–¥–µ–ª–∏': 'Asia/Kolkata',
    '–¥—É–±–∞–π': 'Asia/Dubai',
    '—Ç–µ–ª—å-–∞–≤–∏–≤': 'Asia/Jerusalem',
    '—Å—Ç–∞–º–±—É–ª': 'Europe/Istanbul',
    '–∫–∞–∏—Ä': 'Africa/Cairo',
    '–π–æ—Ö–∞–Ω–Ω–µ—Å–±—É—Ä–≥': 'Africa/Johannesburg',
    '—Å–∏–¥–Ω–µ–π': 'Australia/Sydney',
    '–º–µ–ª—å–±—É—Ä–Ω': 'Australia/Melbourne',
    '—Å–∞–Ω-–ø–∞—É–ª—É': 'America/Sao_Paulo',
    '—Ä–∏–æ-–¥–µ-–∂–∞–Ω–µ–π—Ä–æ': 'America/Sao_Paulo',
    '–±—É—ç–Ω–æ—Å-–∞–π—Ä–µ—Å': 'America/Argentina/Buenos_Aires',
    '–º–µ—Ö–∏–∫–æ': 'America/Mexico_City',
}

def get_timezone_by_city(city):
    """–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –≥–æ—Ä–æ–¥–∞."""
    if not city:
        return 'Europe/Moscow'  # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –º–æ—Å–∫–æ–≤—Å–∫–æ–µ –≤—Ä–µ–º—è
    
    city_lower = city.lower().strip()
    return CITY_TIMEZONE_MAP.get(city_lower, 'Europe/Moscow')

def detect_timezone_from_message(message_text):
    """–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç, —É–∫–∞–∑–∞–Ω –ª–∏ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å."""
    message_lower = message_text.lower()
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —É–ø–æ–º–∏–Ω–∞–Ω–∏—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —á–∞—Å–æ–≤—ã—Ö –ø–æ—è—Å–æ–≤
    timezone_patterns = [
        (r'–ø–æ\s+–º–æ—Å–∫–≤–µ|–º–æ—Å–∫–æ–≤—Å–∫–æ–µ\s+–≤—Ä–µ–º—è|–º—Å–∫', 'Europe/Moscow'),
        (r'–ø–æ\s+–ø–∏—Ç–µ—Ä—É|–ø–æ\s+—Å–ø–±|–ø–∏—Ç–µ—Ä—Å–∫–æ–µ\s+–≤—Ä–µ–º—è', 'Europe/Moscow'),
        (r'–ø–æ\s+–µ–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥—É|–µ–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥—Å–∫–æ–µ\s+–≤—Ä–µ–º—è', 'Asia/Yekaterinburg'),
        (r'–ø–æ\s+–Ω–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫—É|–Ω–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫–æ–µ\s+–≤—Ä–µ–º—è', 'Asia/Novosibirsk'),
        (r'–ø–æ\s+–≤–ª–∞–¥–∏–≤–æ—Å—Ç–æ–∫—É|–≤–ª–∞–¥–∏–≤–æ—Å—Ç–æ–∫—Å–∫–æ–µ\s+–≤—Ä–µ–º—è', 'Asia/Vladivostok'),
        (r'utc|–≥—Ä–∏–Ω–≤–∏—á', 'UTC'),
        (r'–ø–æ\s+–∫–∏–µ–≤—É|–∫–∏–µ–≤—Å–∫–æ–µ\s+–≤—Ä–µ–º—è', 'Europe/Kiev'),
        (r'–ø–æ\s+–º–∏–Ω—Å–∫—É|–º–∏–Ω—Å–∫–æ–µ\s+–≤—Ä–µ–º—è', 'Europe/Minsk'),
        (r'–ø–æ\s+–∞–ª–º–∞—Ç—ã', 'Asia/Almaty'),
    ]
    
    for pattern, timezone in timezone_patterns:
        if re.search(pattern, message_lower):
            return timezone
    
    return None

# --- –ü–†–û–ú–ü–¢–´ –î–õ–Ø AI ---
PROMPT_ANALYZE_DIALOGUE = """
–¢—ã ‚Äî AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç, –∞–Ω–∞–ª–∏–∑–∏—Ä—É—é—â–∏–π –¥–∏–∞–ª–æ–≥–∏ –æ–Ω–ª–∞–π–Ω-—à–∫–æ–ª—ã –º—É–∑—ã–∫–∏ –¥–ª—è –≤—ã—è–≤–ª–µ–Ω–∏—è –¥–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç–µ–π –æ –±—É–¥—É—â–µ–º –∫–æ–Ω—Ç–∞–∫—Ç–µ.

–¢–í–û–Ø –†–û–õ–¨ –í –°–ò–°–¢–ï–ú–ï:
–¢—ã ‚Äî —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π AI-–∞–≥–µ–Ω—Ç, –∫–æ—Ç–æ—Ä—ã–π —Ä–∞–±–æ—Ç–∞–µ—Ç –∑–∞ –∫—É–ª–∏—Å–∞–º–∏. –¢–≤–æ—è –∞–∫—Ç–∏–≤–∞—Ü–∏—è –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ü–û–°–õ–ï —Ç–æ–≥–æ, –∫–∞–∫ –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç-–∫–æ–º–º—É–Ω–∏–∫–∞—Ç–æ—Ä –æ—Ç–≤–µ—Ç–∏–ª –∫–ª–∏–µ–Ω—Ç—É.
- –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç-–∫–æ–º–º—É–Ω–∏–∫–∞—Ç–æ—Ä (–≤ –¥–∏–∞–ª–æ–≥–µ '–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç') –ù–ï –£–ú–ï–ï–¢ —Å—Ç–∞–≤–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è. –û–Ω —Ç–æ–ª—å–∫–æ –≤–µ–∂–ª–∏–≤–æ –æ–±—â–∞–µ—Ç—Å—è —Å –∫–ª–∏–µ–Ω—Ç–æ–º.
- –ï—Å–ª–∏ –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç –≥–æ–≤–æ—Ä–∏—Ç "—Ö–æ—Ä–æ—à–æ, –Ω–∞–ø–æ–º–Ω—é", "—è –ø–æ—Å—Ç–∞–≤–∏–ª –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ" ‚Äî —ç—Ç–æ —Å–∏–≥–Ω–∞–ª –¥–ª—è –¢–ï–ë–Ø —Å–æ–∑–¥–∞—Ç—å —ç—Ç–æ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ. –≠—Ç–æ –ù–ï –∑–Ω–∞—á–∏—Ç, —á—Ç–æ –æ–Ω–æ —É–∂–µ —Å–æ–∑–¥–∞–Ω–æ.
- –¢–æ–ª—å–∫–æ —Ç—ã –º–æ–∂–µ—à—å —Å–æ–∑–¥–∞–≤–∞—Ç—å, –∏–∑–º–µ–Ω—è—Ç—å –∏–ª–∏ –æ—Ç–º–µ–Ω—è—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è. –¢–≤–æ–∏ —Ä–µ—à–µ–Ω–∏—è ‚Äî —Ñ–∏–Ω–∞–ª—å–Ω—ã–µ.

–ü–†–ê–í–ò–õ–ê –û–ë–†–ê–ë–û–¢–ö–ò –í–†–ï–ú–ï–ù–ò:
1.  –ü–†–ò–û–†–ò–¢–ï–¢ –ß–ê–°–û–í–û–ì–û –ü–û–Ø–°–ê –ö–õ–ò–ï–ù–¢–ê: –í—Å—è –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è –≤—Ä–µ–º–µ–Ω–∏ –¥–æ–ª–∂–Ω–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç—å –≤ —á–∞—Å–æ–≤–æ–º –ø–æ—è—Å–µ –∫–ª–∏–µ–Ω—Ç–∞: {client_timezone} (UTC{client_timezone_offset}).
2.  –ò–°–ö–õ–Æ–ß–ï–ù–ò–ï: –ï—Å–ª–∏ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏ —è–≤–Ω–æ —É–∫–∞–∑–∞–Ω –¥—Ä—É–≥–æ–π —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–ø–æ –ú–æ—Å–∫–≤–µ", "–ø–æ –ú–°–ö", "UTC"), –∏—Å–ø–æ–ª—å–∑—É–π –µ–≥–æ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞, –Ω–æ –≤ –∏—Ç–æ–≥–æ–≤–æ–º JSON —Ñ–æ—Ä–º–∞—Ç–µ `proposed_datetime` –≤—Ä–µ–º—è –í–°–ï–ì–î–ê –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø—Ä–∏–≤–µ–¥–µ–Ω–æ –∫ —á–∞—Å–æ–≤–æ–º—É –ø–æ—è—Å—É –∫–ª–∏–µ–Ω—Ç–∞.
3.  –ï–°–õ–ò –í–†–ï–ú–Ø –ù–ï –£–ö–ê–ó–ê–ù–û: –ò—Å–ø–æ–ª—å–∑—É–π —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –≤—Ä–µ–º—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤ —á–∞—Å–æ–≤–æ–º –ø–æ—è—Å–µ –∫–ª–∏–µ–Ω—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–∑–∞–≤—Ç—Ä–∞" = 10:00 –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –∫–ª–∏–µ–Ω—Ç–∞).
4.  –°–û–•–†–ê–ù–ï–ù–ò–ï –ö–û–ù–¢–ï–ö–°–¢–ê: –ï—Å–ª–∏ –≤ –ø—Ä–æ—Å—å–±–µ —É–ø–æ–º–∏–Ω–∞–µ—Ç—Å—è –æ—Å–æ–±—ã–π —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å ("–Ω–∞–ø–æ–º–Ω–∏ –≤ 12 –ø–æ –ú–æ—Å–∫–≤–µ"), —ç—Ç–∞ –¥–µ—Ç–∞–ª—å –î–û–õ–ñ–ù–ê –ë–´–¢–¨ –≤–∫–ª—é—á–µ–Ω–∞ –≤ `reminder_context_summary`. –≠—Ç–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ –¥–ª—è –¥—Ä—É–≥–∏—Ö –∞–≥–µ–Ω—Ç–æ–≤, —á—Ç–æ–±—ã –æ–Ω–∏ –ø–æ–Ω–∏–º–∞–ª–∏ –ª–æ–≥–∏–∫—É.

–í–ê–ñ–ù–´–ï –ü–†–ê–í–ò–õ–ê:
1. –ò—â–∏ –¢–û–õ–¨–ö–û –¥–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç–∏, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é —à–∫–æ–ª—ã (–æ–ø–ª–∞—Ç–∞, –æ–±—É—á–µ–Ω–∏–µ, –∫—É—Ä—Å—ã, –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏).
2. –ò–ì–ù–û–†–ò–†–£–ô –ª–∏—á–Ω—ã–µ –ø—Ä–æ—Å—å–±—ã, –Ω–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å–æ —à–∫–æ–ª–æ–π (–Ω–∞–ø–æ–º–Ω–∏—Ç—å –≤—ã–Ω–µ—Å—Ç–∏ –º—É—Å–æ—Ä, –ø–æ–∑–≤–æ–Ω–∏—Ç—å –º–∞–º–µ –∏ —Ç.–¥.), –∫—Ä–æ–º–µ –ª–∏—á–Ω—ã—Ö –ø—Ä–æ—Å—å–± –æ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.
3. –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –∏–º–µ–µ—Ç conv_id = {admin_conv_id}. 
   - –ï—Å–ª–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –ø—Ä–æ—Å–∏—Ç –ø–æ—Å—Ç–∞–≤–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –¥–ª—è —Å–µ–±—è, –∏—Å–ø–æ–ª—å–∑—É–π –µ–≥–æ conv_id.
   - –ï—Å–ª–∏ –æ–Ω –ø—Ä–æ—Å–∏—Ç –ø–æ—Å—Ç–∞–≤–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –¥–ª—è –¥—Ä—É–≥–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞, –æ–Ω –Ø–í–ù–û —É–∫–∞–∑—ã–≤–∞–µ—Ç conv_id —ç—Ç–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞.
   - –ù–ï –°–û–ó–î–ê–í–ê–ô –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –ø–æ —Å—Ç–∞—Ä—ã–º –∏–ª–∏ –Ω–µ–∞–∫—Ç—É–∞–ª—å–Ω—ã–º —Å–æ–æ–±—â–µ–Ω–∏—è–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.
4. –£—á–∏—Ç—ã–≤–∞–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –≤—Å–µ–≥–æ –¥–∏–∞–ª–æ–≥–∞ –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–∏.

‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û - –ü–†–ê–í–ò–õ–ê –ü–†–û–¢–ò–í –î–£–ë–õ–ò–†–û–í–ê–ù–ò–Ø:
1. –ù–ê –û–î–ù–£ –ü–†–û–°–¨–ë–£ –°–û–ó–î–ê–í–ê–ô –¢–û–õ–¨–ö–û –û–î–ù–û –ù–ê–ü–û–ú–ò–ù–ê–ù–ò–ï!
2. –ï—Å–ª–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –≥–æ–≤–æ—Ä–∏—Ç "–ø–æ—Å—Ç–∞–≤—å –ú–ù–ï –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ" ‚Üí target_conv_id = {admin_conv_id}
3. –ï—Å–ª–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –≥–æ–≤–æ—Ä–∏—Ç "–ø–æ—Å—Ç–∞–≤—å –°–µ—Ä–≥–µ—é/–∫–ª–∏–µ–Ω—Ç—É –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ" ‚Üí target_conv_id = conv_id —ç—Ç–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
4. –ù–ò–ö–û–ì–î–ê –Ω–µ —Å–æ–∑–¥–∞–≤–∞–π –¥–≤–∞ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è —Å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ–º –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –ª—é–¥–µ–π!

üéØ –°–ü–ï–¶–ò–ê–õ–¨–ù–´–ï –ü–†–ê–í–ò–õ–ê –î–õ–Ø –£–ü–û–ú–ò–ù–ê–ù–ò–ô "–°–ï–†–ì–ï–Ø" –ö–õ–ò–ï–ù–¢–ê–ú–ò:

–ö–û–ì–î–ê –ö–õ–ò–ï–ù–¢ –£–ü–û–ú–ò–ù–ê–ï–¢ "–°–ï–†–ì–ï–Ø" - –°–û–ó–î–ê–í–ê–ô –ù–ê–ü–û–ú–ò–ù–ê–ù–ò–ï –î–õ–Ø –ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–û–†–ê:
‚úÖ –ö–ª–∏–µ–Ω—Ç –ø—Ä–æ—Å–∏—Ç —Å–≤—è–∑–∞—Ç—å—Å—è —Å –°–µ—Ä–≥–µ–µ–º:
   - "–í—ã –º–æ–∂–µ—Ç–µ –ø–µ—Ä–µ–¥–∞—Ç—å –°–µ—Ä–≥–µ—é, —á—Ç–æ–±—ã –æ–Ω –Ω–∞–ø–∏—Å–∞–ª –º–Ω–µ?"
   - "–°–∫–∞–∂–∏—Ç–µ –°–µ—Ä–≥–µ—é, —á—Ç–æ —è –≥–æ—Ç–æ–≤–∞ –∫ –∑–∞–Ω—è—Ç–∏—é"
   - "–ü–æ–ø—Ä–æ—Å–∏—Ç–µ –°–µ—Ä–≥–µ—è —Å–≤—è–∑–∞—Ç—å—Å—è —Å–æ –º–Ω–æ–π"
   - "–°–µ—Ä–≥–µ–π –≥–æ–≤–æ—Ä–∏–ª, —á—Ç–æ –Ω–∞–ø–∏—à–µ—Ç –º–Ω–µ —Å–µ–≥–æ–¥–Ω—è"
   ‚Üí target_conv_id = {admin_conv_id}, –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ "–ö–ª–∏–µ–Ω—Ç [–∏–º—è] –ø—Ä–æ—Å–∏—Ç —Å–≤—è–∑–∞—Ç—å—Å—è"

–ö–û–ì–î–ê –ù–ï –°–û–ó–î–ê–í–ê–¢–¨ –ù–ê–ü–û–ú–ò–ù–ê–ù–ò–ï –î–õ–Ø –ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–û–†–ê:
‚ùå –ü—Ä–æ—Å—Ç–æ–µ —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ –±–µ–∑ –ø—Ä–æ—Å—å–±—ã –æ –∫–æ–Ω—Ç–∞–∫—Ç–µ:
   - "–Ø –Ω–µ –ø–æ–ª—É—á–∞–ª–∞ –æ—Ç –°–µ—Ä–≥–µ—è –ø–∏—Å—å–º–∞" (–∫–æ–Ω—Å—Ç–∞—Ç–∞—Ü–∏—è —Ñ–∞–∫—Ç–∞)
   - "–°–µ—Ä–≥–µ–π –º–Ω–µ –≤—á–µ—Ä–∞ –≥–æ–≤–æ—Ä–∏–ª..." (—Ä–∞—Å—Å–∫–∞–∑ –æ –ø—Ä–æ—à–ª–æ–º)
   - "–°–µ—Ä–≥–µ–π –∞–≤—Ç–æ—Ä –∫—É—Ä—Å–∞" (–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è)

–ö–û–ì–î–ê –ö–õ–ò–ï–ù–¢ –ü–†–û–°–ò–¢ –ù–ê–ü–û–ú–ò–ù–ê–ù–ò–ï –î–õ–Ø –°–ï–ë–Ø - –ù–ï –î–£–ë–õ–ò–†–£–ô –î–õ–Ø –ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–û–†–ê:
‚úÖ –ö–ª–∏–µ–Ω—Ç –ø—Ä–æ—Å–∏—Ç –Ω–∞–ø–æ–º–Ω–∏—Ç—å –µ–º—É:
   - "–ù–∞–ø–æ–º–Ω–∏—Ç–µ –º–Ω–µ –∑–∞–≤—Ç—Ä–∞ –æ–± –æ–ø–ª–∞—Ç–µ"
   - "–Ø —Å–µ–≥–æ–¥–Ω—è –∑–∞–Ω—è—Ç–∞, –Ω–∞–ø–∏—à–∏—Ç–µ –∑–∞–≤—Ç—Ä–∞" 
   - "–ú–æ–∂–µ—Ç–µ –Ω–∞–ø–∏—Å–∞—Ç—å –º–Ω–µ —á–µ—Ä–µ–∑ —á–∞—Å?"
   ‚Üí target_conv_id = conv_id –∫–ª–∏–µ–Ω—Ç–∞ (–ù–ï –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞!)

–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´–ô –§–û–†–ú–ê–¢ –û–ü–ò–°–ê–ù–ò–ô –ù–ê–ü–û–ú–ò–ù–ê–ù–ò–ô:

üîπ –î–õ–Ø –ö–õ–ò–ï–ù–¢–û–í: "[–î–µ–π—Å—Ç–≤–∏–µ] –¥–ª—è [–ò–º—è –ö–ª–∏–µ–Ω—Ç–∞] (conv_id: [ID]) - [–ü—Ä–∏—á–∏–Ω–∞]"
   –ü—Ä–∏–º–µ—Ä: "–ù–∞–ø–∏—Å–∞—Ç—å –Æ–ª–∏–∏ –ë–ª–∞–≥–æ–¥–∞—Ä–æ–≤–æ–π (conv_id: 553547455) –æ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ –∑–∞–≤—Ç—Ä–∞"

üîπ –î–õ–Ø –ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–û–†–ê: "[–î–µ–π—Å—Ç–≤–∏–µ –¥–ª—è admin] - [–ü—Ä–∏—á–∏–Ω–∞] –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞ [–ò–º—è] (conv_id: [ID –∫–ª–∏–µ–Ω—Ç–∞])"
   –ü—Ä–∏–º–µ—Ä: "–°–≤—è–∑–∞—Ç—å—Å—è —Å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º - –∫–ª–∏–µ–Ω—Ç –ú–∞—Ä–∏—è –ò–≤–∞–Ω–æ–≤–∞ (conv_id: 123456) –ø—Ä–æ—Å–∏—Ç –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é"

–ü–†–ò–ú–ï–†–´ –ü–†–ê–í–ò–õ–¨–ù–û–ì–û –û–ü–†–ï–î–ï–õ–ï–ù–ò–Ø target_conv_id:

‚úÖ –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä: "–ü–æ—Å—Ç–∞–≤—å –º–Ω–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –∑–∞–≤—Ç—Ä–∞ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç—á–µ—Ç—ã"
   ‚Üí target_conv_id: {admin_conv_id} (–¢–û–õ–¨–ö–û –æ–¥–Ω–æ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞)
   ‚Üí reminder_context_summary: "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç—á–µ—Ç—ã –ø–æ –∑–∞–¥–∞—á–µ –æ—Ç {admin_conv_id}"

‚úÖ –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä: "–ü–æ—Å—Ç–∞–≤—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ conv_id: 90123456 –∑–∞–≤—Ç—Ä–∞ –æ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏"  
   ‚Üí target_conv_id: 90123456 (–¢–û–õ–¨–ö–û –æ–¥–Ω–æ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞)
   ‚Üí reminder_context_summary: "–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞ (conv_id: 90123456) –ø–æ –∑–∞–ø—Ä–æ—Å—É admin"

‚úÖ –ö–ª–∏–µ–Ω—Ç: "–ü–µ—Ä–µ–¥–∞–π—Ç–µ –°–µ—Ä–≥–µ—é, —á—Ç–æ–±—ã –æ–Ω –º–Ω–µ –Ω–∞–ø–∏—Å–∞–ª"
   ‚Üí target_conv_id: {admin_conv_id} (–¢–û–õ–¨–ö–û –æ–¥–Ω–æ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞)
   ‚Üí reminder_context_summary: "–°–≤—è–∑–∞—Ç—å—Å—è —Å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º - –∫–ª–∏–µ–Ω—Ç [–ò–º—è] (conv_id: [conv_id –∫–ª–∏–µ–Ω—Ç–∞]) –ø—Ä–æ—Å–∏—Ç –∫–æ–Ω—Ç–∞–∫—Ç"

‚úÖ –ö–ª–∏–µ–Ω—Ç: "–ù–∞–ø–æ–º–Ω–∏—Ç–µ –º–Ω–µ –∑–∞–≤—Ç—Ä–∞ –æ–± –æ–ø–ª–∞—Ç–µ"
   ‚Üí target_conv_id: [conv_id –∫–ª–∏–µ–Ω—Ç–∞] (–¢–û–õ–¨–ö–û –æ–¥–Ω–æ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞)
   ‚Üí reminder_context_summary: "–ù–∞–ø–æ–º–Ω–∏—Ç—å [–ò–º—è] (conv_id: [conv_id]) –æ–± –æ–ø–ª–∞—Ç–µ"

‚ùå –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä: "–ü–æ—Å—Ç–∞–≤—å –°–µ—Ä–≥–µ—é –ö–∞–∫–æ—Ä–∏–Ω—É –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –∑–∞–≤—Ç—Ä–∞"
   ‚Üí –ù–ï –°–û–ó–î–ê–í–ê–ô - –Ω–µ—Ç conv_id –¥–ª—è –°–µ—Ä–≥–µ—è –ö–∞–∫–æ—Ä–∏–Ω–∞!

‚ùå –ö–ª–∏–µ–Ω—Ç: "–Ø –Ω–µ –ø–æ–ª—É—á–∞–ª–∞ –æ—Ç –°–µ—Ä–≥–µ—è –ø–∏—Å—å–º–∞"
   ‚Üí –ù–ï –°–û–ó–î–ê–í–ê–ô - –Ω–µ—Ç –ø—Ä–æ—Å—å–±—ã –æ –∫–æ–Ω—Ç–∞–∫—Ç–µ!

–¢–ò–ü–´ –î–û–ì–û–í–û–†–ï–ù–ù–û–°–¢–ï–ô:
- –ü—Ä—è–º—ã–µ –ø—Ä–æ—Å—å–±—ã: "–ù–∞–ø–æ–º–Ω–∏—Ç–µ –º–Ω–µ –∑–∞–≤—Ç—Ä–∞ –≤ 10:00 –æ–± –æ–ø–ª–∞—Ç–µ"
- –ü—Ä—è–º—ã–µ –ø—Ä–æ—Å—å–±—ã —Å –¥–≤–æ–π–Ω—ã–º –≤—Ä–µ–º–µ–Ω–µ–º: "–ù–∞–ø–æ–º–Ω–∏—Ç–µ –º–Ω–µ –∑–∞–≤—Ç—Ä–∞ –≤ 10 —É—Ç—Ä–∞ –æ —Ç–æ–º, —á—Ç–æ–±—ã —è –º–æ–≥ –æ–ø–ª–∞—Ç–∏—Ç—å –≤–µ—á–µ—Ä–æ–º –≤ 18:00"
- –ù–µ—è–≤–Ω—ã–µ –¥–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç–∏: "–ú–Ω–µ –Ω—É–∂–Ω–æ –ø–æ–¥—É–º–∞—Ç—å –¥–æ –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫–∞"
- –ü—Ä–æ—Å—å–±—ã —Å–≤—è–∑–∞—Ç—å—Å—è —Å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º: "–ü–µ—Ä–µ–¥–∞–π—Ç–µ –°–µ—Ä–≥–µ—é, —á—Ç–æ–±—ã –æ–Ω –Ω–∞–ø–∏—Å–∞–ª"
- –û—Ç–º–µ–Ω–∞ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è: "–°–ø–∞—Å–∏–±–æ, —É–∂–µ –Ω–µ –Ω—É–∂–Ω–æ –Ω–∞–ø–æ–º–∏–Ω–∞—Ç—å"
- –ü–µ—Ä–µ–Ω–æ—Å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è: "–î–∞–≤–∞–π—Ç–µ –ø–µ—Ä–µ–Ω–µ—Å–µ–º –Ω–∞ –≤—Ç–æ—Ä–Ω–∏–∫"

üìã –°–ü–ï–¶–ò–ê–õ–¨–ù–´–ï –°–¶–ï–ù–ê–†–ò–ò - –°–û–ì–õ–ê–°–ò–ï/–û–¢–ö–ê–ó –ù–ê –ü–†–ï–î–õ–û–ñ–ï–ù–ò–Ø –ê–°–°–ò–°–¢–ï–ù–¢–ê:

‚úÖ –°–û–ì–õ–ê–°–ò–ï –ù–ê –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï –ê–°–°–ò–°–¢–ï–ù–¢–ê –û –ù–ê–ü–û–ú–ò–ù–ê–ù–ò–ò:
–ö–æ–Ω—Ç–µ–∫—Å—Ç: –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–º —Å–æ–æ–±—â–µ–Ω–∏–∏
–ö–ª–∏–µ–Ω—Ç —Å–æ–≥–ª–∞—à–∞–µ—Ç—Å—è:
- "–î–∞, –∫–æ–Ω–µ—á–Ω–æ"
- "–•–æ—Ä–æ—à–æ"
- "–î–∞, –¥–∞–≤–∞–π—Ç–µ"
- "–°–æ–≥–ª–∞—Å–Ω–∞"
- "–ú–æ–∂–Ω–æ"
‚Üí –°–æ–∑–¥–∞–π –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –Ω–∞ –≤—Ä–µ–º—è, –∫–æ—Ç–æ—Ä–æ–µ –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç –ø—Ä–µ–¥–ª–æ–∂–∏–ª –≤ –ü–†–ï–î–´–î–£–©–ï–ú —Å–æ–æ–±—â–µ–Ω–∏–∏

–ü—Ä–∏–º–µ—Ä –¥–∏–∞–ª–æ–≥–∞:
–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç: "–Ø –º–æ–≥—É –í–∞–º –º—è–≥–∫–æ –Ω–∞–ø–æ–º–Ω–∏—Ç—å —á–µ—Ä–µ–∑ –Ω–µ–¥–µ–ª—é –æ –Ω–∞—à–µ–º —Ä–∞–∑–≥–æ–≤–æ—Ä–µ?"
–ö–ª–∏–µ–Ω—Ç: "–î–∞, –∫–æ–Ω–µ—á–Ω–æ"
‚Üí proposed_datetime: —á–µ—Ä–µ–∑ 7 –¥–Ω–µ–π –≤ 19:00
‚Üí reminder_context_summary: "–ú—è–≥–∫–æ –Ω–∞–ø–æ–º–Ω–∏—Ç—å –æ —Ä–∞–∑–≥–æ–≤–æ—Ä–µ"

‚ùå –û–¢–ö–ê–ó –û–¢ –ù–ê–ü–û–ú–ò–ù–ê–ù–ò–Ø:
–ö–ª–∏–µ–Ω—Ç –æ—Ç–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è:
- "–ù–µ—Ç, –Ω–µ –ø–∏—à–∏—Ç–µ"
- "–ù–µ –Ω—É–∂–Ω–æ"
- "–ù–µ –Ω–∞–¥–æ –Ω–∞–ø–æ–º–∏–Ω–∞—Ç—å"
- "–ü–æ–∫–∞ –Ω–µ –ø–∏—à–∏—Ç–µ"
‚Üí action: "cancel" - –æ—Ç–º–µ–Ω–∏—Ç—å –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –¥–ª—è —ç—Ç–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞

‚ö†Ô∏è –°–û–ì–õ–ê–°–ò–ï –ù–ê –ê–õ–¨–¢–ï–†–ù–ê–¢–ò–í–ù–û–ï –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï:
–ö–æ–Ω—Ç–µ–∫—Å—Ç: –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –¥—Ä—É–≥–æ–π —Å—Ä–æ–∫ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –ø–æ—Å–ª–µ –æ—Ç–∫–∞–∑–∞
–ö–ª–∏–µ–Ω—Ç —Å–æ–≥–ª–∞—à–∞–µ—Ç—Å—è:
- "–î–∞, —Ö–æ—Ä–æ—à–æ"
- "–ß–µ—Ä–µ–∑ –º–µ—Å—è—Ü –º–æ–∂–Ω–æ"
- "–°–æ–≥–ª–∞—Å–Ω–∞ –Ω–∞ –º–µ—Å—è—Ü"
‚Üí –°–æ–∑–¥–∞–π –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –Ω–∞ –Ω–æ–≤—ã–π —Å—Ä–æ–∫, –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã–π –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç–æ–º

–ü—Ä–∏–º–µ—Ä –¥–∏–∞–ª–æ–≥–∞:
–ö–ª–∏–µ–Ω—Ç: "–ù–µ—Ç, –Ω–µ –ø–∏—à–∏—Ç–µ"
–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç: "–ê —á—Ç–æ –µ—Å–ª–∏ —è –Ω–∞–ø–∏—à—É –í–∞–º —á–µ—Ä–µ–∑ –º–µ—Å—è—Ü?"
–ö–ª–∏–µ–Ω—Ç: "–î–∞, —Ö–æ—Ä–æ—à–æ"
‚Üí proposed_datetime: —á–µ—Ä–µ–∑ 30 –¥–Ω–µ–π –≤ 19:00
‚Üí reminder_context_summary: "–ú—è–≥–∫–æ –Ω–∞–ø–æ–º–Ω–∏—Ç—å –æ —Ä–∞–∑–≥–æ–≤–æ—Ä–µ"

üîç –ö–ê–ö –û–ü–†–ï–î–ï–õ–ò–¢–¨ –ö–û–ù–¢–ï–ö–°–¢ –ò–ó –ü–†–ï–î–´–î–£–©–ò–• –°–û–û–ë–©–ï–ù–ò–ô:
- –ò—â–∏ –≤ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 3-5 —Å–æ–æ–±—â–µ–Ω–∏—è—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ —Å–æ —Å–ª–æ–≤–∞–º–∏: "–Ω–∞–ø–æ–º–Ω—é", "–Ω–∞–ø–∏—à—É", "—Å–≤—è–∂—É—Å—å"
- –ò–∑–≤–ª–µ–∫–∞–π –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã: "—á–µ—Ä–µ–∑ –Ω–µ–¥–µ–ª—é", "—á–µ—Ä–µ–∑ –º–µ—Å—è—Ü", "–∑–∞–≤—Ç—Ä–∞", "—á–µ—Ä–µ–∑ 3 –¥–Ω—è"
- –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç —Å–æ–≥–ª–∞—à–∞–µ—Ç—Å—è –ë–ï–ó –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ - –ù–ï —Å–æ–∑–¥–∞–≤–∞–π –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ

–í–ê–ñ–ù–û: –≠—Ç–∏ –ø—Ä–∞–≤–∏–ª–∞ —Ä–∞–±–æ—Ç–∞—é—Ç –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –≤ –¥–∏–∞–ª–æ–≥–µ –µ—Å—Ç—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –æ—Ç –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞!

–ü–†–ò–ú–ï–†–´ –ï–°–¢–ï–°–¢–í–ï–ù–ù–´–• –ü–†–û–°–¨–ë:
- –ö–ª–∏–µ–Ω—Ç: "–ù–∞–ø–æ–º–Ω–∏—Ç–µ –º–Ω–µ –∑–∞–≤—Ç—Ä–∞ –≤ 15:00 –æ–± –æ–ø–ª–∞—Ç–µ –∫—É—Ä—Å–∞"
- –ö–ª–∏–µ–Ω—Ç: "–ü–µ—Ä–µ–¥–∞–π—Ç–µ –°–µ—Ä–≥–µ—é, —á—Ç–æ —è –≥–æ—Ç–æ–≤–∞ –∫ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏" ‚Üí –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
- –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä: "–ü–æ—Å—Ç–∞–≤—å –º–Ω–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –Ω–∞ 16:30 –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç—á–µ—Ç—ã"  
- –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä: "–ü–æ—Å—Ç–∞–≤—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ conv_id: 90123456 –∑–∞–≤—Ç—Ä–∞ –æ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏"

–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –†–ê–ó–õ–ò–ß–ê–ô –í–†–ï–ú–Ø –ù–ê–ü–û–ú–ò–ù–ê–ù–ò–Ø –ò –í–†–ï–ú–Ø –°–û–ë–´–¢–ò–Ø!

–í–†–ï–ú–Ø –ù–ê–ü–û–ú–ò–ù–ê–ù–ò–Ø (proposed_datetime) = –∫–æ–≥–¥–∞ –¥–æ–ª–∂–Ω–æ —Å—Ä–∞–±–æ—Ç–∞—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ
–í–†–ï–ú–Ø –°–û–ë–´–¢–ò–Ø (reminder_context_summary) = –æ —á–µ–º –Ω–∞–ø–æ–º–Ω–∏—Ç—å

–ü–†–ò–ú–ï–†–´ –ü–†–ê–í–ò–õ–¨–ù–û–ô –ò–ù–¢–ï–†–ü–†–ï–¢–ê–¶–ò–ò:
‚úÖ "–ù–∞–ø–æ–º–Ω–∏ –º–Ω–µ –∑–∞–≤—Ç—Ä–∞ –≤ 10 —É—Ç—Ä–∞ –æ —Ç–æ–º, —á—Ç–æ –≤ 13:00 –∑–∞–º–µ–Ω–∞ –º–∞—Å–ª–∞"
   ‚Üí proposed_datetime: –∑–∞–≤—Ç—Ä–∞ 10:00
   ‚Üí reminder_context_summary: "–ó–∞–º–µ–Ω–∞ –º–∞—Å–ª–∞ –≤ 13:00"

‚úÖ "–ù–∞–ø–æ–º–Ω–∏ –º–Ω–µ –∑–∞–≤—Ç—Ä–∞ –≤ 12:00 –ø–æ –ú–æ—Å–∫–≤–µ, —á—Ç–æ –ø–æ—Ä–∞ –≤ –±–æ–ª—å–Ω–∏—Ü—É"
   ‚Üí proposed_datetime: [–≤—Ä–µ–º—è, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–µ 12:00 –ú–°–ö, –Ω–æ –≤ —á–∞—Å–æ–≤–æ–º –ø–æ—è—Å–µ –∫–ª–∏–µ–Ω—Ç–∞, —Ç.–µ. 15:00 –ø–æ –û–º—Å–∫—É]
   ‚Üí reminder_context_summary: "–ü–æ—Ä–∞ –≤ –±–æ–ª—å–Ω–∏—Ü—É (–Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –±—ã–ª–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –Ω–∞ 12:00 –ø–æ –ú–æ—Å–∫–≤–µ)"

‚úÖ "–ü–µ—Ä–µ–¥–∞–π—Ç–µ –°–µ—Ä–≥–µ—é, —á—Ç–æ–±—ã –æ–Ω –Ω–∞–ø–∏—Å–∞–ª –º–Ω–µ –∑–∞–≤—Ç—Ä–∞"
   ‚Üí proposed_datetime: –∑–∞–≤—Ç—Ä–∞ 10:00
   ‚Üí target_conv_id: {admin_conv_id}
   ‚Üí reminder_context_summary: "–ö–ª–∏–µ–Ω—Ç [–∏–º—è], conv_id: [conv_id –∫–ª–∏–µ–Ω—Ç–∞] –ø—Ä–æ—Å–∏—Ç —Å–≤—è–∑–∞—Ç—å—Å—è –∑–∞–≤—Ç—Ä–∞"

‚úÖ "–ù–∞–ø–æ–º–Ω–∏ –º–Ω–µ –≤ 15:00 –æ–± –æ–ø–ª–∞—Ç–µ –∫—É—Ä—Å–∞"
   ‚Üí proposed_datetime: —Å–µ–≥–æ–¥–Ω—è/–∑–∞–≤—Ç—Ä–∞ 15:00
   ‚Üí reminder_context_summary: "–û–± –æ–ø–ª–∞—Ç–µ –∫—É—Ä—Å–∞"

‚úÖ "–ù–∞–ø–æ–º–Ω–∏ –º–Ω–µ –≤–µ—á–µ—Ä–æ–º –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ—á—Ç—É"
   ‚Üí proposed_datetime: —Å–µ–≥–æ–¥–Ω—è 19:00
   ‚Üí reminder_context_summary: "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ—á—Ç—É"

‚úÖ "–ù–∞–ø–æ–º–Ω–∏ –º–Ω–µ –∑–∞ —á–∞—Å –¥–æ –≤—Å—Ç—Ä–µ—á–∏ –≤ 14:00"
   ‚Üí proposed_datetime: —Å–µ–≥–æ–¥–Ω—è 13:00
   ‚Üí reminder_context_summary: "–í—Å—Ç—Ä–µ—á–∞ –≤ 14:00"

üìã –ü–†–ò–ú–ï–†–´ –ò–ù–¢–ï–†–ü–†–ï–¢–ê–¶–ò–ò:

‚úÖ –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç: "–Ø –º–æ–≥—É –í–∞–º –º—è–≥–∫–æ –Ω–∞–ø–æ–º–Ω–∏—Ç—å —á–µ—Ä–µ–∑ –Ω–µ–¥–µ–ª—é –æ –Ω–∞—à–µ–º —Ä–∞–∑–≥–æ–≤–æ—Ä–µ?"
   ‚Üí proposed_datetime: —á–µ—Ä–µ–∑ 7 –¥–Ω–µ–π –≤ 19:00
   ‚Üí target_conv_id: [conv_id –∫–ª–∏–µ–Ω—Ç–∞]
   ‚Üí reminder_context_summary: "–ú—è–≥–∫–æ –Ω–∞–ø–æ–º–Ω–∏—Ç—å –æ —Ä–∞–∑–≥–æ–≤–æ—Ä–µ"

‚úÖ –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç: "–•–æ—Ä–æ—à–æ, —è –ø–æ—Å—Ç–∞–≤–ª—é —Å–µ–±–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –∏ —á–µ—Ä–µ–∑ –Ω–µ–¥–µ–ª—é –º—è–≥–∫–æ –Ω–∞–ø–æ–º–Ω—é –æ —Å–µ–±–µ"
   ‚Üí proposed_datetime: —á–µ—Ä–µ–∑ 7 –¥–Ω–µ–π –≤ 19:00
   ‚Üí target_conv_id: [conv_id –∫–ª–∏–µ–Ω—Ç–∞]  
   ‚Üí reminder_context_summary: "–ú—è–≥–∫–æ –Ω–∞–ø–æ–º–Ω–∏—Ç—å –æ —Ä–∞–∑–≥–æ–≤–æ—Ä–µ"

‚ùå –ö–ª–∏–µ–Ω—Ç: "–ù–µ—Ç, –Ω–µ –ø–∏—à–∏—Ç–µ"
   ‚Üí action: "cancel"
   ‚Üí target_conv_id: [conv_id –∫–ª–∏–µ–Ω—Ç–∞]
   ‚Üí cancellation_reason: "–ö–ª–∏–µ–Ω—Ç –ø–æ–ø—Ä–æ—Å–∏–ª –Ω–µ –ø–∏—Å–∞—Ç—å"

‚úÖ –î–∏–∞–ª–æ–≥ (–ø–æ—Å–ª–µ –æ—Ç–∫–∞–∑–∞):
–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç: "–ê —á—Ç–æ –µ—Å–ª–∏ —è –Ω–∞–ø–∏—à—É –í–∞–º —á–µ—Ä–µ–∑ –º–µ—Å—è—Ü?"
–ö–ª–∏–µ–Ω—Ç: "–î–∞, —Ö–æ—Ä–æ—à–æ"
–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç: "–•–æ—Ä–æ—à–æ, —è –ø–æ—Å—Ç–∞–≤–ª—é —Å–µ–±–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ"
   ‚Üí proposed_datetime: —á–µ—Ä–µ–∑ 30 –¥–Ω–µ–π –≤ 19:00
   ‚Üí target_conv_id: [conv_id –∫–ª–∏–µ–Ω—Ç–∞]
   ‚Üí reminder_context_summary: "–ú—è–≥–∫–æ –Ω–∞–ø–æ–º–Ω–∏—Ç—å –æ —Ä–∞–∑–≥–æ–≤–æ—Ä–µ"

–ü–†–ê–í–ò–õ–ê –ò–ù–¢–ï–†–ü–†–ï–¢–ê–¶–ò–ò –í–†–ï–ú–ï–ù–ò –ù–ê–ü–û–ú–ò–ù–ê–ù–ò–Ø:
- "–ó–∞–≤—Ç—Ä–∞" = —Å–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å –≤ 10:00
- "–£—Ç—Ä–æ–º" = 10:00 —Ç–µ–∫—É—â–µ–≥–æ/—Å–ª–µ–¥—É—é—â–µ–≥–æ –¥–Ω—è
- "–î–Ω–µ–º" = 14:00 —Ç–µ–∫—É—â–µ–≥–æ/—Å–ª–µ–¥—É—é—â–µ–≥–æ –¥–Ω—è
- "–í–µ—á–µ—Ä–æ–º" = 19:00 —Ç–µ–∫—É—â–µ–≥–æ/—Å–ª–µ–¥—É—é—â–µ–≥–æ –¥–Ω—è
- "–ß–µ—Ä–µ–∑ –ø–∞—Ä—É –¥–Ω–µ–π" = —á–µ—Ä–µ–∑ 2 –¥–Ω—è –≤ 12:00
- "–ù–∞ —Å–ª–µ–¥—É—é—â–µ–π –Ω–µ–¥–µ–ª–µ" = –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ —Å–ª–µ–¥—É—é—â–µ–π –Ω–µ–¥–µ–ª–∏ –≤ 12:00
- –ö–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –≤—Ä–µ–º—è ("–≤ 10:00", "–≤ 15:30") = —Ç–æ—á–Ω–æ–µ —É–∫–∞–∑–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è
- –ï—Å–ª–∏ –≤—Ä–µ–º—è –Ω–µ —É–∫–∞–∑–∞–Ω–æ –¥–ª—è –ø—Ä–æ—Å—å–±—ã —Å–≤—è–∑–∞—Ç—å—Å—è —Å –°–µ—Ä–≥–µ–µ–º = —Å–µ–≥–æ–¥–Ω—è 19:00

üìã –ü–†–ê–í–ò–õ–ê –î–õ–Ø –°–û–ì–õ–ê–°–ò–ô –ù–ê –ü–†–ï–î–õ–û–ñ–ï–ù–ò–Ø –ê–°–°–ò–°–¢–ï–ù–¢–ê:
- "—á–µ—Ä–µ–∑ –Ω–µ–¥–µ–ª—é" (–∏–∑ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞) = —á–µ—Ä–µ–∑ 7 –¥–Ω–µ–π –≤ 19:00
- "—á–µ—Ä–µ–∑ –º–µ—Å—è—Ü" (–∏–∑ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞) = —á–µ—Ä–µ–∑ 30 –¥–Ω–µ–π –≤ 19:00  
- "—á–µ—Ä–µ–∑ 3 –¥–Ω—è" (–∏–∑ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞) = —á–µ—Ä–µ–∑ 3 –¥–Ω—è –≤ 19:00
- –ï—Å–ª–∏ –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç –ø—Ä–µ–¥–ª–æ–∂–∏–ª –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –≤—Ä–µ–º—è - –∏—Å–ø–æ–ª—å–∑—É–π –µ–≥–æ
- –ï—Å–ª–∏ –≤—Ä–µ–º—è –Ω–µ —É–∫–∞–∑–∞–Ω–æ –≤ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–∏ –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ = —Å–µ–≥–æ–¥–Ω—è 19:00

–¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è (–≤ —á–∞—Å–æ–≤–æ–º –ø–æ—è—Å–µ –∫–ª–∏–µ–Ω—Ç–∞, {client_timezone}): {current_client_time}
ID —Ç–µ–∫—É—â–µ–≥–æ –¥–∏–∞–ª–æ–≥–∞: {conv_id}

========================================
+--- –ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï ---
========================================
{user_info}
========================================

========================================
--- –ü–û–°–õ–ï–î–ù–ò–ï –°–û–û–ë–©–ï–ù–ò–Ø –î–ò–ê–õ–û–ì–ê ---
========================================
‚è∞ –§–û–†–ú–ê–¢: –ö–∞–∂–¥–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –≤—Ä–µ–º–µ–Ω–Ω—É—é –º–µ—Ç–∫—É [YYYY-MM-DD HH:MM:SS]
üìù –ò–°–ü–û–õ–¨–ó–£–ô –ú–ï–¢–ö–ò –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —Å–æ–±—ã—Ç–∏–π
{dialogue_messages}
========================================

========================================
--- –ê–ö–¢–ò–í–ù–´–ï –ù–ê–ü–û–ú–ò–ù–ê–ù–ò–Ø –î–õ–Ø –≠–¢–û–ì–û –ö–õ–ò–ï–ù–¢–ê ---
========================================
{active_reminders}
========================================

üí° –ì–õ–ê–í–ù–û–ï –ü–†–ê–í–ò–õ–û: –û–î–ù–ê –ü–†–û–°–¨–ë–ê ‚Äî –û–î–ù–û –ù–ê–ü–û–ú–ò–ù–ê–ù–ò–ï.

üö´ –ù–ï –°–û–ó–î–ê–í–ê–ô –ù–û–í–û–ï –ù–ê–ü–û–ú–ò–ù–ê–ù–ò–ï, –ï–°–õ–ò:
1. ‚úÖ –í —Å–ø–∏—Å–∫–µ "–ê–ö–¢–ò–í–ù–´–ï –ù–ê–ü–û–ú–ò–ù–ê–ù–ò–Ø" —É–∂–µ –µ—Å—Ç—å —Ç–æ—á–Ω–æ —Ç–∞–∫–æ–µ –∂–µ –∏–ª–∏ –æ—á–µ–Ω—å –ø–æ—Ö–æ–∂–µ–µ –ø–æ —Å–º—ã—Å–ª—É –∏ –≤—Ä–µ–º–µ–Ω–∏. –≠—Ç–æ —Ç–≤–æ–π –≥–ª–∞–≤–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∞–≤–¥—ã.
2. ‚úÖ –ö–ª–∏–µ–Ω—Ç –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç –æ–±—Å—É–∂–¥–∞—Ç—å –¥–µ—Ç–∞–ª–∏ —É–∂–µ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ–≥–æ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è, –Ω–µ —Å–æ–∑–¥–∞–≤–∞—è –Ω–æ–≤–æ–π –ø—Ä–æ—Å—å–±—ã.
3. ‚úÖ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –ø—Ä–æ–≤–µ—Ä—è–π –∫–∞–∂–¥–æ–µ –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º–æ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –ø—Ä–æ—Ç–∏–≤ —Å–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö. –î–∞–∂–µ –Ω–µ–±–æ–ª—å—à–∞—è —Å—Ö–æ–∂–µ—Å—Ç—å (>50% –æ–±—â–∏—Ö —Å–ª–æ–≤) - –ø–æ–≤–æ–¥ –ù–ï —Å–æ–∑–¥–∞–≤–∞—Ç—å –¥—É–±–ª–∏–∫–∞—Ç.
4. ‚úÖ –ü—Ä–∏ –ª—é–±—ã—Ö —Å–æ–º–Ω–µ–Ω–∏—è—Ö - –ª—É—á—à–µ –ù–ï —Å–æ–∑–¥–∞–≤–∞—Ç—å –Ω–æ–≤–æ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ, —á–µ–º —Å–æ–∑–¥–∞—Ç—å –¥—É–±–ª–∏–∫–∞—Ç.

‚úÖ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –°–û–ó–î–ê–ô –ù–ê–ü–û–ú–ò–ù–ê–ù–ò–ï, –ï–°–õ–ò:
1. ‚úÖ –ö–ª–∏–µ–Ω—Ç –ø–æ–ø—Ä–æ—Å–∏–ª –Ω–∞–ø–æ–º–Ω–∏—Ç—å, –∞ –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç –≤ –æ—Ç–≤–µ—Ç –ø–æ–æ–±–µ—â–∞–ª —ç—Ç–æ —Å–¥–µ–ª–∞—Ç—å ("—Ö–æ—Ä–æ—à–æ, –Ω–∞–ø–æ–º–Ω—é", "–ø–æ—Å—Ç–∞–≤–∏–ª –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ"). –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –≤—ã–ø–æ–ª–Ω–∏—Ç—å —ç—Ç–æ –æ–±–µ—â–∞–Ω–∏–µ! –û—Ç–≤–µ—Ç –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ ‚Äî —ç—Ç–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è, –∞ –Ω–µ –ø—Ä–∏–∑–Ω–∞–∫ —Ç–æ–≥–æ, —á—Ç–æ –æ–Ω–æ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.

üîç –ü–†–ò–ú–ï–†–´ –ê–ù–ê–õ–ò–ó–ê:

–°—Ü–µ–Ω–∞—Ä–∏–π 1:
[14:30] –ö–ª–∏–µ–Ω—Ç: –Ω–∞–ø–∏—à–∏—Ç–µ –∑–∞–≤—Ç—Ä–∞
[14:31] –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç: —Ö–æ—Ä–æ—à–æ, –Ω–∞–ø–æ–º–Ω—é
‚Üí –†–ï–®–ï–ù–ò–ï: ‚úÖ –°–æ–∑–¥–∞–≤–∞–π –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ! –û—Ç–≤–µ—Ç –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ ‚Äî —ç—Ç–æ —Ç–≤–æ—è –∫–æ–º–∞–Ω–¥–∞ –∫ –¥–µ–π—Å—Ç–≤–∏—é.

–°—Ü–µ–Ω–∞—Ä–∏–π 2: (–ê–≥–µ–Ω—Ç –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è —Å–Ω–æ–≤–∞ –ø–æ—Å–ª–µ —Å–ª–µ–¥—É—é—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞)
[14:30] –ö–ª–∏–µ–Ω—Ç: –Ω–∞–ø–∏—à–∏—Ç–µ –∑–∞–≤—Ç—Ä–∞
[14:31] –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç: —Ö–æ—Ä–æ—à–æ, –Ω–∞–ø–æ–º–Ω—é
[14:32] –ö–ª–∏–µ–Ω—Ç: —è –±—É–¥—É –¥–æ–º–∞
[14:33] –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç: –¥–∞, —è –ø–æ—Å—Ç–∞–≤–∏–ª –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ
[–°–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π]: "–ù–∞–ø–æ–º–Ω–∏—Ç—å –∑–∞–≤—Ç—Ä–∞"
‚Üí –†–ï–®–ï–ù–ò–ï: üö´ –ù–ï —Å–æ–∑–¥–∞–≤–∞–π –Ω–æ–≤–æ–µ! –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ —É–∂–µ –µ—Å—Ç—å –≤ –∞–∫—Ç–∏–≤–Ω—ã—Ö. –°–æ–æ–±—â–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞ ‚Äî –ª–∏—à—å –¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –¥–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç–∏.

–°—Ü–µ–Ω–∞—Ä–∏–π 3:
[14:30] –ö–ª–∏–µ–Ω—Ç: –Ω–∞–ø–∏—à–∏—Ç–µ –∑–∞–≤—Ç—Ä–∞  
[14:31] –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç: —Ö–æ—Ä–æ—à–æ, –Ω–∞–ø–æ–º–Ω—é
[14:35] –ö–ª–∏–µ–Ω—Ç: –∏ –µ—â–µ –Ω–∞–ø–æ–º–Ω–∏—Ç–µ –≤ –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ ‚Üê –ù–û–í–ê–Ø –ø—Ä–æ—Å—å–±–∞
[14:37] –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç: —Ö–æ—Ä–æ—à–æ
‚Üí –†–ï–®–ï–ù–ò–ï: ‚úÖ –°–æ–∑–¥–∞–≤–∞–π –Ω–æ–≤–æ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –Ω–∞ –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫. –≠—Ç–æ –æ—Ç–¥–µ–ª—å–Ω–∞—è, –Ω–æ–≤–∞—è –ø—Ä–æ—Å—å–±–∞.

========================================
--- –ü–û–ö–£–ü–ö–ò –ö–õ–ò–ï–ù–¢–ê ---
========================================
{client_purchases}

–í–ï–†–ù–ò –û–¢–í–ï–¢ –°–¢–†–û–ì–û –í –§–û–†–ú–ê–¢–ï JSON, —Å–æ–¥–µ—Ä–∂–∞—â–∏–π –°–ü–ò–°–û–ö –≤—Å–µ—Ö –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π.
–ï—Å–ª–∏ –¥–µ–π—Å—Ç–≤–∏–π –Ω–µ—Ç, –≤–µ—Ä–Ω–∏: {{"reminders": []}}.
–ü–û–ú–ù–ò: –ù–ê –û–î–ù–£ –ü–†–û–°–¨–ë–£ - –¢–û–õ–¨–ö–û –û–î–ù–û –ù–ê–ü–û–ú–ò–ù–ê–ù–ò–ï!
[
  {{
    "action": "create/update/cancel/none",
    "target_conv_id": 12345678,
    "proposed_datetime": "YYYY-MM-DDTHH:MM:SS{client_timezone_offset}",
    "reminder_context_summary": "–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–∏—á–∏–Ω—ã –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è",
    "cancellation_reason": "–ü—Ä–∏—á–∏–Ω–∞ –æ—Ç–º–µ–Ω—ã (—Ç–æ–ª—å–∫–æ –¥–ª—è action=cancel)",
    "none_reason": "–ü—Ä–∏—á–∏–Ω–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è –¥–µ–π—Å—Ç–≤–∏—è (–¥–ª—è action=none, –Ω–∞–ø—Ä–∏–º–µ—Ä: '–Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ')"
  }}
]
"""

# –ü–†–û–ú–ü–¢ –î–õ–Ø –ü–†–û–í–ï–†–ö–ò –ê–ö–¢–£–ê–õ–¨–ù–û–°–¢–ò –£–î–ê–õ–ï–ù
# –¢–µ–ø–µ—Ä—å –≤—Å–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –∞–∫—Ç–∏–≤–∏—Ä—É—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –±–µ–∑ –ò–ò-–ø—Ä–æ–≤–µ—Ä–∫–∏

# --- –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ---

def setup_logging():
    """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–∏—Å—Ç–µ–º—ã –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è."""
    logging.basicConfig(
        level=logging.INFO,
        format='%(asctime)s - %(levelname)s - %(funcName)s - %(message)s',
        handlers=[
            logging.FileHandler(LOG_FILE_NAME, mode='a', encoding='utf-8'),
            logging.StreamHandler(sys.stdout)
        ]
    )

def get_db_connection():
    """–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –ë–î."""
    if not DATABASE_URL:
        raise ConnectionError("–ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–∫—Ä—É–∂–µ–Ω–∏—è DATABASE_URL –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞!")
    return psycopg2.connect(DATABASE_URL)

def call_gemini_api(model, prompt, expect_json=True):
    """–í—ã–∑—ã–≤–∞–µ—Ç –º–æ–¥–µ–ª—å Gemini —á–µ—Ä–µ–∑ Vertex AI SDK."""
    try:
        # logging.info(f"–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –≤ Gemini. –ü—Ä–æ–º–ø—Ç (–ø–µ—Ä–≤—ã–µ 200 —Å–∏–º–≤–æ–ª–æ–≤): {prompt[:200]}...")
        
        response = model.generate_content(prompt)
        raw_response = response.text
        
        # logging.info(f"–ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç –æ—Ç Gemini (–¥–ª–∏–Ω–∞: {len(raw_response)} —Å–∏–º–≤–æ–ª–æ–≤)")
        # logging.info(f"–°—ã—Ä–æ–π –æ—Ç–≤–µ—Ç –æ—Ç Gemini: {raw_response}")
        
        if expect_json:
            # –£–ª—É—á—à–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è JSON –∏–∑ –æ—Ç–≤–µ—Ç–∞
            # –°–Ω–∞—á–∞–ª–∞ –∏—â–µ–º JSON –≤ markdown-–±–ª–æ–∫–µ
            match = re.search(r"```(json)?\s*([\s\S]*?)\s*```", raw_response)
            if match:
                json_str = match.group(2)
            else:
                # –ï—Å–ª–∏ markdown-–±–ª–æ–∫–∞ –Ω–µ—Ç, –∏—â–µ–º –ø–µ—Ä–≤—ã–π —Å–∏–º–≤–æ–ª '{' –∏–ª–∏ '['
                start_index = -1
                for i, char in enumerate(raw_response):
                    if char in ('{', '['):
                        start_index = i
                        break
                if start_index != -1:
                    json_str = raw_response[start_index:]
                else:
                    json_str = raw_response
            
            # –£–¥–∞–ª—è–µ–º —É–ø—Ä–∞–≤–ª—è—é—â–∏–µ —Å–∏–º–≤–æ–ª—ã –≤ –Ω–∞—á–∞–ª–µ —Å—Ç—Ä–æ–∫–∏, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
            json_str = json_str.strip()

            parsed_response = json.loads(json_str)
            # logging.info(f"JSON —É—Å–ø–µ—à–Ω–æ —Ä–∞—Å–ø–∞—Ä—Å–µ–Ω: {parsed_response}")
            return parsed_response
        else:
            return raw_response.strip()

    except json.JSONDecodeError as je:
        logging.error(f"–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON –æ—Ç Gemini: {je}. –°—ã—Ä–æ–π –æ—Ç–≤–µ—Ç: {raw_response}")
        raise
    except Exception as e:
        logging.error(f"–û—à–∏–±–∫–∞ –≤—ã–∑–æ–≤–∞ Vertex AI API: {e}", exc_info=True)
        raise

def get_timezone_offset_str(tz_name):
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç—Ä–æ–∫–æ–≤–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —Å–º–µ—â–µ–Ω–∏—è UTC –¥–ª—è —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å–∞."""
    try:
        tz = pytz.timezone(tz_name)
        offset = datetime.now(tz).utcoffset()
        offset_hours = offset.total_seconds() / 3600
        return f"{offset_hours:+03.0f}:00".replace('.0', '')
    except pytz.UnknownTimeZoneError:
        return "+03:00" # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –ú–æ—Å–∫–≤–∞
        
def get_moscow_time():
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—É—â–µ–µ –º–æ—Å–∫–æ–≤—Å–∫–æ–µ –≤—Ä–µ–º—è."""
    moscow_tz = pytz.timezone('Europe/Moscow')
    return datetime.now(moscow_tz)

def send_telegram_notification(message):
    """
    –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.
    """
    if not TELEGRAM_TOKEN or not ADMIN_CHAT_ID:
        logging.warning("TELEGRAM –£–í–ï–î–û–ú–õ–ï–ù–ò–ï: –ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã TELEGRAM_TOKEN –∏–ª–∏ ADMIN_CHAT_ID")
        return False
    
    try:
        telegram_url = f"https://api.telegram.org/bot{TELEGRAM_TOKEN}/sendMessage"
        
        payload = {
            "chat_id": ADMIN_CHAT_ID,
            "text": f"üö® –û–®–ò–ë–ö–ê –°–ï–†–í–ò–°–ê –ù–ê–ü–û–ú–ò–ù–ê–ù–ò–ô\n\n{message}",
            "parse_mode": "HTML"
        }
        
        response = requests.post(telegram_url, json=payload, timeout=10)
        response.raise_for_status()
        
        logging.info(f"TELEGRAM –£–í–ï–î–û–ú–õ–ï–ù–ò–ï: –£—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç {ADMIN_CHAT_ID}")
        return True
        
    except Exception as e:
        logging.error(f"TELEGRAM –£–í–ï–î–û–ú–õ–ï–ù–ò–ï: –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Telegram: {e}")
        return False

def track_activation_failure(reminder_id, error_message):
    """
    –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –Ω–µ—É–¥–∞—á–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è.
    –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram –ø–æ—Å–ª–µ MAX_RETRY_ATTEMPTS –Ω–µ—É–¥–∞—á–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫.
    """
    global failed_activation_attempts
    
    current_time = datetime.now(timezone.utc)
    
    if reminder_id not in failed_activation_attempts:
        failed_activation_attempts[reminder_id] = {
            "attempts": 1,
            "last_error": error_message,
            "first_attempt": current_time
        }
        logging.info(f"–ú–û–ù–ò–¢–û–†–ò–ù–ì –û–®–ò–ë–û–ö: –ü–µ—Ä–≤–∞—è –Ω–µ—É–¥–∞—á–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –¥–ª—è reminder_id={reminder_id}")
    else:
        failed_activation_attempts[reminder_id]["attempts"] += 1
        failed_activation_attempts[reminder_id]["last_error"] = error_message
        
        attempts = failed_activation_attempts[reminder_id]["attempts"]
        logging.warning(f"–ú–û–ù–ò–¢–û–†–ò–ù–ì –û–®–ò–ë–û–ö: –ü–æ–ø—ã—Ç–∫–∞ #{attempts} –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –¥–ª—è reminder_id={reminder_id} –Ω–µ—É–¥–∞—á–Ω–∞")
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ MAX_RETRY_ATTEMPTS –ø–æ–ø—ã—Ç–æ–∫
        if attempts >= MAX_RETRY_ATTEMPTS:
            first_attempt = failed_activation_attempts[reminder_id]["first_attempt"]
            duration = current_time - first_attempt
            
            message = (
                f"<b>–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ ID {reminder_id} –Ω–µ —É–¥–∞–µ—Ç—Å—è –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å</b>\n\n"
                f"üìä <b>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:</b>\n"
                f"‚Ä¢ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫: {attempts}\n"
                f"‚Ä¢ –ü–µ—Ä–≤–∞—è –ø–æ–ø—ã—Ç–∫–∞: {first_attempt.strftime('%Y-%m-%d %H:%M:%S')} UTC\n"
                f"‚Ä¢ –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø—Ä–æ–±–ª–µ–º—ã: {duration}\n\n"
                f"‚ùå <b>–ü–æ—Å–ª–µ–¥–Ω—è—è –æ—à–∏–±–∫–∞:</b>\n"
                f"<code>{error_message}</code>\n\n"
                f"‚ö†Ô∏è <b>–î–µ–π—Å—Ç–≤–∏–µ:</b> –¢—Ä–µ–±—É–µ—Ç—Å—è —Ä—É—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ä–≤–∏—Å–∞ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π"
            )
            
            if send_telegram_notification(message):
                logging.info(f"–ú–û–ù–ò–¢–û–†–ò–ù–ì –û–®–ò–ë–û–ö: –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram –¥–ª—è reminder_id={reminder_id}")
                # –£–¥–∞–ª—è–µ–º –∏–∑ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
                del failed_activation_attempts[reminder_id]
            else:
                logging.error(f"–ú–û–ù–ò–¢–û–†–ò–ù–ì –û–®–ò–ë–û–ö: –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram –¥–ª—è reminder_id={reminder_id}")

def clear_activation_success(reminder_id):
    """
    –û—á–∏—â–∞–µ—Ç —Å—á–µ—Ç—á–∏–∫ –Ω–µ—É–¥–∞—á–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫ –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–π –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è.
    """
    global failed_activation_attempts
    
    if reminder_id in failed_activation_attempts:
        attempts = failed_activation_attempts[reminder_id]["attempts"]
        logging.info(f"–ú–û–ù–ò–¢–û–†–ò–ù–ì –û–®–ò–ë–û–ö: –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ reminder_id={reminder_id} —É—Å–ø–µ—à–Ω–æ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–æ –ø–æ—Å–ª–µ {attempts} –Ω–µ—É–¥–∞—á–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫")
        del failed_activation_attempts[reminder_id]

def parse_datetime_with_timezone(datetime_str, client_timezone='Europe/Moscow'):
    """–ü–∞—Ä—Å–∏—Ç —Å—Ç—Ä–æ–∫—É –¥–∞—Ç—ã/–≤—Ä–µ–º–µ–Ω–∏ —Å —É—á–µ—Ç–æ–º —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å–∞ –∫–ª–∏–µ–Ω—Ç–∞."""
    try:
        # –ï—Å–ª–∏ –¥–∞—Ç–∞ —É–∂–µ —Å–æ–¥–µ—Ä–∂–∏—Ç timezone info
        if '+' in datetime_str or 'Z' in datetime_str:
            return datetime.fromisoformat(datetime_str.replace('Z', '+00:00'))
        
        # –ò–Ω–∞—á–µ —Å—á–∏—Ç–∞–µ–º, —á—Ç–æ –≤—Ä–µ–º—è –≤ —á–∞—Å–æ–≤–æ–º –ø–æ—è—Å–µ –∫–ª–∏–µ–Ω—Ç–∞
        tz = pytz.timezone(client_timezone)
        naive_dt = datetime.fromisoformat(datetime_str)
        return tz.localize(naive_dt)
    except Exception as e:
        logging.error(f"–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –¥–∞—Ç—ã '{datetime_str}': {e}")
        raise

# --- –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò ---

def analyze_dialogue_for_reminders(conn, conv_id, model):
    """
    –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–∏–∞–ª–æ–≥–∞ –¥–ª—è –≤—ã—è–≤–ª–µ–Ω–∏—è –¥–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç–µ–π –æ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–∏.
    """
    try:
        logging.info(f"–ù–∞—á–∞—Ç –∞–Ω–∞–ª–∏–∑ –Ω–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –¥–ª—è conv_id={conv_id}")
        with conn.cursor(cursor_factory=psycopg2.extras.DictCursor) as cur:
            # –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–∏–∞–ª–æ–≥–∞ (—É–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–æ 10 —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
            message_limit = 10  # –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–æ –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            
            cur.execute("""
                SELECT role, message, created_at 
                FROM dialogues 
                WHERE conv_id = %s 
                ORDER BY created_at DESC 
                LIMIT %s
            """, (conv_id, message_limit))
            messages = cur.fetchall()
            
            if not messages:
                logging.info(f"–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –≤ –¥–∏–∞–ª–æ–≥–µ {conv_id}")
                return None
            
            # –î–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ —Ñ–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Å–≤–µ–∂–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
            if conv_id == ADMIN_CONV_ID:
                # –ë–µ—Ä–µ–º —Ç–æ–ª—å–∫–æ —Å–æ–æ–±—â–µ–Ω–∏—è –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 –º–∏–Ω—É—Ç
                cutoff_time = datetime.now(timezone.utc) - timedelta(minutes=10)
                
                # –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–æ–±–ª–µ–º—É —Å—Ä–∞–≤–Ω–µ–Ω–∏—è datetime —Å —Ä–∞–∑–Ω—ã–º–∏ timezone
                filtered_messages = []
                for msg in messages:
                    msg_time = msg['created_at']
                    # –ï—Å–ª–∏ –≤—Ä–µ–º—è –∏–∑ –ë–î –±–µ–∑ timezone, —Å—á–∏—Ç–∞–µ–º –µ–≥–æ UTC
                    if msg_time.tzinfo is None:
                        msg_time = msg_time.replace(tzinfo=timezone.utc)
                    
                    if msg_time > cutoff_time:
                        filtered_messages.append(msg)
                
                messages = filtered_messages
                
                if not messages:
                    logging.info(f"–ù–µ—Ç —Å–≤–µ–∂–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (–∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 –º–∏–Ω—É—Ç) –æ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ {conv_id}")
                    return None
                
                logging.info(f"–ê–Ω–∞–ª–∏–∑ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞: –Ω–∞–π–¥–µ–Ω–æ {len(messages)} —Å–≤–µ–∂–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 –º–∏–Ω—É—Ç")
            
            # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –ø—Ä–æ–º–ø—Ç–∞
            dialogue_text = []
            for msg in reversed(messages):
                role_map = {'user': '–ö–ª–∏–µ–Ω—Ç', 'bot': '–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç', 'operator': '–û–ø–µ—Ä–∞—Ç–æ—Ä'}
                role = role_map.get(msg['role'], msg['role'])
                message_text = re.sub(r'^\[.*?\]\s*', '', msg['message'])
                
                # –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –î–æ–±–∞–≤–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–∫–∏ –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è —Ö—Ä–æ–Ω–æ–ª–æ–≥–∏–∏ (—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å –∞–≥–µ–Ω—Ç–æ–º –∞–∫—Ç–∏–≤–∞—Ü–∏–∏)
                timestamp = msg['created_at'].strftime('%Y-%m-%d %H:%M:%S') if msg['created_at'] else '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'
                dialogue_text.append(f"[{timestamp}] {role}: {message_text}")
            
            # –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞ (–í–°–ï–ì–î–ê –°–í–ï–ñ–ò–ï –î–ê–ù–ù–´–ï)
            # –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –í—ã–ø–æ–ª–Ω—è–µ–º –∑–∞–ø—Ä–æ—Å –ë–ï–ó –ö–ï–®–ò–†–û–í–ê–ù–ò–Ø –¥–ª—è –∞–∫—Ç—É–∞–ª—å–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
            cur.execute("""
                SELECT id, reminder_datetime, reminder_context_summary, created_at
                FROM reminders 
                WHERE conv_id = %s AND status = 'active'
                ORDER BY reminder_datetime
            """, (conv_id,))
            active_reminders = cur.fetchall()
            
            logging.info(f"–ü–†–û–í–ï–†–ö–ê –°–£–©–ï–°–¢–í–£–Æ–©–ò–• –ù–ê–ü–û–ú–ò–ù–ê–ù–ò–ô: –ù–∞–π–¥–µ–Ω–æ {len(active_reminders)} –∞–∫—Ç–∏–≤–Ω—ã—Ö –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –¥–ª—è conv_id={conv_id}")
            
            reminders_text = []
            for rem in active_reminders:
                # –î–æ–±–∞–≤–ª—è–µ–º ID –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –¥–ª—è –ª—É—á—à–µ–π –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º–æ—Å—Ç–∏
                created_time = rem['created_at'].strftime('%Y-%m-%d %H:%M:%S') if rem['created_at'] else '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'
                reminders_text.append(f"- [ID:{rem['id']}] {rem['reminder_datetime']}: {rem['reminder_context_summary']} (—Å–æ–∑–¥–∞–Ω–æ: {created_time})")
            
            # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–ª–∏–µ–Ω—Ç–µ –∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ–º —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å
            cur.execute("""
                SELECT first_name, last_name, city 
                FROM user_profiles 
                WHERE conv_id = %s
            """, (conv_id,))
            profile_result = cur.fetchone()
            
            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å –∫–ª–∏–µ–Ω—Ç–∞ –∏ –µ–≥–æ —Å–º–µ—â–µ–Ω–∏–µ
            client_timezone = 'Europe/Moscow'  # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –º–æ—Å–∫–æ–≤—Å–∫–æ–µ –≤—Ä–µ–º—è
            if profile_result and profile_result['city']:
                client_timezone = get_timezone_by_city(profile_result['city'])
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —É–∫–∞–∑–∞–Ω –ª–∏ –≤ —Å–æ–æ–±—â–µ–Ω–∏—è—Ö –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å
            for msg in messages:
                if msg['role'] == 'user':  # –¢–æ–ª—å–∫–æ —Å–æ–æ–±—â–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞
                    explicit_timezone = detect_timezone_from_message(msg['message'])
                    if explicit_timezone:
                        client_timezone = explicit_timezone
                        break  # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π —è–≤–Ω–æ —É–∫–∞–∑–∞–Ω–Ω—ã–π —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å
            
            client_timezone_offset = get_timezone_offset_str(client_timezone)

            # –§–æ—Ä–º–∏—Ä—É–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–µ–∫—É—â–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –¥–ª—è –ø—Ä–æ–º–ø—Ç–∞
            user_info = ""
            if profile_result:
                full_name = f"{profile_result['first_name']} {profile_result['last_name']}".strip()
                city = profile_result.get('city', '')
                user_info = f"–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–µ–∫—É—â–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ: conv_id={conv_id}, –∏–º—è='{full_name}'"
                if city:
                    user_info += f", –≥–æ—Ä–æ–¥='{city}'"
                user_info += f", —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å={client_timezone} (UTC{client_timezone_offset})"
                if conv_id == ADMIN_CONV_ID:
                    user_info += " (–ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–û–†)"
                    logging.info(f"=== –ê–ù–ê–õ–ò–ó –°–û–û–ë–©–ï–ù–ò–ô –ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–û–†–ê ===")
                    logging.info(f"–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ (conv_id={ADMIN_CONV_ID})")
                    # –õ–æ–≥–∏—Ä—É–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ
                    user_messages = [msg for msg in messages if msg['role'] == 'user']
                    if user_messages:
                        last_user_msg = user_messages[0]  # –°–∞–º–æ–µ –ø–æ—Å–ª–µ–¥–Ω–µ–µ
                        logging.info(f"–ü–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: '{last_user_msg['message']}'")
                    logging.info("=== –ö–û–ù–ï–¶ –ê–ù–ê–õ–ò–ó–ê –ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–û–†–ê ===")
            else:
                user_info = f"conv_id={conv_id}, —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å={client_timezone} (UTC{client_timezone_offset})"
            
            # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–∫—É–ø–∫–∞—Ö –∫–ª–∏–µ–Ω—Ç–∞
            cur.execute("""
                SELECT product_name, purchase_date, amount
                FROM client_purchases 
                WHERE conv_id = %s
                ORDER BY purchase_date DESC
                LIMIT 5
            """, (conv_id,))
            
            purchases = cur.fetchall()
            purchases_text = []
            if purchases:
                for purchase in purchases:
                    date_str = purchase['purchase_date'].strftime('%Y-%m-%d %H:%M') if purchase['purchase_date'] else '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'
                    amount_str = f" –Ω–∞ —Å—É–º–º—É {purchase['amount']}" if purchase.get('amount') else ""
                    purchases_text.append(f"- {purchase['product_name']} (–¥–∞—Ç–∞: {date_str}{amount_str})")
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–µ–¥–∞–≤–Ω–∏–µ –ø–æ–∫—É–ø–∫–∏
                current_analysis_time = datetime.now(timezone.utc)
                recent_purchases = []
                for p in purchases:
                    if p['purchase_date']:
                        purchase_time = p['purchase_date']
                        # –ï—Å–ª–∏ –≤—Ä–µ–º—è –∏–∑ –ë–î –±–µ–∑ timezone, —Å—á–∏—Ç–∞–µ–º –µ–≥–æ UTC
                        if purchase_time.tzinfo is None:
                            purchase_time = purchase_time.replace(tzinfo=timezone.utc)
                        
                        time_diff = (current_analysis_time - purchase_time).total_seconds()
                        if time_diff < 86400:  # 24 —á–∞—Å–∞
                            recent_purchases.append(p)
                if recent_purchases:
                    purchases_text.append("\n‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: –ï—Å—Ç—å –ø–æ–∫—É–ø–∫–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 24 —á–∞—Å–∞!")

            # –§–æ—Ä–º–∏—Ä—É–µ–º –ø—Ä–æ–º–ø—Ç –±–µ–∑–æ–ø–∞—Å–Ω—ã–º —Å–ø–æ—Å–æ–±–æ–º –≤ –Ω–µ—Å–∫–æ–ª—å–∫–æ —ç—Ç–∞–ø–æ–≤
            prompt = PROMPT_ANALYZE_DIALOGUE.replace("{user_info}", user_info)
            prompt = prompt.replace("{dialogue_messages}", "\n".join(dialogue_text))
            prompt = prompt.replace("{active_reminders}", "\n".join(reminders_text) if reminders_text else "–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π")
            prompt = prompt.replace("{client_purchases}", "\n".join(purchases_text) if purchases_text else "–ù–µ—Ç –ø–æ–∫—É–ø–æ–∫")
            
            # –¢–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ–º .format() –¥–ª—è –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è, –±–µ–∑–æ–ø–∞—Å–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
            current_client_time_str = datetime.now(pytz.timezone(client_timezone)).strftime("%Y-%m-%d %H:%M:%S")
            
            prompt = prompt.format(
                admin_conv_id=ADMIN_CONV_ID,
                current_client_time=current_client_time_str,
                conv_id=conv_id,
                client_timezone=client_timezone,
                client_timezone_offset=client_timezone_offset
            )
            
            # –õ–æ–≥–∏—Ä—É–µ–º –ø–æ–ª–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
            logging.info(f"=== –ü–û–õ–ù–´–ô –ü–†–û–ú–ü–¢ –î–õ–Ø –ê–ù–ê–õ–ò–ó–ê –î–ò–ê–õ–û–ì–ê {conv_id} ===")
            logging.info(prompt)
            logging.info("=== –ö–û–ù–ï–¶ –ü–†–û–ú–ü–¢–ê ===")
            
            # –í—ã–∑—ã–≤–∞–µ–º AI –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
            result = call_gemini_api(model, prompt, expect_json=True)
            
            # ===== –î–û–ë–ê–í–õ–Ø–ï–ú –î–ï–¢–ê–õ–¨–ù–û–ï –õ–û–ì–ò–†–û–í–ê–ù–ò–ï =====
            logging.info(f"=== –ü–û–õ–ù–´–ô –û–¢–í–ï–¢ AI –î–õ–Ø –î–ò–ê–õ–û–ì–ê {conv_id} ===")
            logging.info(f"–°—ã—Ä–æ–π –æ—Ç–≤–µ—Ç AI: {json.dumps(result, ensure_ascii=False, indent=2)}")
            logging.info("=== –ö–û–ù–ï–¶ –û–¢–í–ï–¢–ê AI ===")
            
            # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–µ—Ç –±—ã—Ç—å —Å–ø–∏—Å–∫–æ–º –∏–ª–∏ —Å–ª–æ–≤–∞—Ä–µ–º
            reminders_to_process = []
            if isinstance(result, list):
                reminders_to_process = result
            elif isinstance(result, dict):
                reminders_to_process = result.get('reminders', [])

            logging.info(f"–ê–ù–ê–õ–ò–ó –î–ò–ê–õ–û–ì–ê {conv_id}: AI –≤–µ—Ä–Ω—É–ª {len(reminders_to_process)} –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π")

            if reminders_to_process:
                processed_reminders = []
                
                # ===== –î–û–ë–ê–í–õ–Ø–ï–ú –ü–†–û–í–ï–†–ö–£ –ù–ê –î–£–ë–õ–ò–ö–ê–¢–´ –í–ù–£–¢–†–ò –û–î–ù–û–ì–û –û–¢–í–ï–¢–ê =====
                unique_reminders = {}  # –∫–ª—é—á: (target_conv_id, summary_hash), –∑–Ω–∞—á–µ–Ω–∏–µ: reminder_data
                
                for i, reminder_data in enumerate(reminders_to_process):
                    logging.info(f"–ê–ù–ê–õ–ò–ó –î–ò–ê–õ–û–ì–ê {conv_id}: –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ {i+1}: {reminder_data}")
                    
                    if reminder_data.get('action') != 'none':
                        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å target_conv_id
                        target_conv_id = reminder_data.get('target_conv_id')
                        if not target_conv_id:
                            logging.warning(f"–û–¢–ö–õ–û–ù–ï–ù–û –ù–ê–ü–û–ú–ò–ù–ê–ù–ò–ï {conv_id}: –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç target_conv_id: {reminder_data}")
                            continue
                        
                        # –°–æ–∑–¥–∞–µ–º –∫–ª—é—á –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –≤–Ω—É—Ç—Ä–∏ –æ–¥–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ AI
                        summary = reminder_data.get('reminder_context_summary', '').lower().strip()
                        summary_hash = hash(summary)
                        duplicate_key = (target_conv_id, summary_hash)
                        
                        if duplicate_key in unique_reminders:
                            logging.warning(f"–î–£–ë–õ–ò–ö–ê–¢ –í –û–¢–í–ï–¢–ï AI {conv_id}: –û–±–Ω–∞—Ä—É–∂–µ–Ω –¥—É–±–ª–∏–∫–∞—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –¥–ª—è target_conv_id={target_conv_id}, summary='{summary}'. –ü—Ä–æ–ø—É—Å–∫–∞—é.")
                            continue
                        
                        unique_reminders[duplicate_key] = reminder_data
                        
                        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —Å–æ–∑–¥–∞–µ–º –ª–∏ –º—ã –¥—É–±–ª–∏—Ä—É—é—â–µ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏
                        if reminder_data.get('action') == 'create' and active_reminders:
                            new_summary = summary
                            is_duplicate = False
                            
                            logging.info(f"–ü–†–û–í–ï–†–ö–ê –î–£–ë–õ–ò–ö–ê–¢–û–í {conv_id}: –ù–æ–≤–æ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ '{new_summary}' –ø—Ä–æ—Ç–∏–≤ {len(active_reminders)} —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö")
                            
                            for existing in active_reminders:
                                existing_summary = existing['reminder_context_summary'].lower()
                                # –ü—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å—Ö–æ–∂–µ—Å—Ç—å (–±–æ–ª–µ–µ 50% –æ–±—â–∏—Ö —Å–ª–æ–≤)
                                new_words = set(new_summary.split())
                                existing_words = set(existing_summary.split())
                                intersection = new_words & existing_words
                                
                                if new_words and existing_words:
                                    similarity = len(intersection) / len(new_words)
                                    logging.info(f"–°–†–ê–í–ù–ï–ù–ò–ï –î–£–ë–õ–ò–ö–ê–¢–û–í {conv_id}: '{new_summary}' vs '{existing_summary}' - —Å—Ö–æ–∂–µ—Å—Ç—å {similarity:.2f}")
                                    
                                    if similarity > 0.5:
                                        logging.info(f"–î–£–ë–õ–ò–ö–ê–¢ –ù–ê–ô–î–ï–ù {conv_id}: –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ –¥—É–±–ª–∏—Ä—É—é—â–µ–≥–æ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è '{new_summary}'")
                                        is_duplicate = True
                                        break
                                        
                            if is_duplicate:
                                continue
                        
                        # –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
                        if conv_id == ADMIN_CONV_ID:
                            summary = reminder_data.get('reminder_context_summary', '').lower()
                            # –û—Ç–∫–ª–æ–Ω—è–µ–º –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –ø–æ –∂–∞–ª–æ–±–∞–º –Ω–∞ –æ—à–∏–±–∫–∏
                            if any(word in summary for word in ['–æ—à–∏–±–∫', '–∑–∞–ø—É—Ç–∞–ª', '–ø–æ—Å—Ç–∞–≤–∏–ª', '–ø—Ä–æ–±–ª–µ–º', '–±–∞–≥']):
                                logging.info(f"–§–ò–õ–¨–¢–† –ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–û–†–ê {conv_id}: –ü—Ä–æ–ø—É—Å–∫–∞—é –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –ø–æ –∂–∞–ª–æ–±–µ/–æ—à–∏–±–∫–µ: '{summary}'")
                                continue
                        
                        reminder_data['client_timezone'] = client_timezone
                        logging.info(f"–ü–†–ò–ù–Ø–¢–û –ù–ê–ü–û–ú–ò–ù–ê–ù–ò–ï {conv_id}: {reminder_data}")
                        processed_reminders.append(reminder_data)
                    else:
                        none_reason = reminder_data.get('none_reason', '–ø—Ä–∏—á–∏–Ω–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞')
                        logging.info(f"–ü–†–û–ü–£–©–ï–ù–û –ù–ê–ü–û–ú–ò–ù–ê–ù–ò–ï {conv_id}: action='none' - {none_reason}")

                if processed_reminders:
                    logging.info(f"–ò–¢–û–ì –ê–ù–ê–õ–ò–ó–ê {conv_id}: –ü—Ä–∏–Ω—è—Ç–æ {len(processed_reminders)} –∏–∑ {len(reminders_to_process)} –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤")
                return processed_reminders if processed_reminders else None
            
            logging.info(f"–ê–ù–ê–õ–ò–ó –î–ò–ê–õ–û–ì–ê {conv_id}: –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã")
            return None
            
    except Exception as e:
        logging.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ –¥–∏–∞–ª–æ–≥–∞ {conv_id}: {e}", exc_info=True)
        return None

def create_or_update_reminder(conn, conv_id, reminder_data, created_by_conv_id=None):
    """
    –°–æ–∑–¥–∞–µ—Ç –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –≤ –ë–î.
    """
    try:
        with conn.cursor() as cur:
            action = reminder_data.get('action')
            target_conv_id = reminder_data.get('target_conv_id', conv_id)
            
            # ===== –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ó–ê–©–ò–¢–ê –û–¢ –ü–£–¢–ê–ù–ò–¶–´ –ö–û–ù–¢–ï–ö–°–¢–û–í =====
            if action == 'create':
                # 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å target_conv_id
                if not target_conv_id or target_conv_id == 0:
                    logging.error(f"–û–¢–ö–õ–û–ù–ï–ù–û –°–û–ó–î–ê–ù–ò–ï –ù–ê–ü–û–ú–ò–ù–ê–ù–ò–Ø {conv_id}: –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π target_conv_id={target_conv_id}")
                    return
                
                # 2. –ó–ê–©–ò–¢–ê –û–¢ –ü–£–¢–ê–ù–ò–¶–´: –†–∞–∑—Ä–µ—à–∞–µ–º —Å–æ–∑–¥–∞–≤–∞—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è —Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–æ–≥–æ –∂–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
                if target_conv_id != conv_id and target_conv_id != ADMIN_CONV_ID:
                    logging.error(f"–ë–õ–û–ö–ò–†–û–í–ö–ê –ü–£–¢–ê–ù–ò–¶–´ –ö–û–ù–¢–ï–ö–°–¢–û–í: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å conv_id={conv_id} –ø—ã—Ç–∞–µ—Ç—Å—è —Å–æ–∑–¥–∞—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –¥–ª—è target_conv_id={target_conv_id}. –≠—Ç–æ –∑–∞–ø—Ä–µ—â–µ–Ω–æ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.")
                    return
                
                # 3. –ï—Å–ª–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —Å–æ–∑–¥–∞—ë—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –Ω–µ –¥–ª—è —Å–µ–±—è, –ø—Ä–æ–≤–µ—Ä—è–µ–º explicit —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ
                if conv_id == ADMIN_CONV_ID and target_conv_id != ADMIN_CONV_ID:
                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤ –æ–ø–∏—Å–∞–Ω–∏–∏ –µ—Å—Ç—å —è–≤–Ω–æ–µ —É–∫–∞–∑–∞–Ω–∏–µ conv_id –∫–ª–∏–µ–Ω—Ç–∞
                    reminder_summary = reminder_data.get('reminder_context_summary', '').lower()
                    if f"conv_id: {target_conv_id}" not in reminder_summary and f"conv_id:{target_conv_id}" not in reminder_summary:
                        logging.error(f"–ë–õ–û–ö–ò–†–û–í–ö–ê –ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–û–†–ê: Admin conv_id={conv_id} –ø—ã—Ç–∞–µ—Ç—Å—è —Å–æ–∑–¥–∞—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –¥–ª—è target_conv_id={target_conv_id}, –Ω–æ –≤ –æ–ø–∏—Å–∞–Ω–∏–∏ –Ω–µ—Ç —è–≤–Ω–æ–≥–æ 'conv_id: {target_conv_id}'. –ë–ª–æ–∫–∏—Ä—É–µ–º –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.")
                        return
                
                # –õ–æ–≥–∏—Ä—É–µ–º –¥–µ—Ç–∞–ª–∏ —Å–æ–∑–¥–∞–Ω–∏—è
                logging.info(f"–°–û–ó–î–ê–ù–ò–ï –ù–ê–ü–û–ú–ò–ù–ê–ù–ò–Ø: conv_id={conv_id}, target_conv_id={target_conv_id}, created_by={created_by_conv_id}")
                logging.info(f"–î–ï–¢–ê–õ–ò –ù–ê–ü–û–ú–ò–ù–ê–ù–ò–Ø: {reminder_data}")
                
                # ===== –£–°–ò–õ–ï–ù–ù–ê–Ø –î–ï–î–£–ü–õ–ò–ö–ê–¶–ò–Ø –ù–ê–ü–û–ú–ò–ù–ê–ù–ò–ô =====
                summary = reminder_data.get('reminder_context_summary', '').strip()
                if summary:
                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ —Ç–æ—á–Ω—ã–µ –¥—É–±–ª–∏–∫–∞—Ç—ã –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –∏ –æ–ø–∏—Å–∞–Ω–∏—é
                    proposed_time = parse_datetime_with_timezone(
                        reminder_data['proposed_datetime'],
                        reminder_data.get('client_timezone', 'Europe/Moscow')
                    )
                    
                    cur.execute("""
                        SELECT id, reminder_context_summary, reminder_datetime
                        FROM reminders 
                        WHERE conv_id = %s AND status = 'active'
                        AND ABS(EXTRACT(EPOCH FROM (reminder_datetime - %s))) < 3600
                        ORDER BY created_at DESC
                        LIMIT 5
                    """, (target_conv_id, proposed_time))
                    
                    similar_by_time = cur.fetchall()
                    if similar_by_time:
                        for existing in similar_by_time:
                            existing_summary = existing[1].lower().strip()
                            new_summary = summary.lower().strip()
                            
                            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ö–æ–∂–µ—Å—Ç—å –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º
                            new_words = set(new_summary.split())
                            existing_words = set(existing_summary.split())
                            intersection = new_words & existing_words
                            
                            if new_words and existing_words:
                                similarity = len(intersection) / len(new_words | existing_words)  # –ñ–∞–∫–∫–∞—Ä –∏–Ω–¥–µ–∫—Å
                                logging.info(f"–î–ï–î–£–ü–õ–ò–ö–ê–¶–ò–Ø: –°—Ä–∞–≤–Ω–µ–Ω–∏–µ '{new_summary}' vs '{existing_summary}' - —Å—Ö–æ–∂–µ—Å—Ç—å {similarity:.2f}")
                                
                                # –ë–æ–ª–µ–µ —Å—Ç—Ä–æ–≥–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞: –±–ª–æ–∫–∏—Ä—É–µ–º –ø—Ä–∏ —Å—Ö–æ–∂–µ—Å—Ç–∏ > 60%
                                if similarity > 0.6:
                                    logging.warning(f"–î–£–ë–õ–ò–†–£–Æ–©–ï–ï –ù–ê–ü–û–ú–ò–ù–ê–ù–ò–ï –ó–ê–ë–õ–û–ö–ò–†–û–í–ê–ù–û: '{new_summary}' —Å–ª–∏—à–∫–æ–º –ø–æ—Ö–æ–∂–µ –Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ '{existing_summary}' (—Å—Ö–æ–∂–µ—Å—Ç—å {similarity:.2f})")
                                    return
                    # –í–†–ï–ú–ï–ù–ù–û –û–¢–ö–õ–Æ–ß–ï–ù–û –ò–ó-–ó–ê –û–®–ò–ë–ö–ò –û–¢–°–£–¢–°–¢–í–ò–Ø –†–ê–°–®–ò–†–ï–ù–ò–Ø pg_trgm
                    # cur.execute("""
                    #     SELECT id, reminder_context_summary, reminder_datetime
                    #     FROM reminders 
                    #     WHERE conv_id = %s AND status = 'active'
                    #     AND similarity(reminder_context_summary, %s) > 0.6
                    #     ORDER BY created_at DESC
                    #     LIMIT 3
                    # """, (target_conv_id, summary))
                    
                    # similar_reminders = cur.fetchall()
                    # if similar_reminders:
                    #     logging.warning(f"–ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï {conv_id}: –ù–∞–π–¥–µ–Ω—ã –ø–æ—Ö–æ–∂–∏–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –¥–ª—è target_conv_id={target_conv_id}:")
                    #     for similar in similar_reminders:
                    #         logging.warning(f"  - ID={similar[0]}: '{similar[1]}' –Ω–∞ {similar[2]}")
                        
                    # –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –±–æ–ª–µ–µ —Å—Ç—Ä–æ–≥—É—é –ø—Ä–æ–≤–µ—Ä–∫—É, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
                    # return  # –†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–ª—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ—Ö–æ–∂–∏—Ö –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π
                    pass # –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –∑–∞–≥–ª—É—à–∫–∞ –ø–æ—Å–ª–µ –∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                
                # –ü–∞—Ä—Å–∏–º –¥–∞—Ç—É/–≤—Ä–µ–º—è —Å —É—á–µ—Ç–æ–º —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å–∞
                reminder_dt = parse_datetime_with_timezone(
                    reminder_data['proposed_datetime'],
                    reminder_data.get('client_timezone', 'Europe/Moscow')
                )
                
                # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—Ä–æ—à–µ–¥—à–µ–µ –≤—Ä–µ–º—è
                if reminder_dt < datetime.now(timezone.utc):
                    logging.warning(f"–ü–æ–ø—ã—Ç–∫–∞ —Å–æ–∑–¥–∞—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –Ω–∞ –ø—Ä–æ—à–µ–¥—à–µ–µ –≤—Ä–µ–º—è ({reminder_dt}) –¥–ª—è conv_id={target_conv_id}. –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –Ω–µ –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω–æ.")
                    return
                
                # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ
                cur.execute("""
                    INSERT INTO reminders (
                        conv_id, reminder_datetime, reminder_context_summary,
                        created_by_conv_id, client_timezone, status
                    ) VALUES (%s, %s, %s, %s, %s, 'active')
                    RETURNING id
                """, (
                    target_conv_id,
                    reminder_dt,
                    reminder_data['reminder_context_summary'],
                    created_by_conv_id or conv_id,
                    reminder_data.get('client_timezone', 'Europe/Moscow')
                ))
                
                reminder_id = cur.fetchone()[0]
                conn.commit()
                logging.info(f"‚úÖ –°–û–ó–î–ê–ù–û –ù–ê–ü–û–ú–ò–ù–ê–ù–ò–ï ID={reminder_id} –¥–ª—è target_conv_id={target_conv_id} (—Å–æ–∑–¥–∞–ª conv_id={created_by_conv_id or conv_id})")
                
            elif action == 'cancel':
                # ===== –ó–ê–©–ò–¢–ê –û–¢ –ù–ï–ü–†–ê–í–û–ú–ï–†–ù–û–ô –û–¢–ú–ï–ù–´ =====
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –Ω–∞ –æ—Ç–º–µ–Ω—É –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π
                if target_conv_id != conv_id and target_conv_id != ADMIN_CONV_ID:
                    logging.error(f"–ë–õ–û–ö–ò–†–û–í–ö–ê –û–¢–ú–ï–ù–´: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å conv_id={conv_id} –ø—ã—Ç–∞–µ—Ç—Å—è –æ—Ç–º–µ–Ω–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –¥–ª—è target_conv_id={target_conv_id}. –≠—Ç–æ –∑–∞–ø—Ä–µ—â–µ–Ω–æ.")
                    return
                
                # –ï—Å–ª–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –æ—Ç–º–µ–Ω—è–µ—Ç —á—É–∂–∏–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è, —Ç—Ä–µ–±—É–µ–º explicit —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ
                if conv_id == ADMIN_CONV_ID and target_conv_id != ADMIN_CONV_ID:
                    cancellation_reason = reminder_data.get('cancellation_reason', '')
                    if f"conv_id: {target_conv_id}" not in cancellation_reason and f"conv_id:{target_conv_id}" not in cancellation_reason:
                        logging.error(f"–ë–õ–û–ö–ò–†–û–í–ö–ê –û–¢–ú–ï–ù–´ –ê–î–ú–ò–ù–û–ú: Admin conv_id={conv_id} –ø—ã—Ç–∞–µ—Ç—Å—è –æ—Ç–º–µ–Ω–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –¥–ª—è target_conv_id={target_conv_id}, –Ω–æ –≤ –ø—Ä–∏—á–∏–Ω–µ –Ω–µ—Ç —è–≤–Ω–æ–≥–æ 'conv_id: {target_conv_id}'.")
                        return
                
                # –û—Ç–º–µ–Ω—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
                cancellation_source = 'admin' if conv_id == ADMIN_CONV_ID else 'user'
                
                cur.execute("""
                    UPDATE reminders 
                    SET status = %s, cancellation_reason = %s
                    WHERE conv_id = %s AND status = 'active'
                """, (
                    f'cancelled_by_{cancellation_source}',
                    reminder_data.get('cancellation_reason', '–û—Ç–º–µ–Ω–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º'),
                    target_conv_id
                ))
                
                affected = cur.rowcount
                conn.commit()
                if affected > 0:
                    logging.info(f"–û—Ç–º–µ–Ω–µ–Ω–æ {affected} –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –¥–ª—è conv_id={target_conv_id}")
                
            elif action == 'update':
                # –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ
                reminder_dt = parse_datetime_with_timezone(
                    reminder_data['proposed_datetime'],
                    reminder_data.get('client_timezone', 'Europe/Moscow')
                )
                
                # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—Ä–æ—à–µ–¥—à–µ–µ –≤—Ä–µ–º—è
                if reminder_dt < datetime.now(timezone.utc):
                    logging.warning(f"–ü–æ–ø—ã—Ç–∫–∞ –æ–±–Ω–æ–≤–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –Ω–∞ –ø—Ä–æ—à–µ–¥—à–µ–µ –≤—Ä–µ–º—è ({reminder_dt}) –¥–ª—è conv_id={target_conv_id}. –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –Ω–µ –±—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–æ.")
                    return
                
                cur.execute("""
                    UPDATE reminders 
                    SET reminder_datetime = %s, reminder_context_summary = %s
                    WHERE id = (
                        SELECT id FROM reminders
                        WHERE conv_id = %s AND status = 'active'
                        ORDER BY created_at DESC
                        LIMIT 1
                    )
                """, (
                    reminder_dt,
                    reminder_data['reminder_context_summary'],
                    target_conv_id
                ))
                
                conn.commit()
                logging.info(f"–û–±–Ω–æ–≤–ª–µ–Ω–æ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –¥–ª—è conv_id={target_conv_id}")
                
    except Exception as e:
        conn.rollback()
        logging.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è: {e}", exc_info=True)
        raise

def process_reminder_batch(reminders):
    """
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–∞—á–∫—É –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –¥–ª—è –æ–¥–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    –ê–∫—Ç–∏–≤–∏—Ä—É–µ—Ç –≤—Å–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –ò–ò-–ø—Ä–æ–≤–µ—Ä–∫–∏.
    """
    if not reminders:
        return

    conv_id = reminders[0]['conv_id']
    logging.info(f"–û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–∞—á–∫–∏ –∏–∑ {len(reminders)} –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –¥–ª—è conv_id={conv_id}")

    # –§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç—ã –¥–ª—è –≤—Å–µ—Ö –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π
    activated_contexts = []
    activated_ids = []

    for reminder in reminders:
        activated_contexts.append(reminder['reminder_context_summary'])
        activated_ids.append(reminder['id'])
        logging.info(f"–ì–æ—Ç–æ–≤–æ –∫ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏: ID={reminder['id']}, context={reminder['reminder_context_summary']}")

    # –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ
    logging.info(f"–ü–ê–ö–ï–¢–ù–ê–Ø –ê–ö–¢–ò–í–ê–¶–ò–Ø –¥–ª—è conv_id={conv_id}: –ó–∞–ø—É—Å–∫–∞—é –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—É—é –∞–∫—Ç–∏–≤–∞—Ü–∏—é –¥–ª—è {len(activated_ids)} –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π")
    
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ç–¥–µ–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫ –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏, —á—Ç–æ–±—ã –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫
    activation_thread = threading.Thread(
        target=_activate_reminders_async,
        args=(conv_id, activated_contexts, activated_ids),
        daemon=True
    )
    activation_thread.start()

def _activate_reminders_async(conv_id, activated_contexts, activated_ids):
    """
    –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –∞–∫—Ç–∏–≤–∞—Ü–∏—è –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ.
    """
    conn = None
    try:
        conn = get_db_connection()
        
        # === –£–ú–ù–ê–Ø –î–ï–î–£–ü–õ–ò–ö–ê–¶–ò–Ø: –û—Ç–º–µ–Ω—è–µ–º –≤—Å–µ –ø–æ—Ö–æ–∂–∏–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è ===
        additional_cancelled_ids = _cancel_similar_reminders(conn, conv_id, activated_contexts)
        if additional_cancelled_ids:
            activated_ids.extend(additional_cancelled_ids)
            logging.info(f"–î–ï–î–£–ü–õ–ò–ö–ê–¶–ò–Ø –ü–†–ò –ê–ö–¢–ò–í–ê–¶–ò–ò: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –æ—Ç–º–µ–Ω–µ–Ω–æ {len(additional_cancelled_ids)} –ø–æ—Ö–æ–∂–∏—Ö –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –¥–ª—è conv_id={conv_id}")
        
        combined_context = f"–£ –≤–∞—Å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å—Ä–∞–±–æ—Ç–∞–≤—à–∏—Ö –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π:\n\n" + "\n".join([f"- {ctx}" for ctx in activated_contexts])

        port = os.environ.get("PORT", 8080)
        activate_url = f"http://127.0.0.1:{port}/activate_reminder"
        payload = {"conv_id": conv_id, "reminder_context_summary": combined_context}
        
        logging.info(f"–ê–°–ò–ù–•–†–û–ù–ù–ê–Ø –ê–ö–¢–ò–í–ê–¶–ò–Ø –¥–ª—è conv_id={conv_id} (ID: {activated_ids}): –û—Ç–ø—Ä–∞–≤–ª—è—é –∑–∞–ø—Ä–æ—Å –Ω–∞ {activate_url}")
        
        # –£–≤–µ–ª–∏—á–µ–Ω–Ω—ã–π —Ç–∞–π–º–∞—É—Ç –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è worker timeout
        response = requests.post(activate_url, json=payload, timeout=ACTIVATION_TIMEOUT)
        response.raise_for_status()
        
        response_text = response.text
        logging.info(f"–ê–°–ò–ù–•–†–û–ù–ù–ê–Ø –ê–ö–¢–ò–í–ê–¶–ò–Ø –¥–ª—è conv_id={conv_id}: –ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç. –°—Ç–∞—Ç—É—Å: {response.status_code}, –¢–µ–ª–æ: '{response_text}'")

        with conn.cursor() as cur:
            logging.info(f"–ê–°–ò–ù–•–†–û–ù–ù–ê–Ø –ê–ö–¢–ò–í–ê–¶–ò–Ø –¥–ª—è conv_id={conv_id} (ID: {activated_ids}): –û–±–Ω–æ–≤–ª—è—é —Å—Ç–∞—Ç—É—Å—ã –≤ –ë–î –Ω–∞ 'done'.")
            cur.execute("UPDATE reminders SET status = 'done' WHERE id = ANY(%s::int[])", (activated_ids,))
            conn.commit()
            logging.info(f"–ê–°–ò–ù–•–†–û–ù–ù–ê–Ø –ê–ö–¢–ò–í–ê–¶–ò–Ø –¥–ª—è conv_id={conv_id}: –£—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã —Å—Ç–∞—Ç—É—Å—ã –¥–ª—è {len(activated_ids)} –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π.")
            
            # –û—á–∏—â–∞–µ–º —Å—á–µ—Ç—á–∏–∫–∏ –æ—à–∏–±–æ–∫ –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–π –∞–∫—Ç–∏–≤–∞—Ü–∏–∏
            for reminder_id in activated_ids:
                clear_activation_success(reminder_id)
            
        # –í–ê–ñ–ù–û: –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –æ—á–∏—â–∞–µ–º –≤—Å–µ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
        logging.info(f"–ê–°–ò–ù–•–†–û–ù–ù–ê–Ø –ê–ö–¢–ò–í–ê–¶–ò–Ø –¥–ª—è conv_id={conv_id}: –ó–∞–ø—É—Å–∫–∞—é –æ—á–∏—Å—Ç–∫—É –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π...")
        cleanup_expired_reminders()
            
    except requests.exceptions.Timeout as e:
        error_message = f"–¢–∞–π–º–∞—É—Ç HTTP –∑–∞–ø—Ä–æ—Å–∞: {e}"
        logging.error(f"–ê–°–ò–ù–•–†–û–ù–ù–ê–Ø –ê–ö–¢–ò–í–ê–¶–ò–Ø –¥–ª—è conv_id={conv_id}: –¢–ê–ô–ú–ê–£–¢. –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è {activated_ids} –±—É–¥—É—Ç –≤–æ–∑–≤—Ä–∞—â–µ–Ω—ã –≤ 'active'. –û—à–∏–±–∫–∞: {e}")
        
        # –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –æ—à–∏–±–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
        for reminder_id in activated_ids:
            track_activation_failure(reminder_id, error_message)
            
        _revert_reminder_statuses(activated_ids, "timeout")
        
    except requests.exceptions.RequestException as e:
        error_message = f"–û—à–∏–±–∫–∞ HTTP –∑–∞–ø—Ä–æ—Å–∞: {e}"
        logging.error(f"–ê–°–ò–ù–•–†–û–ù–ù–ê–Ø –ê–ö–¢–ò–í–ê–¶–ò–Ø –¥–ª—è conv_id={conv_id}: –û–®–ò–ë–ö–ê HTTP. –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è {activated_ids} –±—É–¥—É—Ç –≤–æ–∑–≤—Ä–∞—â–µ–Ω—ã –≤ 'active'. –û—à–∏–±–∫–∞: {e}")
        
        # –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –æ—à–∏–±–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
        for reminder_id in activated_ids:
            track_activation_failure(reminder_id, error_message)
            
        _revert_reminder_statuses(activated_ids, f"http_error: {e}")
        
    except Exception as e:
        error_message = f"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –∞–∫—Ç–∏–≤–∞—Ü–∏–∏: {e}"
        logging.error(f"–ê–°–ò–ù–•–†–û–ù–ù–ê–Ø –ê–ö–¢–ò–í–ê–¶–ò–Ø –¥–ª—è conv_id={conv_id}: –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê. –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è {activated_ids} –±—É–¥—É—Ç –≤–æ–∑–≤—Ä–∞—â–µ–Ω—ã –≤ 'active'. –û—à–∏–±–∫–∞: {e}", exc_info=True)
        
        # –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –æ—à–∏–±–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
        for reminder_id in activated_ids:
            track_activation_failure(reminder_id, error_message)
            
        _revert_reminder_statuses(activated_ids, f"critical_error: {e}")
        
    finally:
        if conn:
            conn.close()

def _cancel_similar_reminders(conn, conv_id, activated_contexts):
    """
    –ù–∞—Ö–æ–¥–∏—Ç –∏ –æ—Ç–º–µ–Ω—è–µ—Ç –ø–æ—Ö–æ–∂–∏–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ ID –æ—Ç–º–µ–Ω–µ–Ω–Ω—ã—Ö –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π.
    """
    cancelled_ids = []
    try:
        # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –¥–ª—è —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        with conn.cursor(cursor_factory=psycopg2.extras.DictCursor) as cur:
            cur.execute("""
                SELECT id, reminder_context_summary, reminder_datetime
                FROM reminders 
                WHERE conv_id = %s AND status = 'active'
                ORDER BY reminder_datetime
            """, (conv_id,))
            
            active_reminders = cur.fetchall()
            
            # –î–ª—è –∫–∞–∂–¥–æ–≥–æ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∏—â–µ–º –ø–æ—Ö–æ–∂–∏–µ
            for activated_context in activated_contexts:
                activated_words = set(activated_context.lower().split())
                
                for reminder in active_reminders:
                    if reminder['id'] in cancelled_ids:
                        continue  # –£–∂–µ –æ—Ç–º–µ–Ω–µ–Ω–æ
                    
                    reminder_words = set(reminder['reminder_context_summary'].lower().split())
                    
                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ö–æ–∂–µ—Å—Ç—å (–∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ—Ç –∂–µ –∞–ª–≥–æ—Ä–∏—Ç–º, —á—Ç–æ –∏ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏)
                    if activated_words and reminder_words:
                        similarity = len(activated_words & reminder_words) / len(activated_words | reminder_words)
                        
                        if similarity > 0.6:  # –ï—Å–ª–∏ —Å—Ö–æ–∂–µ—Å—Ç—å > 60%
                            # –û—Ç–º–µ–Ω—è–µ–º –ø–æ—Ö–æ–∂–µ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ
                            cur.execute("""
                                UPDATE reminders 
                                SET status = 'cancelled_by_deduplication', 
                                    cancellation_reason = %s
                                WHERE id = %s
                            """, (
                                f"–ê–≤—Ç–æ–æ—Ç–º–µ–Ω–∞ –ø–æ—Ö–æ–∂–µ–≥–æ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –ø—Ä–∏ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏. –°—Ö–æ–∂–µ—Å—Ç—å: {similarity:.2f}",
                                reminder['id']
                            ))
                            cancelled_ids.append(reminder['id'])
                            logging.info(f"–î–ï–î–£–ü–õ–ò–ö–ê–¶–ò–Ø: –û—Ç–º–µ–Ω–µ–Ω–æ –ø–æ—Ö–æ–∂–µ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ ID={reminder['id']} (—Å—Ö–æ–∂–µ—Å—Ç—å {similarity:.2f})")
            
            conn.commit()
            
    except Exception as e:
        logging.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –ø–æ—Ö–æ–∂–∏—Ö –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –¥–ª—è conv_id={conv_id}: {e}")
        conn.rollback()
    
    return cancelled_ids

def _revert_reminder_statuses(reminder_ids, reason):
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç–∞—Ç—É—Å—ã –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –æ–±—Ä–∞—Ç–Ω–æ –≤ 'active' –ø—Ä–∏ –æ—à–∏–±–∫–µ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏.
    """
    conn = None
    try:
        conn = get_db_connection()
        with conn.cursor() as cur:
            cur.execute(
                """
                UPDATE reminders 
                SET status = 'active', 
                    cancellation_reason = %s 
                WHERE id = ANY(%s::int[]) AND status = 'in_progress'
                """,
                (f"–ê–∫—Ç–∏–≤–∞—Ü–∏—è –Ω–µ —É–¥–∞–ª–∞—Å—å: {reason}", reminder_ids)
            )
            affected = cur.rowcount
            conn.commit()
            logging.info(f"–°—Ç–∞—Ç—É—Å {affected} –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π {reminder_ids} –≤–æ–∑–≤—Ä–∞—â–µ–Ω –≤ 'active' –∏–∑-–∑–∞: {reason}")
    except Exception as e_revert:
        logging.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å –≤–µ—Ä–Ω—É—Ç—å —Å—Ç–∞—Ç—É—Å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è–º {reminder_ids}: {e_revert}")
    finally:
        if conn:
            conn.close()

def check_and_activate_reminders():
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∏ –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç —Å–æ–∑—Ä–µ–≤—à–∏–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è, –≥—Ä—É–ø–ø–∏—Ä—É—è –∏—Ö –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º.
    –ê–∫—Ç–∏–≤–∏—Ä—É–µ—Ç –≤—Å–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –ò–ò-–ø—Ä–æ–≤–µ—Ä–∫–∏.
    """
    conn = None
    try:
        conn = get_db_connection()
        
        with conn.cursor(cursor_factory=psycopg2.extras.DictCursor) as cur:
            # –ü–æ–ª—É—á–∞–µ–º —Å–æ–∑—Ä–µ–≤—à–∏–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
            cur.execute("""
                SELECT id, conv_id, reminder_datetime, reminder_context_summary,
                       created_at, client_timezone
                FROM reminders 
                WHERE status = 'active' AND reminder_datetime <= NOW()
                ORDER BY conv_id, reminder_datetime
            """)
            
            reminders = cur.fetchall()
            
            if not reminders:
                logging.debug("–ù–µ—Ç —Å–æ–∑—Ä–µ–≤—à–∏—Ö –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π")
                return
            
            logging.info(f"–ù–∞–π–¥–µ–Ω–æ {len(reminders)} —Å–æ–∑—Ä–µ–≤—à–∏—Ö –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π. –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º.")

            # –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –ø–æ conv_id
            reminders_by_user = {k: list(g) for k, g in groupby(reminders, itemgetter('conv_id'))}

            for conv_id, user_reminders in reminders_by_user.items():
                try:
                    # –ë–ª–æ–∫–∏—Ä—É–µ–º –≤—Å–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –¥–ª—è —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    reminder_ids = [r['id'] for r in user_reminders]
                    cur.execute(
                        "UPDATE reminders SET status = 'in_progress' WHERE id = ANY(%s::int[])",
                        (reminder_ids,)
                    )
                    conn.commit()
                    
                    # –í—ã–±–∏—Ä–∞–µ–º, –∫–∞–∫ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å: –ø–æ –æ–¥–Ω–æ–º—É –∏–ª–∏ –ø–∞—á–∫–æ–π
                    if len(user_reminders) == 1:
                        target_func = process_single_reminder
                        args = (user_reminders[0],)
                    else:
                        target_func = process_reminder_batch
                        args = (user_reminders,)
                    
                    # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ
                    thread = threading.Thread(target=target_func, args=args, daemon=True)
                    thread.start()
                    
                except Exception as e:
                    logging.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –ø–∞—á–∫–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –¥–ª—è conv_id={conv_id}: {e}")
                    conn.rollback()
                    
    except Exception as e:
        logging.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π: {e}", exc_info=True)
    finally:
        if conn:
            conn.close()

def process_single_reminder(reminder):
    """
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ–¥–Ω–æ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ - –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç –µ–≥–æ –Ω–∞–ø—Ä—è–º—É—é –±–µ–∑ –ò–ò-–ø—Ä–æ–≤–µ—Ä–∫–∏.
    """
    conn = None
    try:
        conn = get_db_connection()
        
        logging.info(f"–ü–†–Ø–ú–ê–Ø –ê–ö–¢–ò–í–ê–¶–ò–Ø ID={reminder['id']}: –ù–∞—á–∏–Ω–∞—é –ø—Ä–æ—Ü–µ—Å—Å –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –±–µ–∑ –ò–ò-–ø—Ä–æ–≤–µ—Ä–∫–∏.")
        
        with conn.cursor() as cur:
            # –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –Ω–∞–ø—Ä—è–º—É—é
            try:
                # –§–æ—Ä–º–∏—Ä—É–µ–º –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π URL –¥–ª—è –≤—ã–∑–æ–≤–∞ –≤–Ω—É—Ç—Ä–∏ —Ç–æ–≥–æ –∂–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
                port = os.environ.get("PORT", 8080)
                activate_url = f"http://127.0.0.1:{port}/activate_reminder"
                
                payload = {
                    "conv_id": reminder['conv_id'],
                    "reminder_context_summary": reminder['reminder_context_summary']
                }
                logging.info(f"–ü–†–Ø–ú–ê–Ø –ê–ö–¢–ò–í–ê–¶–ò–Ø ID={reminder['id']}: –û—Ç–ø—Ä–∞–≤–ª—è—é –∑–∞–ø—Ä–æ—Å –Ω–∞ {activate_url}")
                
                response = requests.post(activate_url, json=payload, timeout=60)
                response.raise_for_status()
                
                response_text = response.text
                logging.info(f"–ü–†–Ø–ú–ê–Ø –ê–ö–¢–ò–í–ê–¶–ò–Ø ID={reminder['id']}: –ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç. –°—Ç–∞—Ç—É—Å: {response.status_code}, –¢–µ–ª–æ: '{response_text}'")
                
                # –ü–æ–º–µ—á–∞–µ–º –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–µ
                logging.info(f"–ü–†–Ø–ú–ê–Ø –ê–ö–¢–ò–í–ê–¶–ò–Ø ID={reminder['id']}: –û–±–Ω–æ–≤–ª—è—é —Å—Ç–∞—Ç—É—Å –≤ –ë–î –Ω–∞ 'done'.")
                cur.execute(
                    "UPDATE reminders SET status = 'done' WHERE id = %s",
                    (reminder['id'],)
                )
                
                # –û—á–∏—â–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫ –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–π –∞–∫—Ç–∏–≤–∞—Ü–∏–∏
                clear_activation_success(reminder['id'])

            except requests.exceptions.RequestException as e:
                error_message = f"–û—à–∏–±–∫–∞ HTTP –∑–∞–ø—Ä–æ—Å–∞: {e}"
                logging.error(f"–ü–†–Ø–ú–ê–Ø –ê–ö–¢–ò–í–ê–¶–ò–Ø ID={reminder['id']}: –û–®–ò–ë–ö–ê. –ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–∑–≤–∞—Ç—å —ç–Ω–¥–ø–æ–∏–Ω—Ç –∞–∫—Ç–∏–≤–∞—Ü–∏–∏. –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –ù–ï –±—É–¥–µ—Ç –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–æ –≤ —ç—Ç–æ—Ç —Ä–∞–∑. –û—à–∏–±–∫–∞: {e}")
                
                # –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –Ω–µ—É–¥–∞—á–Ω—É—é –ø–æ–ø—ã—Ç–∫—É –∞–∫—Ç–∏–≤–∞—Ü–∏–∏
                track_activation_failure(reminder['id'], error_message)
                
                # –ü—Ä–∏ –æ—à–∏–±–∫–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ—Å—Ç–∞–Ω–µ—Ç—Å—è –≤ —Å—Ç–∞—Ç—É—Å–µ 'in_progress', 
                # –∏ –±–ª–æ–∫ except –≤—ã—à–µ –≤–µ—Ä–Ω–µ—Ç –µ–≥–æ –≤ 'active'
                raise  # –ü–µ—Ä–µ–¥–∞–µ–º –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –≤—ã—à–µ, —á—Ç–æ–±—ã —Å—Ä–∞–±–æ—Ç–∞–ª rollback –∏ –≤–æ–∑–≤—Ä–∞—Ç —Å—Ç–∞—Ç—É—Å–∞

            conn.commit()
            logging.info(f"ID={reminder['id']}: –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞.")
            
            # –í–ê–ñ–ù–û: –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –æ—á–∏—â–∞–µ–º –≤—Å–µ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è  
            logging.info(f"–ü–†–Ø–ú–ê–Ø –ê–ö–¢–ò–í–ê–¶–ò–Ø ID={reminder['id']}: –ó–∞–ø—É—Å–∫–∞—é –æ—á–∏—Å—Ç–∫—É –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π...")
            cleanup_expired_reminders()
            
    except Exception as e:
        error_message = f"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {e}"
        logging.error(f"–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê ID={reminder['id']}: –ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞. –û—Ç–∫–∞—Ç—ã–≤–∞—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é. –°—Ç–∞—Ç—É—Å –±—É–¥–µ—Ç –≤–æ–∑–≤—Ä–∞—â–µ–Ω –≤ 'active'. –û—à–∏–±–∫–∞: {e}", exc_info=True)
        
        # –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –Ω–µ—É–¥–∞—á–Ω—É—é –ø–æ–ø—ã—Ç–∫—É –∞–∫—Ç–∏–≤–∞—Ü–∏–∏
        track_activation_failure(reminder['id'], error_message)
        
        if conn:
            conn.rollback()
            # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞—Ç—É—Å –æ–±—Ä–∞—Ç–Ω–æ –≤ active –ø—Ä–∏ –æ—à–∏–±–∫–µ
            try:
                with conn.cursor() as cur:
                    cur.execute(
                        "UPDATE reminders SET status = 'active' WHERE id = %s",
                        (reminder['id'],)
                    )
                    conn.commit()
            except:
                pass
    finally:
        if conn:
            conn.close()

def cleanup_expired_reminders():
    """
    –û—á–∏—â–∞–µ—Ç –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è - –ø–µ—Ä–µ–≤–æ–¥–∏—Ç –∏–∑ —Å—Ç–∞—Ç—É—Å–∞ 'active' –≤ 'done'
    –≤—Å–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è, –≤—Ä–µ–º—è –∫–æ—Ç–æ—Ä—ã—Ö —É–∂–µ –ø—Ä–æ—à–ª–æ.
    """
    conn = None
    try:
        conn = get_db_connection()
        
        with conn.cursor() as cur:
            # –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è, –≤—Ä–µ–º—è –∫–æ—Ç–æ—Ä—ã—Ö —É–∂–µ –ø—Ä–æ—à–ª–æ
            cur.execute("""
                UPDATE reminders 
                SET status = 'done', 
                    cancellation_reason = '–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–æ –∫–∞–∫ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω–æ–µ'
                WHERE status = 'active' AND reminder_datetime <= NOW()
                RETURNING id, conv_id, reminder_datetime, reminder_context_summary
            """)
            
            updated_reminders = cur.fetchall()
            conn.commit()
            
            if updated_reminders:
                logging.info(f"–û–ß–ò–°–¢–ö–ê –ü–†–û–°–†–û–ß–ï–ù–ù–´–•: –ü–µ—Ä–µ–≤–µ–¥–µ–Ω–æ –≤ —Å—Ç–∞—Ç—É—Å 'done' {len(updated_reminders)} –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π:")
                for reminder in updated_reminders:
                    logging.info(f"  - ID={reminder[0]}, conv_id={reminder[1]}, –≤—Ä–µ–º—è={reminder[2]}, –æ–ø–∏—Å–∞–Ω–∏–µ='{reminder[3]}'")
            else:
                logging.debug("–û–ß–ò–°–¢–ö–ê –ü–†–û–°–†–û–ß–ï–ù–ù–´–•: –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ")
                
    except Exception as e:
        logging.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π: {e}", exc_info=True)
        if conn:
            conn.rollback()
    finally:
        if conn:
            conn.close()

# –§—É–Ω–∫—Ü–∏—è collect_client_context —É–¥–∞–ª–µ–Ω–∞, —Ç–∞–∫ –∫–∞–∫ –±–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–Ω–∞ –±–µ–∑ –ò–ò-–ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç–∏

# --- –ü–õ–ê–ù–ò–†–û–í–©–ò–ö ---

scheduler = None

def start_scheduler():
    """–ó–∞–ø—É—Å–∫–∞–µ—Ç –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –¥–ª—è –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π."""
    global scheduler
    
    scheduler = BackgroundScheduler(timezone='UTC')
    
    # –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–¥–∞—á—É –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π
    scheduler.add_job(
        func=check_and_activate_reminders,
        trigger="interval",
        minutes=CHECK_INTERVAL_MINUTES,
        id='check_reminders',
        replace_existing=True
    )
    
    scheduler.start()
    logging.info(f"–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–ø—É—â–µ–Ω. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –∫–∞–∂–¥—ã–µ {CHECK_INTERVAL_MINUTES} –º–∏–Ω—É—Ç.")

    # –ù–µ–º–µ–¥–ª–µ–Ω–Ω—ã–π –ø–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫ –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ
    logging.info("–ó–∞–ø—É—Å–∫–∞–µ–º –Ω–µ–º–µ–¥–ª–µ–Ω–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ —Å–µ—Ä–≤–∏—Å–∞...")
    initial_check_thread = threading.Thread(target=check_and_activate_reminders, daemon=True)
    initial_check_thread.start()

def stop_scheduler():
    """–û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫."""
    global scheduler
    if scheduler:
        scheduler.shutdown()
        logging.info("–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.")

# --- –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –í–´–ó–û–í–ê –ò–ó MAIN.PY ---

def process_new_message(conv_id):
    """
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –ø–æ–∏—Å–∫–∞ –¥–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç–µ–π –æ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–∏.
    –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ main.py –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    """
    # === –ó–ê–©–ò–¢–ê –û–¢ –ö–û–ù–ö–£–†–ï–ù–¢–ù–´–• –í–´–ó–û–í–û–í ===
    if conv_id in reminder_creation_locks:
        logging.info(f"–ë–õ–û–ö–ò–†–û–í–ö–ê –ö–û–ù–ö–£–†–ï–ù–¢–ù–û–ì–û –í–´–ó–û–í–ê: –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –¥–ª—è conv_id={conv_id} —É–∂–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è. –ü—Ä–æ–ø—É—Å–∫–∞–µ–º.")
        return
    
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –±–ª–æ–∫–∏—Ä–æ–≤–∫—É
    reminder_creation_locks[conv_id] = True
    
    conn = None
    try:
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–¥–µ–ª–∏
        credentials_path = os.environ.get("GOOGLE_APPLICATION_CREDENTIALS")
        if not credentials_path:
            logging.error("GOOGLE_APPLICATION_CREDENTIALS –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞")
            return
        
        credentials = service_account.Credentials.from_service_account_file(credentials_path.strip(' "'))
        vertexai.init(project=PROJECT_ID, location=LOCATION, credentials=credentials)
        model = GenerativeModel(MODEL_NAME)
        
        conn = get_db_connection()
        
        # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –¥–∏–∞–ª–æ–≥. –¢–µ–ø–µ—Ä—å reminders_data - —ç—Ç–æ —Å–ø–∏—Å–æ–∫.
        reminders_data = analyze_dialogue_for_reminders(conn, conv_id, model)
        
        if reminders_data:
            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∫—Ç–æ —Å–æ–∑–¥–∞–µ—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ
            created_by = conv_id if conv_id == ADMIN_CONV_ID else None
            
            # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∂–¥–æ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –∏–∑ —Å–ø–∏—Å–∫–∞
            for reminder_item in reminders_data:
                try:
                    create_or_update_reminder(conn, conv_id, reminder_item, created_by)
                except Exception as e_item:
                    logging.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –æ–¥–Ω–æ–≥–æ –∏–∑ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –¥–ª—è conv_id={conv_id}: {reminder_item}. –û—à–∏–±–∫–∞: {e_item}")

    except Exception as e:
        logging.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è conv_id={conv_id}: {e}", exc_info=True)
    finally:
        if conn:
            conn.close()
        # –°–Ω–∏–º–∞–µ–º –±–ª–æ–∫–∏—Ä–æ–≤–∫—É
        if conv_id in reminder_creation_locks:
            del reminder_creation_locks[conv_id]
            logging.debug(f"–°–ù–Ø–¢–ò–ï –ë–õ–û–ö–ò–†–û–í–ö–ò: –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –¥–ª—è conv_id={conv_id} –∑–∞–≤–µ—Ä—à–µ–Ω–∞.")

# --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ü–†–ò –ò–ú–ü–û–†–¢–ï ---

def initialize_reminder_service():
    """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Å–µ—Ä–≤–∏—Å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π."""
    setup_logging()
    
    try:
        # –õ–æ–≥–∏—Ä—É–µ–º –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π –ø–æ—Ä—Ç –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
        port = os.environ.get("PORT", 8080)
        logging.info(f"–°–µ—Ä–≤–∏—Å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–æ—Ä—Ç {port} –¥–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏.")
        
        logging.info("–°–µ—Ä–≤–∏—Å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω. –†–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –ò–ò-–ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç–∏.")
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫
        start_scheduler()
        
        return True
        
    except Exception as e:
        logging.critical(f"–ù–µ —É–¥–∞–ª–æ—Å—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–µ—Ä–≤–∏—Å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π: {e}")
        return False

if __name__ == "__main__":
    # –î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    if initialize_reminder_service():
        logging.info("–°–µ—Ä–≤–∏—Å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –∑–∞–ø—É—â–µ–Ω –≤ —Ç–µ—Å—Ç–æ–≤–æ–º —Ä–µ–∂–∏–º–µ.")
        try:
            # –î–µ—Ä–∂–∏–º –ø—Ä–æ—Ü–µ—Å—Å –∞–∫—Ç–∏–≤–Ω—ã–º
            import time
            while True:
                time.sleep(60)
        except KeyboardInterrupt:
            stop_scheduler()
            logging.info("–°–µ—Ä–≤–∏—Å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.")