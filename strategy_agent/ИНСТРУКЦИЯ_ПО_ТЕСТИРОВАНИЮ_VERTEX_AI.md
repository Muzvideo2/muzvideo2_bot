# Инструкция по тестированию учетных данных Vertex AI

## Описание проблемы

В логах стратегического агента наблюдается ошибка:
```
403 Permission 'aiplatform.endpoints.predict' denied on resource
```

Эта ошибка указывает на проблему с разрешениями учетной записи Google Cloud, используемой для доступа к Vertex AI.

## Шаги для диагностики и устранения проблемы

### 1. Запуск теста учетных данных

1. Откройте командную строку в директории `strategy_agent`
2. Запустите скрипт проверки:
   ```
   run_test_vertex_ai.bat
   ```
3. Проверьте логи в файле `test_vertex_ai.log`

### 2. Возможные причины ошибки 403 Permission denied

1. **Неправильные разрешения учетной записи**:
   - Убедитесь, что service account имеет роль `roles/aiplatform.user` или `roles/ml.admin`
   - Проверьте, что учетная запись имеет доступ к проекту, указанному в файле учетных данных

2. **Несоответствие Project ID**:
   - Убедитесь, что Project ID в файле учетных данных совпадает с проектом, в котором у вас есть доступ
   - Проверьте, что проект существует и активен в Google Cloud Console

3. **Истекшие или недействительные учетные данные**:
   - Убедитесь, что файл с учетными данными не поврежден
   - Проверьте срок действия ключа service account

### 3. Проверка файла учетных данных

Файл учетных данных должен содержать следующие поля:
```json
{
  "type": "service_account",
  "project_id": "your-project-id",
  "private_key_id": "...",
  "private_key": "...",
  "client_email": "...@your-project-id.iam.gserviceaccount.com",
  "client_id": "...",
  "auth_uri": "https://accounts.google.com/o/oauth2/auth",
  "token_uri": "https://oauth2.googleapis.com/token",
  "auth_provider_x509_cert_url": "https://www.googleapis.com/oauth2/v1/certs",
  "client_x509_cert_url": "..."
}
```

### 4. Проверка разрешений в Google Cloud Console

1. Перейдите в Google Cloud Console
2. Выберите проект, указанный в поле `project_id` файла учетных данных
3. Перейдите в раздел IAM & Admin > IAM
4. Найдите ваш service account (email из файла учетных данных)
5. Убедитесь, что у него есть одна из следующих ролей:
   - `AI Platform User` (рекомендуется)
   - `ML API User`
   - `Editor` (широкие права, не рекомендуется для production)
   - `Owner` (максимальные права, не рекомендуется)

### 5. Повторное создание ключа учетных данных

Если текущий ключ не работает:

1. Перейдите в Google Cloud Console
2. Выберите проект, указанный в поле `project_id` файла учетных данных
3. Перейдите в раздел IAM & Admin > Service Accounts
4. Найдите ваш service account
5. Нажмите на него и перейдите во вкладку Keys
6. Создайте новый ключ (JSON)
7. Скачайте файл и замените им существующий файл учетных данных
8. Обновите путь в файле `.env` и в скриптах, если необходимо

## Дополнительная информация

Если проблема сохраняется после выполнения всех шагов, обратитесь в техническую поддержку Google Cloud или проверьте документацию по настройке доступа к Vertex AI.